SAP is the ERP provider of choice for many companies, all of which entrust their most confidential data to the SAP systems. Systems covered by SAP include:

* Enterprise Resource Planning (ERP) - supports the basic internal business processes of a company
* Customer Relationship Management (CRM) – helps companies acquire and retain customers, gain marketing and customer insight
* Product Lifecycle Management (PLM) – helps manufacturers with product-related information
* Supply Chain Management (SCM) – helps companies with the process of resourcing its manufacturing and service processes
* Supplier Relationship Management (SRM) – enables companies to procure from suppliers


 There are two ways an external user can communicate with the SAP platform:

1. The SAP GUI
2. A browser through the ICM


Remote Function Calls (RFC), SAP GUI, and the DIAG Protocol
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Remote Function Calls (RFC) is the traditional mechanism provided by SAP to call or invoke ABAP code (programs or function
modules) or even other types of code, and to launch other programs within an SAP platform.
A list of available RFC connections on an SAP system can be obtained using the transaction SM59.

The SAP GUI will communicate with the SAP platform using the SAP GUI RFC via a network protocol named DIAG (from dialog)
in order to run ABAP applications through the named transactions


The SAP Internet Communication Manager (ICM)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
There is an easier way to communicate with an SAP system than the obscure DIAG/SAP GUI method. The SAP Internet
Communication Manager (ICM), according to the SAP documentation, is used to provide communication with the outside world
using Internet protocols such as HTTP, HTTPS, and SMTP, allowing communication with the application server (running both
Java and ABAP programs) without the need for SAP GUI and DIAG:

Indeed, it is the ICM component that provides these Internet services, which can be monitored with the SMICM transaction:


Exploring SAP
-------------


Enumerate SAP Systems
^^^^^^^^^^^^^^^^^^^^^

discover and/or enumerate SAP components within a network.

::

 msf auxiliary(scanner/sap/sap_service_discovery) > set rhosts 172.20.1.20
 rhosts => 172.20.1.20
 msf auxiliary(scanner/sap/sap_service_discovery) > run
 
 [*] 172.20.1.20:          - [SAP] Beginning service Discovery '172.20.1.20'
 
 [+] 172.20.1.20:          - 172.20.1.20:3200	 - SAP Dispatcher sapdp00 OPEN
 [+] 172.20.1.20:          - 172.20.1.20:3201	 - SAP Dispatcher sapdp01 OPEN
 [+] 172.20.1.20:          - 172.20.1.20:3300	 - SAP Gateway sapgw00 OPEN
 [+] 172.20.1.20:          - 172.20.1.20:8000	 - SAP ICM HTTP OPEN
 [+] 172.20.1.25:          - 172.20.1.25:3600	 - SAP Message Server sapms<SID>00 OPEN
 [+] 172.20.1.25:          - 172.20.1.25:8001	 - SAP ICM HTTP OPEN
 [*] Scanned 1 of 1 hosts (100% complete)
 [*] Auxiliary module execution completed


Let's explore 

The SAP Internet Communication Framework (ICF)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

::

 use  scanner/sap/sap_icf_public_info

 [SAP] ICF SAP PUBLIC INFO
 =========================

   Key                                   Value
   ---                                   -----
   Central Database System:              ORACLE
   Character Set:                        4102
   Database Host:                        SAPDEV
   Float Type Format:                    IEEE
   Hostname:                             SAPDEV
   IPv4 Address:                         172.20.1.19
   IPv6 Address:                         172.20.1.19
   Integer Format:                       Big Endian
   Kernel Release:                       745
   Machine ID:                           274
   Operating System:                     HP-UX
   RFC Destination:                      SAPDEV_DEV_00
   RFC Log Version:                      011
   Release Status of SAP System:         740
   System ID:                            DEV
   Timezone (diff from UTC in seconds):   19800


 [SAP] ICF SAP PUBLIC INFO
 =========================

   Key                                   Value
   ---                                   -----
   Central Database System:              ORACLE
   Character Set:                        4102
   Database Host:                        SAPQAS
   Float Type Format:                    IEEE
   Hostname:                             SAPQAS
   IPv4 Address:                         172.20.1.20
   IPv6 Address:                         172.20.1.20
   Integer Format:                       Big Endian
   Kernel Release:                       745
   Machine ID:                           274
   Operating System:                     HP-UX
   RFC Destination:                      SAPQAS_QAS_00
   RFC Log Version:                      011
   Release Status of SAP System:         740
   System ID:                            QAS
   Timezone (diff from UTC in seconds):   19800

 [SAP] ICF SAP PUBLIC INFO
 =========================

   Key                                   Value
   ---                                   -----
   Central Database System:              ORACLE
   Character Set:                        4102
   Database Host:                        PRDDB
   Float Type Format:                    IEEE
   Hostname:                             sapprdc
   IPv4 Address:                         172.20.1.25
   IPv6 Address:                         172.20.1.25
   Integer Format:                       Big Endian
   Kernel Release:                       745
   Machine ID:                           274
   Operating System:                     HP-UX
   RFC Destination:                      sapprdc_PRD_01
   RFC Log Version:                      011
   Release Status of SAP System:         740
   System ID:                            PRD
   Timezone (diff from UTC in seconds):   19800

 [SAP] ICF SAP PUBLIC INFO
 =========================

   Key                                   Value
   ---                                   -----
   Central Database System:              MSSQL
   Character Set:                        4103
   Database Host:                        XXXNWPRD2\MI2
   Float Type Format:                    IEEE
   Hostname:                             xxxnwprd
   IPv4 Address:                         172.20.1.54
   IPv6 Address:                         172.20.1.54
   Integer Format:                       Little Endian
   Kernel Release:                       710
   Machine ID:                           562
   Operating System:                     Windows NT
   RFC Destination:                      xxxnwprd2_MI2_02
   RFC Log Version:                      011
   Release Status of SAP System:         710
   System ID:                            MI2
   Timezone (diff from UTC in seconds):   19800

 [*] Scanned 4 of 4 hosts (100% complete)
 [*] Auxiliary module execution completed



Under the hood, it’s just SOAP over HTTP, which is the common mechanism when communicating with services provided by the ICF:

::

 http://172.20.1.54:8001/sap/public/info 

 This XML file does not appear to have any style information associated with it. The document tree is shown below.
 <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
 <SOAP-ENV:Body>
 <rfc:RFC_SYSTEM_INFO.Response xmlns:rfc="urn:sap-com:document:sap:rfc:functions">
 <RFCSI>
 <RFCPROTO>011</RFCPROTO>
 <RFCCHARTYP>4103</RFCCHARTYP>
 <RFCINTTYP>LIT</RFCINTTYP>
 <RFCFLOTYP>IE3</RFCFLOTYP>
 <RFCDEST>pclnwprd2_MI2_02</RFCDEST>
 <RFCHOST>pclnwprd</RFCHOST>
 <RFCSYSID>MI2</RFCSYSID>
 <RFCDATABS>MI2</RFCDATABS>
 <RFCDBHOST>PCLNWPRD2\MI2</RFCDBHOST>
 <RFCDBSYS>MSSQL</RFCDBSYS>
 <RFCSAPRL>710</RFCSAPRL>
 <RFCMACH>562</RFCMACH>
 <RFCOPSYS>Windows NT</RFCOPSYS>
 <RFCTZONE>19800</RFCTZONE>
 <RFCDAYST/>
 <RFCIPADDR>172.20.1.54</RFCIPADDR>
 <RFCKERNRL>710</RFCKERNRL>
 <RFCHOST2>pclnwprd2</RFCHOST2>
 <RFCSI_RESV/>
 <RFCIPV6ADDR>172.20.1.54</RFCIPV6ADDR>
 </RFCSI>
 </rfc:RFC_SYSTEM_INFO.Response>
 </SOAP-ENV:Body>
 </SOAP-ENV:Envelope>


Discovering ICF Services with Metasploit
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

To get a full list of available services, the SICF transaction can be used:


